<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Activity Log - PPAP</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .log-table { width:100%; min-width:700px; border-collapse: collapse; }
        .log-table th { background:linear-gradient(to bottom, #003366, #004c8c) !important; color:white; padding:12px; border:1px solid #ddd; }
        .log-table td { padding:10px; border:1px solid #ddd; font-size:13px; }
        .log-table tr:nth-child(even) { background: #f2f2f2; }
        .badge { padding:3px 8px; border-radius:4px; font-size:11px; font-weight:bold; color:white; }
        .bg-login { background: linear-gradient(135deg, #00b09b, #96c93d); }
        .bg-reg { background: linear-gradient(135deg, #0056a9, #0099cc); }
        .bg-upd { background: linear-gradient(135deg, #ff9900, #ffcc00); }
        .bg-del { background: linear-gradient(135deg, #ff416c, #ff4b2b); }
        .bg-img { background: linear-gradient(135deg, #6a11cb, #2575fc); }
        .bg-usr { background: linear-gradient(135deg, #667eea, #764ba2); }
    </style>
</head>
<body class="bg-blue">
    <!-- CORPORATE HEADER -->
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            <div>
                <h1>PPAP Master Track System</h1>
                <div class="subtitle">SMP Engine Management, S. de R.L. de C.V</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">ðŸ‘¤ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>

    <header><h1>System Activity Log</h1></header>

    <div class="main-container" style="flex-direction: column; align-items: center; padding: 20px;">
        <button onclick="location.href='index.html'" style="margin-bottom:20px; padding:10px 20px; cursor:pointer; border-radius:8px; border:none; background:#3498db; color:white; font-weight:bold;">
            BACK TO HOME
        </button>

        <div style="background:white; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); width:100%; max-width:950px; overflow-x:auto;">
            <table class="log-table">
                <thead>
                    <tr>
                        <th>DATE AND TIME</th>
                        <th>USER</th>
                        <th>ACTION</th>
                        <th>DETAIL / ITEM</th>
                    </tr>
                </thead>
                <tbody id="lista-movimientos" style="text-align:center;">
                    <tr><td colspan="4">Loading activities...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- CORPORATE FOOTER -->
    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">Â© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Show current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        
        // Show current user
        const user = checkAuth();
        if(user) {
            document.getElementById('current-user-display').textContent = `ðŸ‘¤ ${user.usuario}`;
        }

        // Only admin can see this
        if(!user || user.usuario !== 'admin') {
            alert("Access denied");
            window.location.href = "index.html";
        }

        const tbody = document.getElementById('lista-movimientos');
        const q = query(collection(db, "movimientos"), orderBy("fecha", "desc"));

        onSnapshot(q, (snap) => {
            tbody.innerHTML = '';
            if(snap.empty) {
                tbody.innerHTML = '<tr><td colspan="4">No records yet.</td></tr>';
                return;
            }

            snap.forEach(doc => {
                const m = doc.data();
                const f = m.fecha ? new Date(m.fecha.seconds * 1000).toLocaleString() : '---';
                
                // Assign color based on action
                let badgeClass = 'bg-usr';
                const act = (m.accion || '').toLowerCase();
                if(act.includes('login') || act.includes('inicio')) badgeClass = 'bg-login';
                else if(act.includes('register') || act.includes('registro') || act.includes('new')) badgeClass = 'bg-reg';
                else if(act.includes('update') || act.includes('actualiz')) badgeClass = 'bg-upd';
                else if(act.includes('delete') || act.includes('elimin')) badgeClass = 'bg-del';
                else if(act.includes('image') || act.includes('foto')) badgeClass = 'bg-img';

                tbody.innerHTML += `
                    <tr>
                        <td>${f}</td>
                        <td><b>${m.usuario}</b></td>
                        <td><span class="badge ${badgeClass}">${m.accion}</span></td>
                        <td style="color:#555;">${m.detalle || '-'}</td>
                    </tr>
                `;
            });
        });
    </script>
</body>
</html>