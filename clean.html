<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JSON Cleaner - PPAP Master Track</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .cleaner-container {
            max-width: 1000px;
            margin: 20px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,51,102,0.1);
        }
        
        .step-box {
            background: #f8f9fa;
            border-left: 4px solid #0099cc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .step-box h3 {
            margin-top: 0;
            color: #003366;
        }
        
        .json-preview {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .btn-download {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        .btn-download:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
        }
        
        .error-box {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .success-box {
            background: #e8f8f5;
            border: 2px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-blue">
    <!-- CORPORATE HEADER -->
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            <div>
                <h1>PPAP Master Track System</h1>
                <div class="subtitle">SMP Engine Management, S. de R.L. de C.V</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">üë§ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>

    <header><h1>üßπ JSON Cleaner & Validator</h1></header>

    <div class="cleaner-container">
        <div class="step-box">
            <h3>üìã Step 1: Upload Your JSON File</h3>
            <p>Upload the JSON file that's giving you errors. This tool will clean and validate it.</p>
            <input type="file" id="fileInput" accept=".json" style="padding: 10px;">
        </div>

        <div id="errorSection" style="display: none;">
            <div class="error-box">
                <h4>‚ùå Errors Found:</h4>
                <div id="errorList"></div>
            </div>
        </div>

        <div id="statsSection" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Total Records</h4>
                    <div class="value" id="totalRecords">0</div>
                </div>
                <div class="stat-card">
                    <h4>Valid Records</h4>
                    <div class="value" id="validRecords">0</div>
                </div>
                <div class="stat-card">
                    <h4>Issues Fixed</h4>
                    <div class="value" id="issuesFixed">0</div>
                </div>
            </div>
        </div>

        <div id="successSection" style="display: none;">
            <div class="success-box">
                <h4>‚úÖ File Successfully Cleaned!</h4>
                <p id="successMessage"></p>
            </div>
        </div>

        <div class="step-box" id="previewSection" style="display: none;">
            <h3>üëÄ Preview (First 3 Records)</h3>
            <div class="json-preview" id="jsonPreview"></div>
        </div>

        <div id="actionButtons" style="display: none; margin-top: 20px;">
            <button class="btn-download" id="btnDownload">
                üíæ Download Clean JSON
            </button>
            <button class="btn-download" onclick="location.href='import-data.html'" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                ‚û°Ô∏è Go to Import Page
            </button>
        </div>

        <button onclick="location.href='index.html'" style="width:100%; margin-top:20px; padding:12px; background:#95a5a6; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
            BACK TO HOME
        </button>
    </div>

    <!-- CORPORATE FOOTER -->
    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">¬© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { checkAuth } from './config.js';

        // Show current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        
        // Check authentication
        const user = checkAuth();
        if(user) {
            document.getElementById('current-user-display').textContent = `üë§ ${user.usuario}`;
        }

        // Only admin can access
        if(!user || user.usuario !== 'admin') {
            alert("‚ùå Access denied. Only administrator can use this tool.");
            window.location.href = "index.html";
        }

        let cleanedData = null;
        let issuesFound = 0;

        document.getElementById('fileInput').onchange = async (e) => {
            if (e.target.files.length === 0) return;

            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = async (event) => {
                try {
                    let content = event.target.result;
                    issuesFound = 0;
                    
                    console.log("Original file size:", content.length);
                    
                    // CLEANING PROCESS
                    
                    // 1. Remove BOM (Byte Order Mark) if present
                    if (content.charCodeAt(0) === 0xFEFF) {
                        content = content.substr(1);
                        issuesFound++;
                        console.log("‚úì Removed BOM");
                    }
                    
                    // 2. Replace invalid escape sequences
                    content = content.replace(/\\/g, (match, offset, string) => {
                        const nextChar = string[offset + 1];
                        // Valid escape sequences in JSON
                        if (['"', '\\', '/', 'b', 'f', 'n', 'r', 't', 'u'].includes(nextChar)) {
                            return match;
                        }
                        issuesFound++;
                        return '\\\\'; // Escape the backslash
                    });
                    
                    // 3. Remove control characters (except valid whitespace)
                    const originalLength = content.length;
                    content = content.replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F]/g, '');
                    if (content.length !== originalLength) {
                        issuesFound += (originalLength - content.length);
                        console.log("‚úì Removed control characters");
                    }
                    
                    // 4. Fix common encoding issues
                    content = content
                        .replace(/√¢‚Ç¨‚Ñ¢/g, "'")  // Smart apostrophe
                        .replace(/√¢‚Ç¨≈ì/g, '"')  // Smart quote open
                        .replace(/√¢‚Ç¨/g, '"')   // Smart quote close
                        .replace(/√¢‚Ç¨"/g, '-')  // Em dash
                        .replace(/√É¬©/g, '√©')   // √©
                        .replace(/√É¬±/g, '√±')   // √±
                        .replace(/√É¬°/g, '√°')   // √°
                        .replace(/√É¬≥/g, '√≥')   // √≥
                        .replace(/√É¬∫/g, '√∫')   // √∫
                        .replace(/√É/g, '√≠');   // √≠
                    
                    // 5. Normalize line endings
                    content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                    
                    // 6. Remove trailing commas before closing brackets
                    content = content.replace(/,(\s*[}\]])/g, '$1');
                    issuesFound += (content.match(/,(\s*[}\]])/g) || []).length;
                    
                    console.log("Cleaned file size:", content.length);
                    
                    // Try to parse
                    let jsonData;
                    try {
                        jsonData = JSON.parse(content);
                    } catch (parseError) {
                        showError(`Parse error at position ${parseError.message}`);
                        
                        // Try to fix common JSON structure issues
                        console.log("Attempting advanced repair...");
                        
                        // Remove any text before first [ or {
                        const firstBracket = Math.min(
                            content.indexOf('[') === -1 ? Infinity : content.indexOf('['),
                            content.indexOf('{') === -1 ? Infinity : content.indexOf('{')
                        );
                        if (firstBracket > 0 && firstBracket !== Infinity) {
                            content = content.substring(firstBracket);
                            issuesFound++;
                        }
                        
                        // Remove any text after last ] or }
                        const lastBracket = Math.max(
                            content.lastIndexOf(']'),
                            content.lastIndexOf('}')
                        );
                        if (lastBracket < content.length - 1 && lastBracket !== -1) {
                            content = content.substring(0, lastBracket + 1);
                            issuesFound++;
                        }
                        
                        try {
                            jsonData = JSON.parse(content);
                        } catch (secondError) {
                            showError(`Unable to repair JSON: ${secondError.message}`);
                            return;
                        }
                    }
                    
                    // Validate structure
                    if (!Array.isArray(jsonData)) {
                        showError("JSON must be an array of objects");
                        return;
                    }
                    
                    // Clean each record
                    cleanedData = jsonData.map(record => {
                        const cleaned = {};
                        for (const [key, value] of Object.entries(record)) {
                            // Convert all values to strings and trim
                            if (value !== null && value !== undefined) {
                                let cleanValue = String(value).trim();
                                // Remove any remaining control characters from values
                                cleanValue = cleanValue.replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F]/g, '');
                                cleaned[key] = cleanValue;
                            } else {
                                cleaned[key] = "";
                            }
                        }
                        return cleaned;
                    });
                    
                    // Show results
                    showSuccess(cleanedData);
                    
                } catch (error) {
                    showError(`Unexpected error: ${error.message}`);
                }
            };

            reader.readAsText(file, 'UTF-8');
        };

        function showError(message) {
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorList').innerHTML = `<p style="color: #c0392b; font-weight: bold;">${message}</p>`;
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('successSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
        }

        function showSuccess(data) {
            // Hide errors
            document.getElementById('errorSection').style.display = 'none';
            
            // Show stats
            document.getElementById('statsSection').style.display = 'block';
            document.getElementById('totalRecords').textContent = data.length;
            document.getElementById('validRecords').textContent = data.filter(r => r["Item #"]).length;
            document.getElementById('issuesFixed').textContent = issuesFound;
            
            // Show success message
            document.getElementById('successSection').style.display = 'block';
            document.getElementById('successMessage').innerHTML = `
                <strong>Your file has been cleaned and validated!</strong><br>
                ‚Ä¢ ${data.length} records processed<br>
                ‚Ä¢ ${issuesFound} issues automatically fixed<br>
                ‚Ä¢ File is now ready for import
            `;
            
            // Show preview
            document.getElementById('previewSection').style.display = 'block';
            const preview = data.slice(0, 3);
            document.getElementById('jsonPreview').textContent = JSON.stringify(preview, null, 2);
            
            // Show action buttons
            document.getElementById('actionButtons').style.display = 'block';
        }

        // Download clean JSON
        document.getElementById('btnDownload').onclick = () => {
            if (!cleanedData) {
                alert("No data to download");
                return;
            }

            const jsonString = JSON.stringify(cleanedData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cleaned_ppap_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert("‚úÖ File downloaded! Now you can upload it in the Import Data page.");
        };
    </script>
</body>
</html>