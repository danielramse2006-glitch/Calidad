<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"><title>Login - PPAP Master Track</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: linear-gradient(135deg, #003366 0%, #0056a9 100%) !important;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }
        
        .login-logo {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }
        
        .login-logo img {
            height: 60px;
            width: auto;
            display: block;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            width: 100%;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            border-top: 5px solid #0099cc;
        }
        
        .login-box h2 {
            color: #003366;
            margin-bottom: 25px;
            font-size: 22px;
        }
        
        .login-box input {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 2px solid #e1ecff;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .login-box input:focus {
            outline: none;
            border-color: #0099cc;
        }
        
        .login-box button {
            width: 100%;
            background: linear-gradient(to right, #003366, #0056a9);
            color: white;
            font-weight: bold;
            border: none;
            padding: 14px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .login-box button:hover {
            background: linear-gradient(to right, #004c8c, #0066cc);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 51, 102, 0.3);
        }
        
        .company-name {
            color: white;
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-logo">
            <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
        </div>
        
        <div class="login-box">
            <h2>INICIAR SESIÓN</h2>
            <input type="text" id="user" placeholder="Usuario">
            <input type="password" id="pass" placeholder="Contraseña">
            <button id="btnLogin">ENTRAR AL SISTEMA</button>
        </div>
        
        <div class="company-name">
            SMP Engine Management, S. de R.L. de C.V<br>
            <span style="font-size: 12px;">PPAP Master Track System</span>
        </div>
    </div>

    <script type="module">
        import { db } from './config.js';
        import { collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        sessionStorage.clear();

        document.getElementById('btnLogin').onclick = async () => {
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value.trim();

            if (!u || !p) return alert("Ingresa datos");

            // Función interna para registrar log de login
            const logLogin = async (usuario) => {
                try {
                    await addDoc(collection(db, "movimientos"), {
                        usuario: usuario,
                        accion: "Inicio de Sesión",
                        detalle: "Acceso Exitoso",
                        fecha: serverTimestamp()
                    });
                } catch(e) { console.error("Error log login", e); }
            };

            if (u === "admin" && p === "#Reyn0sa#") {
                sessionStorage.setItem("currentUser", JSON.stringify({ 
                    usuario: 'admin',
                    permisos: {
                        registrar: true,
                        actualizar: true,
                        eliminar: true,
                        subirDrive: true,
                        consultar: true,
                        editarComentarios: true
                    }
                }));
                await logLogin('admin');
                window.location.href = "index.html";
                return;
            }

            try {
                const q = query(collection(db, "usuarios"), where("usuario", "==", u), where("password", "==", p));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    const userData = snap.docs[0].data();
                    sessionStorage.setItem("currentUser", JSON.stringify(userData));
                    await logLogin(userData.usuario);
                    window.location.href = "index.html";
                } else {
                    alert("Usuario o contraseña incorrectos");
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexión");
            }
        };
        
        // Permitir login con Enter
        document.getElementById('pass').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('btnLogin').click();
            }
        });
        
        // Enfocar en el campo de usuario al cargar
        window.addEventListener('load', function() {
            document.getElementById('user').focus();
        });
    </script>
</body>
</html>