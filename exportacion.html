<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Procesar Comentarios por Item #</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #2c3e50;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 2px solid #e74c3c;
        }
        
        h1 {
            color: #e74c3c;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #cccccc;
            font-size: 16px;
        }
        
        .instructions {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 5px;
        }
        
        .instructions h3 {
            color: #e74c3c;
            margin-bottom: 10px;
        }
        
        .search-section {
            margin-bottom: 20px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.5);
            border-radius: 5px;
            color: white;
            font-size: 16px;
        }
        
        input:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.3);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #e74c3c;
            color: white;
        }
        
        .btn-primary:hover {
            background: #c0392b;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .temp-storage {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border: 1px dashed rgba(231, 76, 60, 0.5);
        }
        
        .temp-item {
            background: rgba(231, 76, 60, 0.1);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 3px solid #e74c3c;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .results-section {
            margin-top: 30px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .comment-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(231, 76, 60, 0.2);
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .comment-id {
            background: #e74c3c;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .comment-content {
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.8;
        }
        
        .status-message {
            padding: 12px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: 500;
            display: none;
        }
        
        .status-success {
            background: rgba(46, 204, 113, 0.2);
            border-left: 4px solid #2ecc71;
            color: #2ecc71;
            display: block;
        }
        
        .status-error {
            background: rgba(231, 76, 60, 0.2);
            border-left: 4px solid #e74c3c;
            color: #e74c3c;
            display: block;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
        }
        
        .formatted-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(39, 174, 96, 0.1);
            border: 2px solid #27ae60;
            border-radius: 5px;
            display: none;
        }
        
        .formatted-text {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .search-box {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Procesar Comentarios por Item #</h1>
            <div class="subtitle">Buscar, almacenar temporalmente y procesar comentarios por Item #</div>
        </header>
        
        <div class="instructions">
            <h3>Instrucciones:</h3>
            <p>1. Ingresa Item # para buscar comentarios</p>
            <p>2. Los comentarios se almacenan temporalmente</p>
            <p>3. Se borran los originales y se reinyectan con saltos de línea</p>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
        
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchItem" placeholder="Ej: 3, 5, 15 o 3-10 para rango">
                <button class="btn btn-primary" id="searchBtn">Buscar</button>
            </div>
        </div>
        
        <div class="temp-storage">
            <h4>Almacenamiento Temporal</h4>
            <div id="tempStorageList">
                <div class="empty-state">
                    No hay comentarios almacenados temporalmente
                </div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" id="processBtn" disabled>Procesar Comentarios</button>
        </div>
        
        <div class="results-section" id="resultsSection" style="display: none;">
            <h3>Comentarios Encontrados</h3>
            <div id="resultsContainer"></div>
        </div>
        
        <div class="formatted-section" id="formattedSection">
            <h3>Comentarios Formateados</h3>
            <div id="formattedComments" class="formatted-text"></div>
        </div>
    </div>

    <script>
        // Datos de ejemplo (simulando base de datos)
        const mockDatabase = [
            { 
                "Item #": "3", 
                "Comments(detalle)": "3.Arias.- 9/19-el mismo: FG que el 88514385:3.Arias.- 9/19-el mismo: FG que el 88514385:",
                "Special instruccions": "Revisar documentación completa",
                "Responsible": "Arias",
                "Validation date": "9/19",
                "PPAP Part Number": "P-001"
            },
            { 
                "Item #": "5", 
                "Comments(detalle)": "5.González.- 8/15-expediente 552211: Se requiere revisión:5.González.- 8/15-expediente 552211: Se requiere revisión:",
                "Special instruccions": "Verificar muestras",
                "Responsible": "González",
                "Validation date": "8/15",
                "PPAP Part Number": "P-002"
            },
            { 
                "Item #": "8", 
                "Comments(detalle)": "8.López.- 9/20-folio 3344: Documento aprobado:8.López.- 9/20-folio 3344: Documento aprobado:",
                "Special instruccions": "Esperar firma",
                "Responsible": "López",
                "Validation date": "9/20",
                "PPAP Part Number": "P-003"
            }
        ];
        
        let temporaryStorage = [];
        
        function showStatus(message, type = "info") {
            const statusEl = document.getElementById("statusMessage");
            statusEl.textContent = message;
            
            if (type === "success") {
                statusEl.className = "status-message status-success";
            } else if (type === "error") {
                statusEl.className = "status-message status-error";
            }
        }
        
        // Función para buscar comentarios por Item #
        function searchCommentsByItem(itemInput) {
            if (!itemInput.trim()) {
                showStatus("Por favor, ingresa al menos un Item #", "error");
                return [];
            }
            
            let itemsToSearch = [];
            
            // Procesar entrada
            if (itemInput.includes("-")) {
                const [start, end] = itemInput.split("-").map(num => parseInt(num.trim()));
                if (!isNaN(start) && !isNaN(end) && start <= end) {
                    for (let i = start; i <= end; i++) {
                        itemsToSearch.push(i.toString());
                    }
                }
            } else {
                itemsToSearch = itemInput.split(",")
                    .map(item => item.trim())
                    .filter(item => item !== "");
            }
            
            if (itemsToSearch.length === 0) {
                showStatus("No se encontraron Items # válidos", "error");
                return [];
            }
            
            // Buscar en la base de datos
            const results = mockDatabase.filter(product => 
                itemsToSearch.includes(product["Item #"])
            );
            
            if (results.length === 0) {
                showStatus(`No se encontraron registros con los Items: ${itemsToSearch.join(", ")}`, "error");
                return [];
            }
            
            // Almacenar en memoria temporal
            temporaryStorage = [...results];
            
            // Actualizar UI
            updateTemporaryStorageUI();
            updateResultsUI(results);
            updateActionButtons();
            
            showStatus(`Encontrados ${results.length} registro(s) con los Items especificados`, "success");
            
            return results;
        }
        
        // Función para procesar comentarios (formatear con saltos de línea)
        function processComments() {
            if (temporaryStorage.length === 0) {
                showStatus("No hay comentarios para procesar", "error");
                return;
            }
            
            if (!confirm(`¿Estás seguro de procesar ${temporaryStorage.length} comentario(s)?`)) {
                return;
            }
            
            // 1. Formatear los comentarios con saltos de línea
            const formattedResults = temporaryStorage.map(product => {
                const originalComment = product["Comments(detalle)"] || "";
                
                // Dividir el comentario por el patrón: número.punto-autor
                // Expresión regular para encontrar patrones como "3.Arias.-"
                const pattern = /(\d+\.[A-Za-záéíóúÁÉÍÓÚñÑ]+\.[-]\s\d+\/\d+-[^:]+:)/g;
                
                let formattedComment = originalComment;
                
                // Si encontramos el patrón, insertamos saltos de línea
                if (pattern.test(originalComment)) {
                    // Restablecer la regex
                    const regex = /(\d+\.[A-Za-záéíóúÁÉÍÓÚñÑ]+\.[-]\s\d+\/\d+-[^:]+:)/g;
                    
                    // Reemplazar cada ocurrencia con: \n + el patrón (excepto el primero)
                    formattedComment = originalComment.replace(regex, (match, p1, offset) => {
                        return offset === 0 ? match : "\n" + match;
                    });
                }
                
                return {
                    ...product,
                    formattedComment: formattedComment
                };
            });
            
            // 2. Mostrar resultados formateados
            showFormattedResults(formattedResults);
            
            // 3. Mostrar mensaje de éxito
            showStatus(`${temporaryStorage.length} comentario(s) formateados con saltos de línea`, "success");
            
            // 4. Opcional: Aquí se borrarían los originales y se reinyectarían los formateados
            // En una implementación real, aquí iría la llamada a la API
            
            // 5. Limpiar almacenamiento temporal
            setTimeout(() => {
                temporaryStorage = [];
                updateTemporaryStorageUI();
                updateActionButtons();
            }, 2000);
        }
        
        function updateTemporaryStorageUI() {
            const tempListEl = document.getElementById("tempStorageList");
            
            if (temporaryStorage.length === 0) {
                tempListEl.innerHTML = `
                    <div class="empty-state">
                        No hay comentarios almacenados temporalmente
                    </div>
                `;
                return;
            }
            
            let html = "";
            temporaryStorage.forEach((product, index) => {
                const comment = product["Comments(detalle)"] || "Sin comentarios";
                html += `
                    <div class="temp-item">
                        <strong>Item ${product["Item #"]}:</strong><br>
                        ${comment.substring(0, 100)}${comment.length > 100 ? '...' : ''}
                    </div>
                `;
            });
            
            tempListEl.innerHTML = html;
        }
        
        function updateResultsUI(products) {
            const resultsContainer = document.getElementById("resultsContainer");
            const resultsSection = document.getElementById("resultsSection");
            
            if (products.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        No hay resultados para mostrar
                    </div>
                `;
                resultsSection.style.display = 'none';
                return;
            }
            
            let html = "";
            products.forEach(product => {
                const comment = product["Comments(detalle)"] || "Sin comentarios";
                html += `
                    <div class="comment-card">
                        <div class="comment-header">
                            <div><strong>Item:</strong> ${product["Item #"]}</div>
                            <div class="comment-id">ID: ${product["Item #"]}</div>
                        </div>
                        <div class="comment-content">${comment}</div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
            resultsSection.style.display = 'block';
        }
        
        function showFormattedResults(formattedProducts) {
            const formattedSection = document.getElementById("formattedSection");
            const formattedComments = document.getElementById("formattedComments");
            
            let html = "";
            formattedProducts.forEach(product => {
                html += `Item: ${product["Item #"]}\n`;
                html += "─".repeat(50) + "\n";
                html += `${product.formattedComment}\n\n`;
            });
            
            formattedComments.textContent = html;
            formattedSection.style.display = 'block';
            
            // Scroll a la sección formateada
            formattedSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function updateActionButtons() {
            const processBtn = document.getElementById("processBtn");
            
            if (temporaryStorage.length > 0) {
                processBtn.disabled = false;
            } else {
                processBtn.disabled = true;
            }
        }
        
        // Event Listeners
        document.getElementById('searchBtn').addEventListener('click', function() {
            const itemInput = document.getElementById('searchItem').value;
            searchCommentsByItem(itemInput);
        });
        
        document.getElementById('processBtn').addEventListener('click', processComments);
        
        // Enter para buscar
        document.getElementById('searchItem').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });
        
        // Cargar ejemplo inicial
        window.addEventListener('load', function() {
            document.getElementById('searchItem').value = "3, 5";
        });
    </script>
</body>
</html>