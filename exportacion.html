<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mass Export - PPAP System</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .export-container {
            max-width: 1000px;
            margin: 20px auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .options-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .filter-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 8px;
        }
        
        .results-section {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        
        .record-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .record-item:hover {
            background: #f9f9f9;
        }
        
        .btn-export {
            padding: 12px 25px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin-right: 10px;
        }
        
        .btn-update {
            padding: 12px 25px;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }
        
        .btn-csv {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        .count-badge {
            background: #2c3e50;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .conditions-list {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 12px;
            margin: 15px 0;
            font-size: 12px;
        }
        
        .condition-item {
            margin: 5px 0;
            padding-left: 15px;
            position: relative;
        }
        
        .condition-item:before {
            content: "‚Ä¢";
            position: absolute;
            left: 5px;
            color: #f39c12;
        }
        
        .skip-indicator {
            font-size: 10px;
            background: #7f8c8d;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
        }
        
        .comments-preview {
            max-width: 250px;
            overflow: hidden;
            font-size: 11px;
            color: #666;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            margin-top: 5px;
            border: 1px solid #eee;
        }
        
        .comments-preview.multiline {
            white-space: pre-line;
            max-height: 60px;
            overflow: hidden;
        }
        
        .record-details {
            display: flex;
            gap: 10px;
            font-size: 11px;
            margin-top: 5px;
        }
        
        .detail-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .badge-raw {
            background: #3498db;
            color: white;
        }
        
        .badge-process {
            background: #27ae60;
            color: white;
        }
        
        .badge-overall {
            background: #8e44ad;
            color: white;
        }
        
        .badge-revision {
            background: #f39c12;
            color: white;
        }
        
        .badge-comments {
            background: #e74c3c;
            color: white;
        }
        
        .comments-example {
            background: #f8f9fa;
            border: 1px dashed #3498db;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 11px;
            font-family: monospace;
            white-space: pre-line;
            line-height: 1.4;
        }
    </style>
</head>
<body class="bg-blue">
    <!-- CORPORATE HEADER -->
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            <div>
                <h1>PPAP Master Track System</h1>
                <div class="subtitle" style="color: white;">Mass Export & Update</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">üë§ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>

    <header><h1>üì¶ Mass Export & Update Tool</h1></header>
    
    <div class="export-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: #2c3e50; margin: 0;">Bulk Operations</h2>
            <button onclick="location.href='index.html'" style="padding: 10px 15px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ‚Üê BACK TO HOME
            </button>
        </div>
        
        <div class="filter-section">
            <h3 style="color: #2c3e50; margin-bottom: 15px;">Filter Records</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div>
                    <label style="display: block; font-size: 12px; margin-bottom: 5px; color: #666;">Status:</label>
                    <select id="filter-status" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
                        <option value="Approved">Approved</option>
                        <option value="All">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="In Process">In Process</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; font-size: 12px; margin-bottom: 5px; color: #666;">Has Comments:</label>
                    <select id="filter-comments" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
                        <option value="All">All Records</option>
                        <option value="WithComments">With Comments</option>
                        <option value="WithoutComments">Without Comments</option>
                    </select>
                </div>
                
                <div style="align-self: flex-end;">
                    <button id="btnLoad" style="padding: 8px 20px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        LOAD RECORDS
                    </button>
                </div>
            </div>
        </div>
        
        <div class="options-section">
            <h3 style="color: #2c3e50; margin-bottom: 15px;">Bulk Update Options</h3>
            
            <div class="conditions-list">
                <h4 style="margin: 0 0 10px 0; color: #856404;">Update Conditions:</h4>
                <div class="condition-item">1. Set <strong>Product Type</strong> to: <span class="detail-badge badge-raw">RAW MATERIAL</span> (todos)</div>
                <div class="condition-item">2. Set <strong>Process Steps 1-18</strong> to: <span class="detail-badge badge-process">yes</span> (solo si Estatus = "Approved")</div>
                <div class="condition-item">3. Set <strong>PPAP overall status</strong> to: <span class="detail-badge badge-overall">Approved</span> (solo si Estatus = "Approved")</div>
                <div class="condition-item">4. Set <strong>Revision</strong> to: <span class="detail-badge badge-revision">A</span> (todos los registros)</div>
                <div class="condition-item">5. Format <strong>Comments(detalle)</strong> - aproximadamente 2 palabras por l√≠nea</div>
                <div class="condition-item">6. Saltar registros que ya tienen las condiciones aplicadas</div>
            </div>
            
            <div class="comments-example">
                Ejemplo de formato de comentarios:<br>
                J.Arias.- 9/19-el mismo<br>
                FG que el 80514385:<br>
                16821432305- 10/20<br>
                Se regresan a Jorge<br>
                Arias=&gt;100% medicion
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <input type="checkbox" id="chk-set-raw" checked>
                    <label for="chk-set-raw" style="font-weight: bold;">1. Set Product Type to: <span class="detail-badge badge-raw">RAW MATERIAL</span></label>
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <input type="checkbox" id="chk-set-process-yes" checked>
                    <label for="chk-set-process-yes" style="font-weight: bold;">2. Set Process Steps 1-18 to: <span class="detail-badge badge-process">yes</span> (min√∫sculas)</label>
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <input type="checkbox" id="chk-set-overall-approved" checked>
                    <label for="chk-set-overall-approved" style="font-weight: bold;">3. Set "PPAP overall status" to: <span class="detail-badge badge-overall">Approved</span></label>
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <input type="checkbox" id="chk-set-revision-a" checked>
                    <label for="chk-set-revision-a" style="font-weight: bold;">4. Set "Revision" to: <span class="detail-badge badge-revision">A</span> (todos)</label>
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <input type="checkbox" id="chk-format-comments" checked>
                    <label for="chk-format-comments" style="font-weight: bold;">5. Format "Comments(detalle)" (‚âà2 palabras por l√≠nea)</label>
                </div>
                
                <div style="font-size: 12px; color: #666; background: #f0f7ff; padding: 10px; border-radius: 5px;">
                    <strong>Note:</strong> 
                    <ul style="margin: 5px 0; padding-left: 15px;">
                        <li>Condiciones 2-3 solo aplican si Estatus = "Approved"</li>
                        <li>Condiciones 1, 4, 5 aplican a TODOS los registros</li>
                        <li>Los registros que ya cumplen las condiciones ser√°n saltados</li>
                        <li>"yes" en min√∫sculas, "RAW MATERIAL" en may√∫sculas</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="progress-container" id="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">Processing...</div>
        </div>
        
        <div style="display: flex; justify-content: center; gap: 15px; margin: 30px 0;">
            <button id="btnExportCSV" class="btn-export btn-csv">üì• EXPORT TO CSV</button>
            <button id="btnUpdateAll" class="btn-update">üîÑ APPLY BULK UPDATES</button>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="color: #2c3e50; margin: 0;">Records Found: <span id="record-count" class="count-badge">0</span></h3>
            <div style="font-size: 12px; color: #7f8c8d;">
                Showing: <span id="filter-info">All records</span>
            </div>
        </div>
        
        <div class="results-section" id="results-section">
            <div style="text-align: center; padding: 30px; color: #7f8c8d;">
                Select filters and click "LOAD RECORDS"
            </div>
        </div>
    </div>

    <!-- CORPORATE FOOTER -->
    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">¬© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, query, where, getDocs, writeBatch, doc, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Show current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        
        // Show current user
        const user = checkAuth();
        if(user) {
            document.getElementById('current-user-display').textContent = `üë§ ${user.usuario}`;
        }

        // Only admin can access this page
        if(!user || user.usuario !== 'admin') {
            alert("Access denied. Admin only.");
            window.location.href = "index.html";
        }

        let currentRecords = [];
        
        // Process field names (1-18 as in your database)
        const processFields = [
            "1 Design records",
            "2\nECN document",
            "3\nCustomer eng approval",
            "4\nDesign FMEA",
            "5\nProcess Flow Diagram",
            "6\nPFMEA",
            "7\nControl Plan",
            "8\nMSA Studies",
            "9\nDimensional results",
            "10\nMaterial, performance test result",
            "11\nInitial Process Studies",
            "12\nQualify Lab Documentation",
            "13\nAppereance Approval Report",
            "14\nSample product",
            "15\nChecking Aids",
            "16\nRecord of compliance",
            "17\nBulk material checklist",
            "18\nPSW\n(Full or Interim)"
        ];

        // Function to format comments - approximately 2 words per line
        function formatComments(comments) {
            if (!comments || comments.trim() === '') {
                return '';
            }
            
            // Remove extra spaces and normalize line breaks
            let text = comments.trim().replace(/\s+/g, ' ').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // Split by existing line breaks first
            const lines = text.split('\n');
            const resultLines = [];
            
            // Process each line
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;
                
                // Split into words
                const words = trimmedLine.split(/\s+/);
                
                // If line is short enough, keep as is
                if (words.length <= 3) {
                    resultLines.push(trimmedLine);
                    return;
                }
                
                // Break into approximately 2-word chunks
                for (let i = 0; i < words.length; i += 2) {
                    const chunk = words.slice(i, i + 2).join(' ');
                    if (chunk) {
                        resultLines.push(chunk);
                    }
                }
            });
            
            return resultLines.join('\n');
        }

        // Function to check if a record already meets conditions
        function recordAlreadyMeetsConditions(record, options) {
            const conditions = [];
            
            // Check Product Type condition
            if (options.setRawMaterial && record['Product type'] === 'RAW MATERIAL') {
                conditions.push('Product Type');
            }
            
            // Check Revision condition
            if (options.setRevisionA && record['Revision'] === 'A') {
                conditions.push('Revision');
            }
            
            // Only check process steps if record is Approved
            if (record.Estatus === 'Approved' && options.setProcessYes) {
                const allProcessYes = processFields.every(field => 
                    record[field] && record[field].toLowerCase() === 'yes'
                );
                if (allProcessYes) {
                    conditions.push('Process Steps');
                }
            }
            
            // Check PPAP overall status if record is Approved
            if (record.Estatus === 'Approved' && options.setOverallApproved) {
                if (record['PPAP overall status'] === 'Approved') {
                    conditions.push('PPAP Overall Status');
                }
            }
            
            // Check comments formatting
            if (options.formatComments) {
                const currentComments = record['Comments(detalle)'] || '';
                const formattedComments = formatComments(currentComments);
                if (currentComments === formattedComments || 
                    (!currentComments && !formattedComments)) {
                    conditions.push('Comments Format');
                }
            }
            
            return {
                meetsAll: conditions.length === Object.keys(options).filter(k => options[k]).length,
                conditionsMet: conditions
            };
        }

        // Load records based on filters
        document.getElementById('btnLoad').onclick = async () => {
            const statusFilter = document.getElementById('filter-status').value;
            const commentsFilter = document.getElementById('filter-comments').value;
            
            try {
                // Start with base query
                let q;
                
                if (statusFilter === 'All') {
                    q = query(collection(db, "productos"));
                } else {
                    q = query(collection(db, "productos"), where("Estatus", "==", statusFilter));
                }
                
                const snap = await getDocs(q);
                currentRecords = [];
                
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    
                    // Apply comments filter
                    const hasComments = data['Comments(detalle)'] && data['Comments(detalle)'].trim() !== '';
                    
                    if (commentsFilter === 'WithComments' && !hasComments) {
                        return;
                    }
                    if (commentsFilter === 'WithoutComments' && hasComments) {
                        return;
                    }
                    
                    currentRecords.push({
                        id: id,
                        ...data
                    });
                });
                
                // Update record count
                document.getElementById('record-count').textContent = currentRecords.length;
                
                // Update filter info
                let filterInfo = statusFilter === 'All' ? 'All statuses' : `Status: ${statusFilter}`;
                if (commentsFilter === 'WithComments') {
                    filterInfo += ' | With comments';
                } else if (commentsFilter === 'WithoutComments') {
                    filterInfo += ' | Without comments';
                }
                document.getElementById('filter-info').textContent = filterInfo;
                
                // Display records
                displayRecords(currentRecords);
                
            } catch (error) {
                console.error("Error loading records:", error);
                alert("Error loading records: " + error.message);
            }
        };

        function displayRecords(records) {
            const resultsSection = document.getElementById('results-section');
            
            if (records.length === 0) {
                resultsSection.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #7f8c8d;">
                        No records found with the selected filters
                    </div>
                `;
                return;
            }
            
            let html = '';
            records.forEach((record, index) => {
                const isApproved = record.Estatus === 'Approved';
                const statusColor = isApproved ? '#27ae60' : 
                                  record.Estatus === 'Pending' ? '#f39c12' : 
                                  record.Estatus === 'Rejected' ? '#e74c3c' : '#3498db';
                
                const hasComments = record['Comments(detalle)'] && record['Comments(detalle)'].trim() !== '';
                const commentsPreview = hasComments ? record['Comments(detalle)'] : 'No comments';
                const isMultiline = commentsPreview.includes('\n');
                
                const currentOptions = {
                    setRawMaterial: true,
                    setProcessYes: true,
                    setOverallApproved: true,
                    setRevisionA: true,
                    formatComments: true
                };
                
                const conditionsCheck = recordAlreadyMeetsConditions(record, currentOptions);
                
                // Count how many process steps are already "yes"
                const processYesCount = processFields.filter(field => 
                    record[field] && record[field].toLowerCase() === 'yes'
                ).length;
                
                html += `
                    <div class="record-item">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <strong style="color: #2c3e50;">${record['Item #'] || 'N/A'}</strong>
                                <span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${statusColor}; color: white;">
                                    ${record.Estatus || 'No status'}
                                </span>
                                ${record['Revision'] === 'A' ? '<span class="detail-badge badge-revision">A</span>' : ''}
                                ${record['Product type'] === 'RAW MATERIAL' ? '<span class="detail-badge badge-raw">RAW</span>' : ''}
                                ${processYesCount === 18 ? '<span class="detail-badge badge-process">18/18</span>' : ''}
                            </div>
                            
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                                ${record['PPAP Part Number'] || 'No PPAP'} | 
                                Overall: <strong style="${record['PPAP overall status'] === 'Approved' ? 'color: #27ae60;' : 'color: #666;'}">
                                    ${record['PPAP overall status'] || 'None'}
                                </strong>
                            </div>
                            
                            <div class="record-details">
                                <div>Type: <strong>${record['Product type'] || 'None'}</strong></div>
                                <div>Process: <strong>${processYesCount}/18 yes</strong></div>
                            </div>
                            
                            ${hasComments ? `
                                <div class="comments-preview ${isMultiline ? 'multiline' : ''}" title="${commentsPreview.replace(/"/g, '&quot;')}">
                                    üí¨ ${commentsPreview.substring(0, 100)}${commentsPreview.length > 100 ? '...' : ''}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="font-size: 10px; text-align: right; min-width: 120px;">
                            ${conditionsCheck.conditionsMet.length > 0 ? `
                                <div style="margin-bottom: 5px;">
                                    <span class="skip-indicator">Skips: ${conditionsCheck.conditionsMet.length}</span>
                                </div>
                            ` : ''}
                            <div style="color: #7f8c8d;">
                                Needs update
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsSection.innerHTML = html;
        }

        // Export to CSV
        document.getElementById('btnExportCSV').onclick = () => {
            if (currentRecords.length === 0) {
                alert("No records to export. Load records first.");
                return;
            }
            
            // Define CSV headers
            const headers = [
                'Item #',
                'PPAP Part Number',
                'Estatus',
                'Product type',
                'Revision',
                'PPAP overall status',
                'Component description',
                'Validation date',
                'Programmer',
                'Quality Lead',
                'Comments(detalle)'
            ];
            
            // Add process steps to headers
            processFields.forEach(field => {
                headers.push(field.replace(/\n/g, ' '));
            });
            
            // Create CSV content
            let csvContent = headers.join(',') + '\n';
            
            currentRecords.forEach(record => {
                const row = [
                    record['Item #'] || '',
                    record['PPAP Part Number'] || '',
                    record.Estatus || '',
                    record['Product type'] || '',
                    record['Revision'] || '',
                    record['PPAP overall status'] || '',
                    record['Component description'] || '',
                    record['Validation date'] || '',
                    record.Programmer || '',
                    record['Quality Lead'] || '',
                    `"${(record['Comments(detalle)'] || '').replace(/"/g, '""')}"`
                ];
                
                // Add process steps
                processFields.forEach(field => {
                    row.push(record[field] || 'No');
                });
                
                csvContent += row.map(cell => typeof cell === 'string' && cell.startsWith('"') ? cell : `"${cell}"`).join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `ppap_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Exported ${currentRecords.length} records to CSV`);
        };

        // Bulk update records
        document.getElementById('btnUpdateAll').onclick = async () => {
            if (currentRecords.length === 0) {
                alert("No records to update. Load records first.");
                return;
            }
            
            const setRawMaterial = document.getElementById('chk-set-raw').checked;
            const setProcessYes = document.getElementById('chk-set-process-yes').checked;
            const setOverallApproved = document.getElementById('chk-set-overall-approved').checked;
            const setRevisionA = document.getElementById('chk-set-revision-a').checked;
            const formatComments = document.getElementById('chk-format-comments').checked;
            
            if (!setRawMaterial && !setProcessYes && !setOverallApproved && !setRevisionA && !formatComments) {
                alert("Please select at least one update option.");
                return;
            }
            
            const selectedOptions = { setRawMaterial, setProcessYes, setOverallApproved, setRevisionA, formatComments };
            
            let confirmMessage = `Are you sure you want to update ${currentRecords.length} records?\n\nThis will:`;
            if (setRawMaterial) confirmMessage += "\n‚Ä¢ Set ALL Product Types to 'RAW MATERIAL'";
            if (setProcessYes) confirmMessage += "\n‚Ä¢ Set Process Steps 1-18 to 'yes' (only for Approved items)";
            if (setOverallApproved) confirmMessage += "\n‚Ä¢ Set 'PPAP overall status' to 'Approved' (only for Approved items)";
            if (setRevisionA) confirmMessage += "\n‚Ä¢ Set ALL 'Revision' fields to 'A'";
            if (formatComments) confirmMessage += "\n‚Ä¢ Format 'Comments(detalle)' to approx. 2 words per line";
            confirmMessage += "\n\nRecords that already meet conditions will be skipped.";
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Show progress bar
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Analyzing records...';
            
            try {
                let updatedCount = 0;
                let skippedCount = 0;
                let needsUpdateCount = 0;
                
                // First, analyze which records need updates
                const recordsToUpdate = [];
                
                currentRecords.forEach(record => {
                    const conditionsCheck = recordAlreadyMeetsConditions(record, selectedOptions);
                    
                    if (conditionsCheck.meetsAll) {
                        skippedCount++;
                    } else {
                        recordsToUpdate.push(record);
                        needsUpdateCount++;
                    }
                });
                
                progressText.textContent = `Updating ${needsUpdateCount} records (${skippedCount} will be skipped)...`;
                
                // Process in batches
                const BATCH_SIZE = 500;
                for (let batchStart = 0; batchStart < recordsToUpdate.length; batchStart += BATCH_SIZE) {
                    const batchEnd = Math.min(batchStart + BATCH_SIZE, recordsToUpdate.length);
                    const currentBatch = recordsToUpdate.slice(batchStart, batchEnd);
                    
                    const batch = writeBatch(db);
                    
                    for (let i = 0; i < currentBatch.length; i++) {
                        const record = currentBatch[i];
                        const docRef = doc(db, "productos", record.id);
                        
                        const updates = {};
                        
                        // Apply RAW MATERIAL to ALL records if selected
                        if (setRawMaterial && record['Product type'] !== 'RAW MATERIAL') {
                            updates['Product type'] = 'RAW MATERIAL';
                        }
                        
                        // Apply Revision "A" to ALL records if selected
                        if (setRevisionA && record['Revision'] !== 'A') {
                            updates['Revision'] = 'A';
                        }
                        
                        // Apply process steps and overall status only if record is Approved
                        if (record.Estatus === 'Approved') {
                            // Apply process steps
                            if (setProcessYes) {
                                processFields.forEach(field => {
                                    const currentValue = record[field] || '';
                                    if (currentValue.toLowerCase() !== 'yes') {
                                        updates[field] = 'yes';
                                    }
                                });
                            }
                            
                            // Apply PPAP overall status
                            if (setOverallApproved && record['PPAP overall status'] !== 'Approved') {
                                updates['PPAP overall status'] = 'Approved';
                            }
                        }
                        
                        // Format comments if selected
                        if (formatComments && record['Comments(detalle)']) {
                            const currentComments = record['Comments(detalle)'] || '';
                            const formattedComments = formatComments(currentComments);
                            if (currentComments !== formattedComments) {
                                updates['Comments(detalle)'] = formattedComments;
                            }
                        }
                        
                        // Only add to batch if there are updates
                        if (Object.keys(updates).length > 0) {
                            batch.update(docRef, updates);
                            updatedCount++;
                        } else {
                            skippedCount++;
                        }
                        
                        // Update progress
                        const totalProcessed = batchStart + i + 1;
                        const progress = Math.round((totalProcessed / recordsToUpdate.length) * 100);
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `Processing: ${totalProcessed}/${recordsToUpdate.length} (${progress}%)`;
                    }
                    
                    // Commit batch if there are updates
                    if (batch._mutations.length > 0) {
                        await batch.commit();
                        
                        // Small delay between batches to avoid rate limiting
                        if (batchEnd < recordsToUpdate.length) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                    }
                }
                
                // Hide progress bar
                progressContainer.style.display = 'none';
                
                // Log the bulk update
                await addDoc(collection(db, "movimientos"), {
                    usuario: user.usuario,
                    accion: "Bulk Update",
                    detalle: `Updated ${updatedCount} records | RAW MATERIAL: ${setRawMaterial} | Process Steps: ${setProcessYes} | Overall Status: ${setOverallApproved} | Revision: ${setRevisionA} | Comments: ${formatComments}`,
                    fecha: serverTimestamp(),
                    stats: {
                        total: currentRecords.length,
                        updated: updatedCount,
                        skipped: skippedCount
                    }
                });
                
                let message = `‚úÖ Update completed!\n\n`;
                message += `‚Ä¢ Total records: ${currentRecords.length}\n`;
                message += `‚Ä¢ Updated: ${updatedCount}\n`;
                message += `‚Ä¢ Skipped (already met conditions): ${skippedCount}\n\n`;
                
                if (setRawMaterial) message += `‚Ä¢ Product Type set to: RAW MATERIAL\n`;
                if (setProcessYes) message += `‚Ä¢ Process Steps set to: yes (for Approved items)\n`;
                if (setOverallApproved) message += `‚Ä¢ PPAP overall status set to: Approved (for Approved items)\n`;
                if (setRevisionA) message += `‚Ä¢ Revision set to: A\n`;
                if (formatComments) message += `‚Ä¢ Comments formatted to ~2 words per line\n`;
                
                alert(message);
                
                // Reload records to show changes
                document.getElementById('btnLoad').click();
                
            } catch (error) {
                console.error("Error updating records:", error);
                alert("Error updating records: " + error.message);
                progressContainer.style.display = 'none';
            }
        };

        // Load default records on page load (Approved status)
        window.addEventListener('load', () => {
            document.getElementById('btnLoad').click();
        });
    </script>
</body>
</html>