<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>New PPAP Registration</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .required-field {
            border-color: #e74c3c !important;
            background-color: #fff8f8 !important;
        }
        .field-note {
            font-size: 10px;
            color: #7f8c8d;
            margin-top: 2px;
        }
        .status-message {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 4px;
            display: none;
        }
        .status-error {
            background-color: #ffe6e6;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        .status-success {
            background-color: #f0fff4;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
        }
        
        /* Estilo para los nuevos textareas */
        textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
        }

        .vc2-header {
            background: linear-gradient(to right, #003366, #0056a9);
            color: white;
            text-align: center;
            padding: 12px 0;
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 2px;
            margin: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .vc2-container {
            display: flex;
            justify-content: center;
            width: 100%;
            background: linear-gradient(to right, #003366, #0056a9);
        }
    </style>
</head>
<body class="bg-blue">
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            <div>
                <h1>PPAP Master Track System</h1>
               <div class="subtitle" style="color: white;">SMP Engine Management, S. de R.L. de C.V</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">ðŸ‘¤ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>
    
    <div class="vc2-container">
        <div class="vc2-header">
            VC2
        </div>
    </div>
    
    <header><h1>New PPAP Registration</h1></header>
    
    <div style="padding:20px; max-width:1000px; margin:auto; background:white; color:black; border-radius:10px;">
        <h2 style="color: #2c3e50;">New PPAP Registration</h2>
        <div id="form-container" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
        <div id="item-status" class="status-message"></div>
        <button id="btnGuardar" style="width:100%; margin-top:20px; padding:15px; background:linear-gradient(135deg, #27ae60, #2ecc71); color:white; font-weight:bold; cursor:pointer; border:none; border-radius:5px;">SAVE REGISTRATION</button>
        <button onclick="location.href='index.html'" style="width:100%; margin-top:10px; padding:10px; background:#95a5a6; color:white; border:none; border-radius:5px; cursor:pointer;">BACK TO HOME</button>
    </div>

    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">Â© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { db, checkAuth, redirectIfNoPermission } from './config.js';
        import { collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // DB FIELDS
        const camposDB = [
            "Item #",
            "PPAP Part Number",
            "Component description",
            "Reason for Change",
            "Product type",
            "PRP5/Area",
            "OE/AFTERMARKET",
            "documentation",
            "Samples received",
            "Location",
            "Dimensional",
            "Special instruccions",
            "Validation date",
            "Programmer",
            "Quality Lead",
            "Reason",
            "Comments(detalle)",
            "Responsible",
            "Estatus",
            "Revision",
            "PPAP type OE / SM\nAfter Market",
            "1 Design records",
            "2\nECN document",
            "3\nCustomer eng approval",
            "4\nDesign FMEA",
            "5\nProcess Flow Diagram",
            "6\nPFMEA",
            "7\nControl Plan",
            "8\nMSA Studies",
            "9\nDimensional results",
            "10\nMaterial, performance test result",
            "11\nInitial Process Studies",
            "12\nQualify Lab Documentation",
            "13\nAppereance Approval Report",
            "14\nSample product",
            "15\nChecking Aids",
            "16\nRecord of compliance",
            "17\nBulk material checklist",
            "18\nPSW\n(Full or Interim)",
            "Supplier PPAP package status",
            "Validation run readiness",
            "Samples on hand",
            "Dimension status",
            "FFF review status",
            "AAR review status",
            "PPAP overall status"
        ];

        const camposUI = camposDB.map(field => field.replace(/\n/g, " "));

        const container = document.getElementById('form-container');
        let itemExists = false;
        
        camposDB.forEach((c, index) => {
            const div = document.createElement('div');
            const safeId = c.replace(/\n/g, "_").replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "");
            const campoLabel = camposUI[index];
            const isRequired = c === "Item #" || c === "PPAP Part Number";
            
            // LÃ³gica para decidir si usar Textarea o Input
            let inputHtml = '';
            // Si es Comentarios, DescripciÃ³n o RazÃ³n, usamos Textarea
            if (c === "Comments(detalle)" || c === "Component description" || c === "Reason") {
                inputHtml = `
                    <textarea id="ins_${safeId}" 
                           placeholder="Enter ${campoLabel}..." 
                           rows="4"></textarea>
                `;
            } else {
                inputHtml = `
                    <input type="text" id="ins_${safeId}" 
                           placeholder="Enter ${campoLabel}" 
                           style="width:100%; padding:8px; box-sizing:border-box; border:1px solid #ddd; border-radius:4px;"
                           ${isRequired ? 'class="required-field"' : ''}
                           autocomplete="off">
                `;
            }

            div.innerHTML = `
                <label style="font-size:12px; font-weight:bold; color: #2c3e50;">
                    ${campoLabel}${isRequired ? ' <span style="color:#e74c3c;">*</span>' : ''}
                </label>
                ${inputHtml}
                ${isRequired ? '<div class="field-note">Required field</div>' : ''}
            `;
            container.appendChild(div);
        });

        const itemField = document.getElementById('ins_Item_');
        const saveButton = document.getElementById('btnGuardar');
        let isSaving = false;

        async function checkItemExists(itemNumber) {
            if (!itemNumber || itemNumber.trim() === '') return false;
            try {
                const q = query(collection(db, "productos"), where("Item #", "==", itemNumber));
                const snap = await getDocs(q);
                return !snap.empty;
            } catch (error) {
                console.error("Error checking item:", error);
                return false;
            }
        }

        function validateRequiredFields() {
            let errors = [];
            let isValid = true;
            
            const itemValue = itemField.value.trim();
            if (!itemValue) {
                errors.push("Item # is required");
                itemField.style.borderColor = "#e74c3c";
                isValid = false;
            } else {
                itemField.style.borderColor = "#ddd";
            }
            
            const ppapField = document.getElementById('ins_PPAP_Part_Number');
            const ppapValue = ppapField.value.trim();
            if (!ppapValue) {
                errors.push("PPAP Part Number is required");
                ppapField.style.borderColor = "#e74c3c";
                isValid = false;
            } else {
                const statusValues = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
                if (statusValues.includes(ppapValue)) {
                    errors.push("PPAP Part Number must be a part number (like P-001), not a status");
                    ppapField.style.borderColor = "#e74c3c";
                    isValid = false;
                } else {
                    ppapField.style.borderColor = "#ddd";
                }
            }
            
            return { isValid, errors };
        }

        async function guardarRegistro() {
            if (isSaving) return;
            
            const validation = validateRequiredFields();
            if (!validation.isValid) {
                alert("Please fix the following errors:\n\n" + validation.errors.join("\n"));
                return;
            }
            
            const itemValue = itemField.value.trim();
            const existe = await checkItemExists(itemValue);
            
            if (existe) {
                alert("âŒ Cannot save: Item # already exists. Please use a different Item #.");
                itemField.focus();
                itemField.select();
                return;
            }
            
            if (!confirm("Are you sure you want to save this new PPAP registration?")) return;
            
            isSaving = true;
            saveButton.disabled = true;
            saveButton.classList.add('btn-disabled');
            saveButton.innerHTML = "â³ Saving...";
            
            try {
                const data = {};
                camposDB.forEach(c => { 
                    const safeId = c.replace(/\n/g, "_").replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "");
                    const element = document.getElementById(`ins_${safeId}`);
                    // Obtenemos el valor correctamente sea input o textarea
                    const valor = element.value.trim();
                    data[c] = valor;
                });
                
                await addDoc(collection(db, "productos"), data);
                
                // NOTA: Se eliminÃ³ el registro en la colecciÃ³n "movimientos" como solicitaste
                
                alert("âœ… PPAP registration saved successfully!");
                location.href = 'index.html';
                
            } catch(error) { 
                console.error("Save error:", error);
                alert("âŒ Error saving registration: " + error.message);
                isSaving = false;
                saveButton.disabled = false;
                saveButton.classList.remove('btn-disabled');
                saveButton.innerHTML = "SAVE REGISTRATION";
            }
        }

        saveButton.onclick = guardarRegistro;

        window.addEventListener('load', () => {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
            
            const user = checkAuth();
            if(user) {
                document.getElementById('current-user-display').textContent = `ðŸ‘¤ ${user.usuario}`;
            }

            if (!redirectIfNoPermission('registrar')) { }
            
            if (itemField) itemField.focus();
        });

        // Evento de tecla Enter (ignora si estÃ¡ en un textarea para permitir saltos de lÃ­nea)
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                guardarRegistro();
            }
        });
    </script>
</body>
</html>