<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>New PPAP Registration</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .required-field {
            border-color: #e74c3c !important;
            background-color: #fff8f8 !important;
        }
        .field-note {
            font-size: 10px;
            color: #7f8c8d;
            margin-top: 2px;
        }
        .item-exists {
            border-color: #e74c3c !important;
            background-color: #ffe6e6 !important;
        }
        .status-message {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 4px;
            display: none;
        }
        .status-error {
            background-color: #ffe6e6;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        .status-success {
            background-color: #f0fff4;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
        }
    </style>
</head>
<body class="bg-blue">
    <!-- CORPORATE HEADER -->
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            <div>
                <h1>PPAP Master Track System</h1>
                <div class="subtitle">SMP Engine Management, S. de R.L. de C.V</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">üë§ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>

    <header><h1>New PPAP Registration</h1></header>
    
    <div style="padding:20px; max-width:1000px; margin:auto; background:white; color:black; border-radius:10px;">
        <h2 style="color: #2c3e50;">New PPAP Registration</h2>
        <div id="form-container" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
        <div id="item-status" class="status-message"></div>
        <button id="btnGuardar" style="width:100%; margin-top:20px; padding:15px; background:linear-gradient(135deg, #27ae60, #2ecc71); color:white; font-weight:bold; cursor:pointer; border:none; border-radius:5px;">SAVE REGISTRATION</button>
        <button onclick="location.href='index.html'" style="width:100%; margin-top:10px; padding:10px; background:#95a5a6; color:white; border:none; border-radius:5px; cursor:pointer;">BACK TO HOME</button>
    </div>

    <!-- CORPORATE FOOTER -->
    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">¬© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { db, checkAuth, redirectIfNoPermission } from './config.js';
        import { collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Show current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        
        // Show current user
        const user = checkAuth();
        if(user) {
            document.getElementById('current-user-display').textContent = `üë§ ${user.usuario}`;
        }

        // Verify register permission
        if (!redirectIfNoPermission('registrar')) {
            // Already redirects automatically
        }

        // DB FIELDS (EXACTLY as specified)
        const camposDB = [
            "Item #",
            "PPAP Part Number",
            "Component description",
            "Reason for Change",
            "Product type",
            "PRP5/Area",
            "OE/AFTERMARKET",
            "documentation",
            "Samples received",
            "Location",
            "Dimensional",
            "Special instruccions",
            "Validation date",
            "Programmer",
            "Quality Lead",
            "Reason",
            "Comments(detalle)",
            "Responsible",
            "Estatus",
            "Revision",
            "PPAP type OE / SM\nAfter Market",
            "1 Design records",
            "2\nECN document",
            "3\nCustomer eng approval",
            "4\nDesign FMEA",
            "5\nProcess Flow Diagram",
            "6\nPFMEA",
            "7\nControl Plan",
            "8\nMSA Studies",
            "9\nDimensional results",
            "10\nMaterial, performance test result",
            "11\nInitial Process Studies",
            "12\nQualify Lab Documentation",
            "13\nAppereance Approval Report",
            "14\nSample product",
            "15\nChecking Aids",
            "16\nRecord of compliance",
            "17\nBulk material checklist",
            "18\nPSW\n(Full or Interim)",
            "Supplier PPAP package status",
            "Validation run readiness",
            "Samples on hand",
            "Dimension status",
            "FFF review status",
            "AAR review status",
            "PPAP overall status"
        ];

        // UI NAMES (replace line breaks with spaces for display)
        const camposUI = camposDB.map(field => field.replace(/\n/g, " "));

        const container = document.getElementById('form-container');
        
        // Variable para almacenar el estado de verificaci√≥n del Item #
        let itemExists = false;
        
        // Crear los campos del formulario
        camposDB.forEach((c, index) => {
            const div = document.createElement('div');
            // Create safe ID for HTML - CORREGIDO
            const safeId = c.replace(/\n/g, "_").replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "");
            const campoLabel = camposUI[index];
            const isRequired = c === "Item #" || c === "PPAP Part Number";
            
            div.innerHTML = `
                <label style="font-size:12px; font-weight:bold; color: #2c3e50;">
                    ${campoLabel}${isRequired ? ' <span style="color:#e74c3c;">*</span>' : ''}
                </label>
                <input type="text" id="ins_${safeId}" 
                       placeholder="Enter ${campoLabel}" 
                       style="width:100%; padding:8px; box-sizing:border-box; border:1px solid #ddd; border-radius:4px;"
                       ${isRequired ? 'class="required-field"' : ''}
                       autocomplete="off">
                ${isRequired ? '<div class="field-note">Required field</div>' : ''}
            `;
            container.appendChild(div);
        });

        // Obtener referencia al campo Item # - CORREGIDO
        // El ID generado para "Item #" es "ins_Item__" (dos underscores al final)
        const itemField = document.getElementById('ins_Item__');
        const itemStatusDiv = document.getElementById('item-status');
        const saveButton = document.getElementById('btnGuardar');

        // Funci√≥n para verificar si el Item # ya existe
        async function checkItemExists(itemNumber) {
            if (!itemNumber || itemNumber.trim() === '') {
                itemExists = false;
                itemField.classList.remove('item-exists');
                itemStatusDiv.style.display = 'none';
                return false;
            }

            try {
                const q = query(collection(db, "productos"), where("Item #", "==", itemNumber));
                const snap = await getDocs(q);
                
                if (!snap.empty) {
                    // Item ya existe
                    itemExists = true;
                    itemField.classList.add('item-exists');
                    itemStatusDiv.innerHTML = `‚ùå Item # <strong>${itemNumber}</strong> already exists in the database.`;
                    itemStatusDiv.className = 'status-message status-error';
                    itemStatusDiv.style.display = 'block';
                    return true;
                } else {
                    // Item disponible
                    itemExists = false;
                    itemField.classList.remove('item-exists');
                    itemStatusDiv.innerHTML = `‚úÖ Item # <strong>${itemNumber}</strong> is available.`;
                    itemStatusDiv.className = 'status-message status-success';
                    itemStatusDiv.style.display = 'block';
                    return false;
                }
            } catch (error) {
                console.error("Error checking item:", error);
                return false;
            }
        }

        // Event listener para verificar cuando el usuario sale del campo Item #
        // Solo agregar el listener si el elemento existe
        if (itemField) {
            itemField.addEventListener('blur', async () => {
                const itemValue = itemField.value.trim();
                if (itemValue) {
                    await checkItemExists(itemValue);
                }
            });
        } else {
            console.error("Error: No se pudo encontrar el campo Item #");
        }

        // Funci√≥n para validar campos requeridos
        function validateRequiredFields() {
            let errors = [];
            let isValid = true;
            
            // Validar Item #
            const itemValue = itemField ? itemField.value.trim() : '';
            if (!itemValue) {
                errors.push("Item # is required");
                if (itemField) itemField.style.borderColor = "#e74c3c";
                isValid = false;
            } else {
                if (itemField) itemField.style.borderColor = "#ddd";
            }
            
            // Validar PPAP Part Number - CORREGIDO el ID
            const ppapField = document.getElementById('ins_PPAP_Part_Number');
            const ppapValue = ppapField ? ppapField.value.trim() : '';
            if (!ppapValue) {
                errors.push("PPAP Part Number is required");
                if (ppapField) ppapField.style.borderColor = "#e74c3c";
                isValid = false;
            } else {
                // Validate it's not a status
                const statusValues = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
                if (statusValues.includes(ppapValue)) {
                    errors.push("PPAP Part Number must be a part number (like P-001), not a status");
                    if (ppapField) ppapField.style.borderColor = "#e74c3c";
                    isValid = false;
                } else {
                    if (ppapField) ppapField.style.borderColor = "#ddd";
                }
            }
            
            return { isValid, errors };
        }

        // Declarar la funci√≥n guardarRegistro como una funci√≥n normal
        async function guardarRegistro() {
            console.log("Save button clicked");
            
            // Validar campos requeridos
            const validation = validateRequiredFields();
            if (!validation.isValid) {
                alert("Please fix the following errors:\n\n" + validation.errors.join("\n"));
                return;
            }
            
            // Verificar si el Item # ya existe
            const itemValue = itemField ? itemField.value.trim() : '';
            const existe = await checkItemExists(itemValue);
            
            if (existe) {
                alert("‚ùå Cannot save: Item # already exists in the database. Please use a different Item #.");
                if (itemField) {
                    itemField.focus();
                    itemField.select();
                }
                return;
            }
            
            // Mostrar confirmaci√≥n
            if (!confirm("Are you sure you want to save this new PPAP registration?")) {
                return;
            }
            
            // Deshabilitar bot√≥n mientras se guarda
            saveButton.disabled = true;
            saveButton.classList.add('btn-disabled');
            saveButton.innerHTML = "‚è≥ Saving...";
            
            try {
                // Recopilar todos los datos del formulario
                const data = {};
                camposDB.forEach(c => { 
                    const safeId = c.replace(/\n/g, "_").replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "");
                    const element = document.getElementById(`ins_${safeId}`);
                    const valor = element ? element.value.trim() : '';
                    data[c] = valor;
                });
                
                // Guardar producto en Firestore
                console.log("Saving data to Firestore:", data);
                await addDoc(collection(db, "productos"), data);
                
                // Registrar en el historial
                await addDoc(collection(db, "movimientos"), {
                    usuario: user.usuario,
                    accion: "New Registration",
                    detalle: `Item: ${data["Item #"]} | PPAP: ${data["PPAP Part Number"]} | Desc: ${data["Component description"] || 'No description'}`,
                    statusMomento: data["PPAP overall status"] || "Pending",
                    fecha: serverTimestamp(),
                    itemId: data["Item #"],
                    ppapNumber: data["PPAP Part Number"]
                });
                
                console.log("Registration saved successfully");
                alert("‚úÖ PPAP registration saved successfully!");
                location.href = 'index.html';
                
            } catch(error) { 
                console.error("Save error:", error);
                alert("‚ùå Error saving registration: " + error.message);
                
                // Rehabilitar bot√≥n en caso de error
                saveButton.disabled = false;
                saveButton.classList.remove('btn-disabled');
                saveButton.innerHTML = "SAVE REGISTRATION";
            }
        }

        // Asignar la funci√≥n al bot√≥n
        saveButton.onclick = guardarRegistro;

        // Enfocar el campo Item # al cargar la p√°gina
        window.addEventListener('load', () => {
            if (itemField) {
                itemField.focus();
            }
            console.log("Registration page loaded");
        });

        // ‚úÖ Evento de tecla Enter DENTRO del m√≥dulo
        document.addEventListener('keypress', function(e) {
            // Solo activar con Enter si no est√° en un textarea
            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                guardarRegistro();
            }
        });
    </script>
</body>
</html>