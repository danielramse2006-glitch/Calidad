<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>New PPAP Registration</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-blue">
    <!-- CORPORATE HEADER -->
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            <div>
                <h1>PPAP Master Track System</h1>
                <div class="subtitle">SMP Engine Management, S. de R.L. de C.V</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">üë§ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>

    <header><h1>New PPAP Registration</h1></header>
    
    <div style="padding:20px; max-width:900px; margin:auto; background:white; color:black; border-radius:10px;">
        <h2 style="color: #2c3e50;">New PPAP Registration</h2>
        <div id="form-container" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
        <button id="btnGuardar" style="width:100%; margin-top:20px; padding:15px; background:linear-gradient(135deg, #27ae60, #2ecc71); color:white; font-weight:bold; cursor:pointer; border:none; border-radius:5px;">SAVE REGISTRATION</button>
        <button onclick="location.href='index.html'" style="width:100%; margin-top:10px; padding:10px; background:#95a5a6; color:white; border:none; border-radius:5px; cursor:pointer;">BACK TO HOME</button>
    </div>

    <!-- CORPORATE FOOTER -->
    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">¬© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { db, checkAuth, redirectIfNoPermission } from './config.js';
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Show current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        
        // Show current user
        const user = checkAuth();
        if(user) {
            document.getElementById('current-user-display').textContent = `üë§ ${user.usuario}`;
        }

        // Verify register permission
        if (!redirectIfNoPermission('registrar')) {
            // Already redirects automatically
        }

        // DB FIELDS (for saving)
        const camposDB = [
            "Item #", "Estatus", "Programador", "PPAP Part Number", "Component Description",
            "Razon de Cambio", "PRP5/area", "Lider de Calidad", " OE/AFTERMARKET ", 
            "Se entrego documentacion", "Muestras Recibidas", "Ubicacion Fisica ",
            "Fecha de Programacion", "Proceso", "Update", "Comments", "Responsable",
            "Instrucciones Especiales", "PPAP Type OE / SM AFTER Market", "PV Result",
            "1-Design records", "2-ECN document", "3-Customer eng approval", "4-Design FMEA",
            "5-Process Flow Diagram", "6-PFMEA", "7-Control Plan", "8-MSA Studies",
            "9-Dimensional results", "10-Material, performance test result",
            "11-Initial Process Studies", "12-Qualify Lab Documentation",
            "13-Appereance Approval Report", "14-Sample product", "15-Checking Aids",
            "16-Record de compliance", "17-Bulk material checklist", "18-PSW(Full or Interim)",
            "Supplier PPAP package status", "Validation run readiness", "Samples on hand",
            "Dimension status", "FFF review status", "AAR review status", "PPAP overall status"
        ];

        // NEW NAMES FOR UI (labels)
        const camposUI = [
            "Item #", 
            "Estatus", 
            "Programmer", 
            "PPAP Part Number", 
            "Component description", 
            "Reason for Change", 
            "PRP5/Area", 
            "Quality Lead", 
            "OE/AFTERMARKET", 
            "documentation", 
            "Samples received", 
            "Location", 
            "Validation date", 
            "Process", 
            "Update", 
            "Comments(detalle)", 
            "Responsible", 
            "Special instruccions", 
            "PPAP type OE / SM After Market", 
            "PV Result",
            "1 Design records", 
            "2 ECN document", 
            "3 Customer eng approval", 
            "4 Design FMEA",
            "5 Process Flow Diagram", 
            "6 PFMEA", 
            "7 Control Plan", 
            "8 MSA Studies",
            "9 Dimensional results", 
            "10 Material, performance test result",
            "11 Initial Process Studies", 
            "12 Qualify Lab Documentation",
            "13 Appereance Approval Report", 
            "14 Sample product", 
            "15 Checking Aids",
            "16 Record of compliance", 
            "17 Bulk material checklist", 
            "18 PSW (Full or Interim)",
            "Supplier PPAP package status", 
            "Validation run readiness", 
            "Samples on hand",
            "Dimension status", 
            "FFF review status", 
            "AAR review status", 
            "PPAP overall status"
        ];

        const container = document.getElementById('form-container');
        
        camposDB.forEach((c, index) => {
            const div = document.createElement('div');
            // Show label with new name, but ID with original DB name
            div.innerHTML = `
                <label style="font-size:12px; font-weight:bold; color: #2c3e50;">
                    ${camposUI[index] || c}
                </label>
                <input type="text" id="ins-${c}" 
                       placeholder="Enter ${camposUI[index] || c}" 
                       style="width:100%; padding:8px; box-sizing:border-box; border:1px solid #ddd; border-radius:4px;"
                       ${c === "Item #" || c === "PPAP Part Number" ? 'class="required-field"' : ''}>
            `;
            container.appendChild(div);
        });

        document.getElementById('btnGuardar').onclick = async () => {
            const data = {};
            let errores = [];
            
            // Recoger y validar datos
            camposDB.forEach(c => { 
                const valor = document.getElementById(`ins-${c}`).value.trim();
                data[c] = valor;
                
                // VALIDACIONES ESPEC√çFICAS
                if (c === "Item #" && !valor) {
                    errores.push("Item # is required");
                    document.getElementById(`ins-${c}`).style.borderColor = "#e74c3c";
                } else if (c === "Item #") {
                    document.getElementById(`ins-${c}`).style.borderColor = "#ddd";
                }
                
                if (c === "PPAP Part Number") {
                    if (!valor) {
                        errores.push("PPAP Part Number is required");
                        document.getElementById(`ins-${c}`).style.borderColor = "#e74c3c";
                    } else {
                        // Validar que no sea un status
                        const statusValues = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
                        if (statusValues.includes(valor)) {
                            errores.push("PPAP Part Number must be a part number (like P-001), not a status");
                            document.getElementById(`ins-${c}`).style.borderColor = "#e74c3c";
                        } else {
                            document.getElementById(`ins-${c}`).style.borderColor = "#ddd";
                        }
                    }
                }
            });
            
            if (errores.length > 0) {
                alert("Errors:\n" + errores.join("\n"));
                return;
            }
            
            try {
                // Guardar producto
                await addDoc(collection(db, "productos"), data);
                
                // LOG REGISTRATION - FORMATO MEJORADO PARA B√öSQUEDA
                await addDoc(collection(db, "movimientos"), {
                    usuario: user.usuario,
                    accion: "New Registration",
                    detalle: `Item: ${data["Item #"]} | PPAP: ${data["PPAP Part Number"]} | Desc: ${data["Component Description"] || 'No description'}`,
                    statusMomento: data["PPAP overall status"] || "Pending",
                    fecha: serverTimestamp(),
                    itemId: data["Item #"],
                    ppapNumber: data["PPAP Part Number"]
                });
                
                alert("‚úÖ Saved successfully.");
                location.href = 'index.html';
            } catch(e) { 
                console.error("Save error:", e);
                alert("‚ùå Error saving: " + e.message); 
            }
        };
    </script>
</body>
</html>