<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>New PPAP Registration</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .required-field {
            border-color: #e74c3c !important;
            background-color: #fff8f8 !important;
        }
        .field-note {
            font-size: 10px;
            color: #7f8c8d;
            margin-top: 2px;
        }
    </style>
</head>
<body class="bg-blue">
    <!-- CORPORATE HEADER -->
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            <div>
                <h1>PPAP Master Track System</h1>
                <div class="subtitle">SMP Engine Management, S. de R.L. de C.V</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">üë§ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>

    <header><h1>New PPAP Registration</h1></header>
    
    <div style="padding:20px; max-width:1000px; margin:auto; background:white; color:black; border-radius:10px;">
        <h2 style="color: #2c3e50;">New PPAP Registration</h2>
        <div id="form-container" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
        <button id="btnGuardar" style="width:100%; margin-top:20px; padding:15px; background:linear-gradient(135deg, #27ae60, #2ecc71); color:white; font-weight:bold; cursor:pointer; border:none; border-radius:5px;">SAVE REGISTRATION</button>
        <button onclick="location.href='index.html'" style="width:100%; margin-top:10px; padding:10px; background:#95a5a6; color:white; border:none; border-radius:5px; cursor:pointer;">BACK TO HOME</button>
    </div>

    <!-- CORPORATE FOOTER -->
    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">¬© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { db, checkAuth, redirectIfNoPermission } from './config.js';
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Show current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        
        // Show current user
        const user = checkAuth();
        if(user) {
            document.getElementById('current-user-display').textContent = `üë§ ${user.usuario}`;
        }

        // Verify register permission
        if (!redirectIfNoPermission('registrar')) {
            // Already redirects automatically
        }

        // DB FIELDS (EXACTLY as specified)
        const camposDB = [
            "Item #",
            "PPAP Part Number",
            "Component description",
            "Reason for Change",
            "Product type",
            "PRP5/Area",
            "OE/AFTERMARKET",
            "documentation",
            "Samples received",
            "Location",
            "Dimensional",
            "Special instruccions",
            "Validation date",
            "Programmer",
            "Quality Lead",
            "Reason",
            "Comments(detalle)",
            "Responsible",
            "Estatus",
            "Revision",
            "PPAP type OE / SM\nAfter Market",
            "1 Design records",
            "2\nECN document",
            "3\nCustomer eng approval",
            "4\nDesign FMEA",
            "5\nProcess Flow Diagram",
            "6\nPFMEA",
            "7\nControl Plan",
            "8\nMSA Studies",
            "9\nDimensional results",
            "10\nMaterial, performance test result",
            "11\nInitial Process Studies",
            "12\nQualify Lab Documentation",
            "13\nAppereance Approval Report",
            "14\nSample product",
            "15\nChecking Aids",
            "16\nRecord of compliance",
            "17\nBulk material checklist",
            "18\nPSW\n(Full or Interim)",
            "Supplier PPAP package status",
            "Validation run readiness",
            "Samples on hand",
            "Dimension status",
            "FFF review status",
            "AAR review status",
            "PPAP overall status"
        ];

        // UI NAMES (replace line breaks with spaces for display)
        const camposUI = camposDB.map(field => field.replace(/\n/g, " "));

        const container = document.getElementById('form-container');
        
        camposDB.forEach((c, index) => {
            const div = document.createElement('div');
            // Create safe ID for HTML
            const safeId = c.replace(/\n/g, "_").replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "");
            const campoLabel = camposUI[index];
            const isRequired = c === "Item #" || c === "PPAP Part Number";
            
            div.innerHTML = `
                <label style="font-size:12px; font-weight:bold; color: #2c3e50;">
                    ${campoLabel}${isRequired ? ' <span style="color:#e74c3c;">*</span>' : ''}
                </label>
                <input type="text" id="ins_${safeId}" 
                       placeholder="Enter ${campoLabel}" 
                       style="width:100%; padding:8px; box-sizing:border-box; border:1px solid #ddd; border-radius:4px;"
                       ${isRequired ? 'class="required-field"' : ''}>
                ${isRequired ? '<div class="field-note">Required field</div>' : ''}
            `;
            container.appendChild(div);
        });

        document.getElementById('btnGuardar').onclick = async () => {
            const data = {};
            let errores = [];
            
            // Collect and validate data
            camposDB.forEach(c => { 
                const safeId = c.replace(/\n/g, "_").replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "");
                const valor = document.getElementById(`ins_${safeId}`).value.trim();
                data[c] = valor;
                
                // SPECIFIC VALIDATIONS
                if (c === "Item #" && !valor) {
                    errores.push("Item # is required");
                    document.getElementById(`ins_${safeId}`).style.borderColor = "#e74c3c";
                } else if (c === "Item #") {
                    document.getElementById(`ins_${safeId}`).style.borderColor = "#ddd";
                }
                
                if (c === "PPAP Part Number") {
                    if (!valor) {
                        errores.push("PPAP Part Number is required");
                        document.getElementById(`ins_${safeId}`).style.borderColor = "#e74c3c";
                    } else {
                        // Validate it's not a status
                        const statusValues = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
                        if (statusValues.includes(valor)) {
                            errores.push("PPAP Part Number must be a part number (like P-001), not a status");
                            document.getElementById(`ins_${safeId}`).style.borderColor = "#e74c3c";
                        } else {
                            document.getElementById(`ins_${safeId}`).style.borderColor = "#ddd";
                        }
                    }
                }
            });
            
            if (errores.length > 0) {
                alert("Errors:\n" + errores.join("\n"));
                return;
            }
            
            try {
                // Save product
                await addDoc(collection(db, "productos"), data);
                
                // LOG REGISTRATION - Improved format for searching
                await addDoc(collection(db, "movimientos"), {
                    usuario: user.usuario,
                    accion: "New Registration",
                    detalle: `Item: ${data["Item #"]} | PPAP: ${data["PPAP Part Number"]} | Desc: ${data["Component description"] || 'No description'}`,
                    statusMomento: data["PPAP overall status"] || "Pending",
                    fecha: serverTimestamp(),
                    itemId: data["Item #"],
                    ppapNumber: data["PPAP Part Number"]
                });
                
                alert("‚úÖ Saved successfully.");
                location.href = 'index.html';
            } catch(e) { 
                console.error("Save error:", e);
                alert("‚ùå Error saving: " + e.message); 
            }
        };
    </script>
</body>
</html>