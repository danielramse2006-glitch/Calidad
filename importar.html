<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Data Import - PPAP Master Track</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .import-container {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,51,102,0.1);
        }
        
        .import-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1ecff;
        }
        
        .import-header h2 {
            color: #003366;
            margin-bottom: 10px;
        }
        
        .import-header p {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .file-upload-area {
            border: 3px dashed #0099cc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8fbff;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            background: #f0f7ff;
            border-color: #0056a9;
        }
        
        .file-upload-area.dragover {
            background: #e8f4ff;
            border-color: #003366;
        }
        
        .file-info {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .progress-container {
            display: none;
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #27ae60, #2ecc71);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            display: none;
        }
        
        .log-area .success { color: #2ecc71; }
        .log-area .error { color: #e74c3c; }
        .log-area .warning { color: #f39c12; }
        .log-area .info { color: #3498db; }
        
        .mapping-preview {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .mapping-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 11px;
            border-bottom: 1px solid #eee;
        }
        
        .mapping-item:last-child {
            border-bottom: none;
        }
        
        .btn-import {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-import:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-import:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .warning-box h4 {
            color: #856404;
            margin-top: 0;
        }
        
        .warning-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }
    </style>
</head>
<body class="bg-blue">
    <!-- CORPORATE HEADER -->
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            <div>
                <h1>PPAP Master Track System</h1>
                <div class="subtitle">SMP Engine Management, S. de R.L. de C.V</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">üë§ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>

    <header><h1>Bulk Data Import</h1></header>

    <div class="import-container">
        <div class="import-header">
            <h2>üì¶ Import JSON Data to Firebase</h2>
            <p>Upload your JSON file to import PPAP records in bulk</p>
        </div>

        <div class="warning-box">
            <h4>‚ö†Ô∏è Important Notes:</h4>
            <ul>
                <li>Only JSON files (.json) are accepted</li>
                <li>Data will be mapped according to the field mapping configuration</li>
                <li>Each import will be logged in the activity history</li>
                <li>Duplicates (by Item #) will be skipped</li>
                <li>Only admin users can perform bulk imports</li>
            </ul>
        </div>

        <div class="file-upload-area" id="dropArea">
            <div style="font-size: 48px; margin-bottom: 10px;">üìÑ</div>
            <h3 style="color: #003366; margin: 10px 0;">Drop JSON file here</h3>
            <p style="color: #7f8c8d;">or click to select</p>
            <input type="file" id="fileInput" accept=".json" style="display: none;">
        </div>

        <div class="file-info" id="fileInfo">
            <strong>File loaded:</strong> <span id="fileName"></span><br>
            <strong>Records found:</strong> <span id="recordCount">0</span>
        </div>

        <div class="mapping-preview" id="mappingPreview">
            <h4 style="margin-top: 0; color: #003366;">üìã Field Mapping Preview:</h4>
            <div id="mappingList"></div>
        </div>

        <div class="progress-container" id="progressContainer">
            <h4 style="color: #003366;">Import Progress:</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div style="text-align: center; color: #7f8c8d; font-size: 14px;" id="progressText">
                Preparing...
            </div>
        </div>

        <div class="log-area" id="logArea"></div>

        <button class="btn-import" id="btnImport" disabled>
            START IMPORT
        </button>

        <button onclick="location.href='index.html'" style="width:100%; margin-top:10px; padding:12px; background:#95a5a6; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
            BACK TO HOME
        </button>
    </div>

    <!-- CORPORATE FOOTER -->
    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">¬© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Show current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        
        // Check authentication and permissions
        const user = checkAuth();
        if(user) {
            document.getElementById('current-user-display').textContent = `üë§ ${user.usuario}`;
        }

        // Only admin can import
        if(!user || user.usuario !== 'admin') {
            alert("‚ùå Access denied. Only administrator can perform bulk imports.");
            window.location.href = "index.html";
        }

        // FIELD MAPPING - Maps JSON fields to Firebase fields
        const FIELD_MAPPING = {
            "Item #": "Item #",
            "PPAP Part Number": "PPAP Part Number",
            "Component description ": "Component description",
            "Reason for Change": "Reason for Change",
            "Product type": "Product type",
            "PRP5/Area": "PRP5/Area",
            "OE/AFTERMARKET": "OE/AFTERMARKET",
            "documentation": "documentation",
            "Samples received": "Samples received",
            "Location ": "Location",
            "Dimensional": "Dimensional",
            "Special instruccions": "Special instruccions",
            "Validation date  ": "Validation date",
            "Programmer ": "Programmer",
            "Quality Lead ": "Quality Lead",
            "Reason ": "Reason",
            "Comments(detalle)": "Comments(detalle)",
            "Responsible ": "Responsible",
            "Estatus": "Estatus",
            "PPAP type \n\nOE / SM\nAfter Market": "PPAP type OE / SM\nAfter Market",
            "1\nDesign records": "1 Design records",
            "2\nECN document": "2\nECN document",
            "3\nCustomer eng approval": "3\nCustomer eng approval",
            "4\nDesign FMEA": "4\nDesign FMEA",
            "5\nProcess Flow Diagram": "5\nProcess Flow Diagram",
            "6\nPFMEA": "6\nPFMEA",
            "7\nControl Plan": "7\nControl Plan",
            "8\nMSA Studies": "8\nMSA Studies",
            "9\nDimensional results": "9\nDimensional results",
            "10\nMaterial, performance test result": "10\nMaterial, performance test result",
            "11\nInitial Process Studies": "11\nInitial Process Studies",
            "12\nQualify Lab Documentation": "12\nQualify Lab Documentation",
            "13\nAppereance Approval Report": "13\nAppereance Approval Report",
            "14\nSample product": "14\nSample product",
            "15\nChecking Aids": "15\nChecking Aids",
            "16\nRecord of compliance": "16\nRecord of compliance",
            "17\nBulk material checklist": "17\nBulk material checklist",
            "18\nPSW\n(Full or Interim)": "18\nPSW\n(Full or Interim)",
            "Supplier PPAP package status": "Supplier PPAP package status",
            "Validation run readiness": "Validation run readiness",
            "Samples on hand": "Samples on hand",
            "Dimension status": "Dimension status",
            "FFF review status": "FFF review status",
            "AAR review status": "AAR review status",
            "PPAP overall status": "PPAP overall status"
        };

        let jsonData = null;
        let validRecords = [];

        // Elements
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const recordCount = document.getElementById('recordCount');
        const mappingPreview = document.getElementById('mappingPreview');
        const mappingList = document.getElementById('mappingList');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const logArea = document.getElementById('logArea');
        const btnImport = document.getElementById('btnImport');

        // Logging function
        function log(message, type = 'info') {
            logArea.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(line);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // Drag and drop handlers
        dropArea.onclick = () => fileInput.click();

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.onchange = (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        };

        // Handle file upload
        function handleFile(file) {
            if (!file.name.endsWith('.json')) {
                alert('‚ùå Please select a valid JSON file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    jsonData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(jsonData)) {
                        alert('‚ùå JSON file must contain an array of objects');
                        return;
                    }

                    fileName.textContent = file.name;
                    recordCount.textContent = jsonData.length;
                    fileInfo.style.display = 'block';

                    // Show mapping preview
                    showMappingPreview();

                    // Validate and prepare records
                    prepareRecords();

                    btnImport.disabled = false;
                    log(`‚úÖ File loaded: ${file.name} with ${jsonData.length} records`, 'success');

                } catch (error) {
                    alert('‚ùå Error reading JSON file: ' + error.message);
                    log(`‚ùå Error: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Show mapping preview
        function showMappingPreview() {
            mappingPreview.style.display = 'block';
            mappingList.innerHTML = '';

            const sampleRecord = jsonData[0];
            const mappedFields = [];

            for (const [jsonField, fbField] of Object.entries(FIELD_MAPPING)) {
                if (sampleRecord.hasOwnProperty(jsonField)) {
                    const item = document.createElement('div');
                    item.className = 'mapping-item';
                    item.innerHTML = `
                        <span style="color: #7f8c8d;">${jsonField}</span>
                        <span style="color: #27ae60;">‚Üí ${fbField}</span>
                    `;
                    mappingList.appendChild(item);
                    mappedFields.push(jsonField);
                }
            }

            log(`üìã ${mappedFields.length} fields will be mapped`, 'info');
        }

        // Prepare and validate records
        function prepareRecords() {
            validRecords = [];
            let skipped = 0;

            for (const record of jsonData) {
                // Check if Item # exists
                if (!record["Item #"]) {
                    skipped++;
                    continue;
                }

                // Map fields
                const mappedRecord = {};
                for (const [jsonField, fbField] of Object.entries(FIELD_MAPPING)) {
                    if (record.hasOwnProperty(jsonField)) {
                        // Convert to string and trim if it's a string
                        let value = record[jsonField];
                        if (typeof value === 'string') {
                            value = value.trim();
                        } else if (typeof value === 'number') {
                            value = value.toString();
                        }
                        mappedRecord[fbField] = value || "";
                    } else {
                        mappedRecord[fbField] = "";
                    }
                }

                validRecords.push(mappedRecord);
            }

            if (skipped > 0) {
                log(`‚ö†Ô∏è ${skipped} records skipped (missing Item #)`, 'warning');
            }

            log(`‚úÖ ${validRecords.length} valid records ready to import`, 'success');
        }

        // Check if record already exists
        async function recordExists(itemNumber) {
            const q = query(collection(db, "productos"), where("Item #", "==", itemNumber));
            const snap = await getDocs(q);
            return !snap.empty;
        }

        // Import data
        btnImport.onclick = async () => {
            if (!validRecords || validRecords.length === 0) {
                alert('‚ùå No valid records to import');
                return;
            }

            if (!confirm(`‚ö†Ô∏è You are about to import ${validRecords.length} records.\n\nThis action cannot be undone. Continue?`)) {
                return;
            }

            btnImport.disabled = true;
            progressContainer.style.display = 'block';
            
            let imported = 0;
            let skipped = 0;
            let errors = 0;

            log(`üöÄ Starting import of ${validRecords.length} records...`, 'info');

            for (let i = 0; i < validRecords.length; i++) {
                const record = validRecords[i];
                const progress = Math.round(((i + 1) / validRecords.length) * 100);
                
                progressFill.style.width = progress + '%';
                progressFill.textContent = progress + '%';
                progressText.textContent = `Processing ${i + 1} of ${validRecords.length}...`;

                try {
                    // Check if already exists
                    const exists = await recordExists(record["Item #"]);
                    
                    if (exists) {
                        log(`‚ö†Ô∏è Skipped ${record["Item #"]} - already exists`, 'warning');
                        skipped++;
                        continue;
                    }

                    // Add to Firebase
                    await addDoc(collection(db, "productos"), record);
                    
                    // Log the import
                    await addDoc(collection(db, "movimientos"), {
                        usuario: user.usuario,
                        accion: "Bulk Import",
                        detalle: `Item: ${record["Item #"]} | PPAP: ${record["PPAP Part Number"]}`,
                        fecha: serverTimestamp()
                    });

                    imported++;
                    log(`‚úÖ Imported: ${record["Item #"]} - ${record["PPAP Part Number"]}`, 'success');

                } catch (error) {
                    errors++;
                    log(`‚ùå Error importing ${record["Item #"]}: ${error.message}`, 'error');
                }

                // Small delay to avoid overwhelming Firebase
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Final summary
            progressText.textContent = 'Import completed!';
            log(`\n========================================`, 'info');
            log(`üìä IMPORT SUMMARY:`, 'info');
            log(`‚úÖ Successfully imported: ${imported}`, 'success');
            log(`‚ö†Ô∏è Skipped (duplicates): ${skipped}`, 'warning');
            log(`‚ùå Errors: ${errors}`, 'error');
            log(`========================================\n`, 'info');

            alert(`‚úÖ Import completed!\n\n‚úÖ Imported: ${imported}\n‚ö†Ô∏è Skipped: ${skipped}\n‚ùå Errors: ${errors}`);
            
            btnImport.textContent = 'IMPORT COMPLETED ‚úì';
        };
    </script>
</body>
</html>