<script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. Verificamos que el script cargue
        console.log("Script de Consultas: CARGADO");

        // Verificamos autenticación
        const user = checkAuth();
        if (!user) {
             console.log("Usuario no autenticado, redirigiendo...");
             // Si checkAuth no redirige solo, forzamos:
             // window.location.href = 'login.html'; 
        }

        const scriptURL = "https://script.google.com/macros/s/AKfycbz-zqhnPq-ZCVv1miDE8lF6WkKfTrw4KMj2ikRm8ZYkncyOpSG0VAqEkbfbnThTIdmb/exec";

        // 2. Asignamos la función al botón con protección de errores
        const btn = document.getElementById('btnSearch');
        
        if (btn) {
            btn.onclick = async () => {
                console.log("Click en botón Consultar detectado");
                
                const val = document.getElementById('term').value.trim();
                if(!val) return alert("Por favor escribe un número de Item.");

                // Aviso visual de carga
                btn.innerText = "BUSCANDO...";
                btn.disabled = true;

                try {
                    // Consulta a Firebase
                    const q = query(collection(db, "productos"), where("Item #", "==", val));
                    const snap = await getDocs(q);

                    if(snap.empty) { 
                        alert("Ese Item no existe en la base de datos."); 
                        btn.innerText = "CONSULTAR";
                        btn.disabled = false;
                        return; 
                    }

                    const prodData = snap.docs[0].data();
                    const itemID = prodData["Item #"]; // Asegúrate que en Firebase sea "Item #" con espacio
                    
                    document.getElementById('display-title').innerText = "Item: " + itemID;
                    
                    // Llenar datos básicos
                    const camposB = ["PPAP Part Number", "Component Description", "Responsable", "Proceso"];
                    const container = document.getElementById('data-fields');
                    container.innerHTML = '';
                    camposB.forEach(f => {
                        container.innerHTML += `<div><label style="font-size:10px;color:#888;">${f}</label><br><b>${prodData[f]||'-'}</b></div>`;
                    });

                    // Buscar Historial
                    buscarHistorial(itemID);

                } catch (error) {
                    console.error("Error al consultar:", error);
                    alert("Ocurrió un error al consultar la base de datos (revisa la consola F12).");
                } finally {
                    btn.innerText = "CONSULTAR";
                    btn.disabled = false;
                }
            };
        } else {
            console.error("ERROR CRÍTICO: No se encontró el botón con ID 'btnSearch' en el HTML.");
        }

        // Función separada para buscar el historial
        async function buscarHistorial(itemID) {
            const hBody = document.getElementById('history-body');
            hBody.innerHTML = '<tr><td colspan="3">Buscando versiones...</td></tr>';
            
            try {
                // NOTA: Asegúrate que en "actualizar.html" guardas el detalle como "Item: X" (con espacio)
                const qLogs = query(collection(db, "movimientos"), where("detalle", "==", `Item: ${itemID}`), orderBy("fecha", "desc"));
                const logSnap = await getDocs(qLogs);

                hBody.innerHTML = '';
                if(logSnap.empty) {
                    hBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No hay historial de cambios para este item.</td></tr>';
                } else {
                    logSnap.forEach(docLog => {
                        const log = docLog.data();
                        if(!log.fecha) return;

                        const fechaObj = new Date(log.fecha.seconds * 1000);
                        const dia = fechaObj.getDate();
                        const mes = fechaObj.getMonth() + 1;
                        
                        // Generamos nombre: Item_Mes_Dia
                        const nombreArchivoVersion = `${itemID}_${mes}_${dia}`;
                        const statusV = log.statusMomento || "N/A";
                        
                        let claseStatus = 'pendiente';
                        if(statusV.toLowerCase().includes('aprob')) claseStatus = 'aprobado';
                        if(statusV.toLowerCase().includes('rechaz') || statusV.toLowerCase().includes('reject')) claseStatus = 'rechazado';

                        hBody.innerHTML += `
                            <tr>
                                <td>${fechaObj.toLocaleDateString()}</td>
                                <td><span class="status-badge ${claseStatus}">${statusV}</span></td>
                                <td>
                                    <button class="btn-view" onclick="verImagenHistorica('${nombreArchivoVersion}')">
                                        VER FOTO
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
                document.getElementById('content-view').style.display = 'grid';
            } catch (e) {
                console.error("Error historial:", e);
                hBody.innerHTML = '<tr><td colspan="3">Error cargando historial.</td></tr>';
            }
        }

        // Función global para ver imagen (fuera del scope del módulo para que el onclick del HTML la vea)
        window.verImagenHistorica = async (nombreImg) => {
            const imgPreview = document.getElementById('drive-preview');
            const caption = document.getElementById('img-caption');
            
            caption.innerText = "Buscando archivo " + nombreImg + ".jpg ...";
            // Gif de carga de Google
            imgPreview.src = "https://ssl.gstatic.com/docs/doclist/images/icon_10_image_list.png"; 

            try {
                const res = await fetch(`${scriptURL}?itemName=${nombreImg}`);
                const data = await res.json();
                
                if(data.result === "success") {
                    // AQUÍ ESTABA EL ERROR ANTES: Se agregó el $
                    imgPreview.src = `https://lh3.googleusercontent.com/d/$${data.id}`;
                    caption.innerHTML = `<span style='color:green'>✔ Encontrado:</span> ${nombreImg}.jpg`;
                } else {
                    imgPreview.src = "imagenes/sin_foto.jpg";
                    caption.innerText = "⚠️ No existe foto para esta versión.";
                }
            } catch(e) {
                console.error(e);
                caption.innerText = "Error de conexión con Drive";
            }
        };
    </script>
</body>
</html>