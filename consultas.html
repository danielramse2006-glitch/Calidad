<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Consultas de Versiones - Master Track</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .search-box { background: white; padding: 20px; border-radius: 10px; display: flex; gap: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .main-grid { display: grid; grid-template-columns: 1fr 450px; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .history-table th { background: #2c3e50; color: white; text-align: left; padding: 10px; }
        .history-table td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .image-viewer { text-align: center; background: #f9f9f9; border: 2px solid #3498db; border-radius: 10px; padding: 10px; }
        #drive-preview { width: 100%; height: 350px; object-fit: contain; border-radius: 5px; background: #000; border: 1px solid #ddd; }
        #img-caption { font-size: 13px; color: #2c3e50; margin-top: 8px; font-weight: bold; background: #ebf5fb; padding: 5px; border-radius: 4px; }

        .btn-view { background: #3498db; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; font-size: 11px; }
        .status-badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .aprobado { background: #d4edda; color: #155724; }
        .rechazado { background: #f8d7da; color: #721c24; }
        .pendiente { background: #fff3cd; color: #856404; }
    </style>
</head>
<body class="bg-blue">
    <div style="max-width: 1200px; margin: 30px auto; padding: 0 20px;">
        <h2 style="color: white; text-align: center;">Historial de Versiones e Imágenes</h2>
        
        <div class="search-box">
            <input type="text" id="term" placeholder="Buscar Item # (ej: 2pp)..." style="flex:1; padding:12px; border:1px solid #ddd; border-radius:5px;">
            <button id="btnSearch" style="padding:12px 25px; background:#2ecc71; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">CONSULTAR</button>
            <button onclick="location.href='index.html'" style="padding:12px; background:#95a5a6; color:white; border:none; border-radius:5px; cursor:pointer;">VOLVER</button>
        </div>

        <div id="content-view" style="display:none;" class="main-grid">
            <div class="card">
                <h3 id="display-title" style="margin-top:0; color:#2c3e50; border-bottom:2px solid #eee; padding-bottom:10px;"></h3>
                <div id="data-fields" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;"></div>
            </div>

            <div class="card">
                <div class="image-viewer">
                    <img id="drive-preview" src="imagenes/sin_foto.jpg">
                    <div id="img-caption">Imagen de la versión</div>
                </div>
                
                <h4 style="margin: 20px 0 10px 0; color:#3498db;">Versiones Guardadas</h4>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Status PPAP</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        checkAuth();
        const scriptURL = "https://script.google.com/macros/s/AKfycbz-zqhnPq-ZCVv1miDE8lF6WkKfTrw4KMj2ikRm8ZYkncyOpSG0VAqEkbfbnThTIdmb/exec";

        document.getElementById('btnSearch').onclick = async () => {
            const val = document.getElementById('term').value.trim();
            if(!val) return;

            const q = query(collection(db, "productos"), where("Item #", "==", val));
            const snap = await getDocs(q);
            if(snap.empty) { alert("Item no encontrado"); return; }

            const prodData = snap.docs[0].data();
            const itemID = prodData["Item #"];
            document.getElementById('display-title').innerText = "Item: " + itemID;
            
            // Llenar datos básicos
            const camposB = ["PPAP Part Number", "Component Description", "Responsable", "Proceso"];
            const container = document.getElementById('data-fields');
            container.innerHTML = '';
            camposB.forEach(f => {
                container.innerHTML += `<div><label style="font-size:10px;color:#888;">${f}</label><br><b>${prodData[f]||'-'}</b></div>`;
            });

            // Buscar Historial
            const hBody = document.getElementById('history-body');
            hBody.innerHTML = '<tr><td colspan="3">Buscando versiones...</td></tr>';
            
            const qLogs = query(collection(db, "movimientos"), where("detalle", "==", `Item: ${itemID}`), orderBy("fecha", "desc"));
            const logSnap = await getDocs(qLogs);

            hBody.innerHTML = '';
            if(logSnap.empty) {
                hBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No hay historial para este item.</td></tr>';
            } else {
                logSnap.forEach(docLog => {
                    const log = docLog.data();
                    if(!log.fecha) return;

                    const fechaObj = new Date(log.fecha.seconds * 1000);
                    const dia = fechaObj.getDate();
                    const mes = fechaObj.getMonth() + 1;
                    
                    // --- CORRECCIÓN DE NOMBRE: Mismo formato que en actualizar (Item_Mes_Dia) ---
                    const nombreArchivoVersion = `${itemID}_${mes}_${dia}`;
                    const statusV = log.statusMomento || "N/A";
                    
                    let claseStatus = 'pendiente';
                    if(statusV.toLowerCase().includes('aprob')) claseStatus = 'aprobado';
                    if(statusV.toLowerCase().includes('rechaz') || statusV.toLowerCase().includes('reject')) claseStatus = 'rechazado';

                    hBody.innerHTML += `
                        <tr>
                            <td>${fechaObj.toLocaleDateString()}</td>
                            <td><span class="status-badge ${claseStatus}">${statusV}</span></td>
                            <td>
                                <button class="btn-view" onclick="verImagenHistorica('${nombreArchivoVersion}')">
                                    VER FOTO
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            document.getElementById('content-view').style.display = 'grid';
        };

        window.verImagenHistorica = async (nombreImg) => {
            const imgPreview = document.getElementById('drive-preview');
            const caption = document.getElementById('img-caption');
            
            caption.innerText = "Buscando archivo " + nombreImg + ".jpg...";
            imgPreview.src = "imagenes/sin_foto.jpg"; // Placeholder

            try {
                const res = await fetch(`${scriptURL}?itemName=${nombreImg}`);
                const data = await res.json();
                if(data.result === "success") {
                    // --- CORRECCIÓN URL: Agregado el $ y url segura ---
                    imgPreview.src = `https://lh3.googleusercontent.com/d/${data.id}`;
                    caption.innerHTML = `<span style='color:green'>✔ Encontrado:</span> ${nombreImg}.jpg`;
                } else {
                    caption.innerText = "⚠️ No existe foto para esta fecha/versión.";
                }
            } catch(e) {
                console.error(e);
                caption.innerText = "Error de conexión con Drive";
            }
        };
    </script>
</body>
</html>