<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Comments - Master Track</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .bg-blue { background-color: #f0f7ff; min-height: 100vh; }
        
        .main-container {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .search-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-section input {
            flex: 1;
            padding: 12px;
            border: 2px solid #3498db;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .search-section button {
            padding: 12px 25px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .item-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #3498db;
            display: none;
        }
        
        .fields-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .field-group {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .field-group label {
            font-size: 11px;
            color: #666;
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .field-group input,
        .field-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }
        
        .field-group .readonly-field {
            background: #f0f0f0;
            color: #666;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
            font-size: 13px;
            min-height: 36px;
            display: flex;
            align-items: center;
        }
        
        .comments-field {
            grid-column: span 3;
        }
        
        .comments-field textarea {
            height: 100px;
            resize: vertical;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .action-buttons button {
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        #btnGuardarComentario {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            flex: 3;
        }
        
        #btnCancelar {
            background: #95a5a6;
            color: white;
            flex: 1;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        .vc2-header {
            background: linear-gradient(to right, #003366, #0056a9);
            color: white;
            text-align: center;
            padding: 12px 0;
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 2px;
            margin: 0;
            border-bottom: 3px solid #0099cc;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .vc2-container {
            display: flex;
            justify-content: center;
            width: 100%;
            background: linear-gradient(to right, #003366, #0056a9);
        }
        
        .status-approved { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-inprogress { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body class="bg-blue">
    <!-- CORPORATE HEADER -->
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            <div>
                <h1>PPAP Master Track System</h1>
                <div class="subtitle" style="color: white;">SMP Engine Management, S. de R.L. de C.V</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">üë§ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>
    
    <!-- VC2 M√ÅS CHICO Y CENTRADO - A√ëADIDO AQU√ç -->
    <div class="vc2-container">
        <div class="vc2-header">
            VC2
        </div>
    </div>

    <header><h1>‚úèÔ∏è Edit Comments - Read Only/Limited Edition</h1></header>
    
    <div class="main-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: #2c3e50; margin: 0;">Edit Item Comments</h2>
            <button onclick="location.href='index.html'" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ‚Üê BACK
            </button>
        </div>
        
        <div class="search-section">
            <input type="text" id="searchItem" placeholder="Enter Item # to search (ex: 15)">
            <button id="btnBuscar">üîç SEARCH ITEM</button>
        </div>
        
        <div id="item-info" class="item-info">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0 0 5px 0; color: #2c3e50;">
                        Item: <span id="current-item" style="font-weight: bold;"></span>
                    </h3>
                    <p style="margin: 0; font-size: 13px; color: #666;">
                        PPAP Status: <span id="current-status" class="status-badge status-pending"></span>
                    </p>
                </div>
                <div style="font-size: 11px; color: #95a5a6;">
                    Last update: <span id="last-update"></span>
                </div>
            </div>
        </div>
        
        <div id="fields-container" class="fields-container">
            <!-- Fields generated dynamically here -->
        </div>
        
        <div id="action-buttons" class="action-buttons">
            <button id="btnGuardarComentario">üíæ SAVE COMMENTS</button>
            <button id="btnCancelar">CANCEL</button>
        </div>
        
        <div style="margin-top: 30px; padding: 15px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #3498db;">
            <h4 style="margin: 0 0 10px 0; color: #3498db;">‚ö†Ô∏è Important notes:</h4>
            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #555;">
                <li>Only the <strong>"Comments(detalle)"</strong> field is editable in this view</li>
                <li>Other fields are read-only for reference</li>
                <li>Changes will be recorded in history with your user</li>
                <li>This function requires special "editarComentarios" permission</li>
            </ul>
        </div>
    </div>

    <!-- CORPORATE FOOTER -->
    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">¬© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { db, checkAuth, redirectIfNoPermission } from './config.js';
        import { collection, query, where, getDocs, doc, setDoc, addDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Show current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        
        // Show current user
        const user = checkAuth();
        if(user) {
            document.getElementById('current-user-display').textContent = `üë§ ${user.usuario}`;
        }

        // Verify permission
        if (!redirectIfNoPermission('editarComentarios')) {
            // Already redirects automatically
        }
        
        let currentId = null;
        let itemActual = null;
        
        // DB FIELDS (read only)
        const camposDB = [
            "Item #",
            "Estatus",
            "Programmer", 
            "PPAP Part Number",
            "Component description",
            "Reason for Change",
            "Validation date",
            "PPAP overall status"
        ];
        
        // UI NAMES (replace line breaks with spaces for display)
        const camposUI = camposDB.map(field => field.replace(/\n/g, " "));
        
        // Editable field (DB original)
        const campoEditableDB = "Comments(detalle)";
        // Display name for editable field
        const campoEditableUI = "Comments(detalle)";
        
        // Function to create safe ID
        function createSafeId(fieldName) {
            return fieldName.replace(/\n/g, "_").replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "");
        }
        
        // SEARCH ITEM
        document.getElementById('btnBuscar').onclick = async () => {
            const val = document.getElementById('searchItem').value.trim();
            if(!val) {
                alert("Please enter an Item number");
                return;
            }
            
            const btnBuscar = document.getElementById('btnBuscar');
            btnBuscar.innerHTML = "üîç SEARCHING...";
            btnBuscar.disabled = true;
            
            try {
                const q = query(collection(db, "productos"), where("Item #", "==", val));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    alert("‚ùå Item not found. Check the number.");
                    resetForm();
                    return;
                }
                
                const d = snap.docs[0];
                currentId = d.id;
                const data = d.data();
                itemActual = data["Item #"];
                
                // Show item information
                document.getElementById('item-info').style.display = 'block';
                document.getElementById('current-item').textContent = itemActual;
                
                // Show status
                const currentStatus = data["PPAP overall status"] || "No status";
                const statusElement = document.getElementById('current-status');
                statusElement.textContent = currentStatus;
                
                // Apply color based on status
                statusElement.className = "status-badge ";
                if (currentStatus.toLowerCase().includes("approved") || currentStatus.toLowerCase().includes("aprobado")) {
                    statusElement.classList.add("status-approved");
                } else if (currentStatus.toLowerCase().includes("pending") || currentStatus.toLowerCase().includes("pendiente")) {
                    statusElement.classList.add("status-pending");
                } else if (currentStatus.toLowerCase().includes("rejected") || currentStatus.toLowerCase().includes("rechazado")) {
                    statusElement.classList.add("status-rejected");
                } else {
                    statusElement.classList.add("status-inprogress");
                }
                
                // Find last update
                try {
                    const historyQuery = query(
                        collection(db, "movimientos"),
                        where("detalle", "==", `Item: ${itemActual}`),
                        orderBy("fecha", "desc"),
                        limit(1)
                    );
                    const historySnap = await getDocs(historyQuery);
                    if (!historySnap.empty) {
                        const lastUpdate = historySnap.docs[0].data();
                        const lastDate = lastUpdate.fecha ? 
                            new Date(lastUpdate.fecha.seconds * 1000).toLocaleDateString() : 
                            "Unknown date";
                        document.getElementById('last-update').textContent = lastDate;
                    }
                } catch (historyError) {
                    console.log("Could not get history:", historyError);
                }
                
                // Generate read-only fields
                const container = document.getElementById('fields-container');
                container.innerHTML = '';
                
                camposDB.forEach((campoDB, index) => {
                    const campoUI = camposUI[index] || campoDB;
                    const div = document.createElement('div');
                    div.className = 'field-group';
                    
                    div.innerHTML = `
                        <label>${campoUI}</label>
                        <div class="readonly-field">${data[campoDB] || 'N/A'}</div>
                    `;
                    
                    container.appendChild(div);
                });
                
                // Add editable field for Comments
                const commentsDiv = document.createElement('div');
                commentsDiv.className = 'field-group comments-field';
                commentsDiv.innerHTML = `
                    <label>${campoEditableUI} (EDITABLE)</label>
                    <textarea id="editable-comments" placeholder="Enter comments here...">${data[campoEditableDB] || ''}</textarea>
                `;
                
                container.appendChild(commentsDiv);
                container.style.display = 'grid';
                document.getElementById('action-buttons').style.display = 'flex';
                
            } catch(error) {
                console.error("Error searching:", error);
                alert("Error connecting to database.");
            } finally {
                btnBuscar.innerHTML = "üîç SEARCH ITEM";
                btnBuscar.disabled = false;
            }
        };
        
        // Function to reset form
        function resetForm() {
            document.getElementById('fields-container').innerHTML = '';
            document.getElementById('fields-container').style.display = 'none';
            document.getElementById('action-buttons').style.display = 'none';
            document.getElementById('item-info').style.display = 'none';
            currentId = null;
            itemActual = null;
        }
        
        // Cancel edit
        document.getElementById('btnCancelar').onclick = resetForm;
        
        // SAVE COMMENTS
        document.getElementById('btnGuardarComentario').onclick = async () => {
            if (!currentId) {
                alert("First search for a record to edit");
                return;
            }
            
            const nuevoComentario = document.getElementById('editable-comments').value.trim();
            
            if (!nuevoComentario) {
                if (!confirm("Do you want to leave the comments field empty?")) {
                    return;
                }
            }
            
            if (!confirm("Are you sure you want to update the comments? Changes will be saved in history.")) {
                return;
            }
            
            const btnGuardar = document.getElementById('btnGuardarComentario');
            btnGuardar.innerHTML = "‚è≥ SAVING...";
            btnGuardar.disabled = true;
            
            try {
                // Update only the Comments field
                await setDoc(doc(db, "productos", currentId), {
                    [campoEditableDB]: nuevoComentario
                }, { merge: true });
                
                // Record in history
                await addDoc(collection(db, "movimientos"), {
                    usuario: user.usuario,
                    accion: "Comments Edit",
                    detalle: `Item: ${itemActual}`,
                    comentario: nuevoComentario.substring(0, 100) + (nuevoComentario.length > 100 ? "..." : ""),
                    fecha: serverTimestamp()
                });
                
                alert("‚úÖ Comments updated successfully");
                // Reload data to see changes
                document.getElementById('btnBuscar').click();
            } catch(e) { 
                console.error("Error updating:", e);
                alert("‚ùå Error updating in database"); 
            } finally {
                btnGuardar.innerHTML = "üíæ SAVE COMMENTS";
                btnGuardar.disabled = false;
            }
        };
        
        // Allow search with Enter
        document.getElementById('searchItem').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('btnBuscar').click();
            }
        });
        
        // Focus on search field on load
        window.addEventListener('load', function() {
            document.getElementById('searchItem').focus();
        });
    </script>
</body>
</html>