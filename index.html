<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Master Track - Index</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <style>
        /* --- ESTILOS DEL VISOR INFERIOR QUE ME PASASTE --- */
        .bottom-preview {
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            border: 3px solid #3498db;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 30px;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
        }

        .preview-image-box {
            flex: 0 0 300px;
            text-align: center;
        }

        #main-preview-img {
            max-width: 100%;
            max-height: 350px; 
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .preview-info-box {
            flex: 1;
            color: #2c3e50;
        }

        .preview-info-box h2 {
            margin: 0 0 10px 0;
            color: #3498db;
            border-bottom: 2px solid #3498db;
            display: inline-block;
        }

        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        /* Estilo para el bot贸n de admin */
        #btnUsuarios { background: #f1c40f; color: #333; display: none; }
        
        .loading-text { font-size: 10px; color: #3498db; font-style: italic; display: block; margin-top: 5px; }
    </style>
</head>
<body class="bg-blue">
    <header><h1>PPAP Master Track System</h1></header>
    <div class="main-container">
        <nav class="side-menu">
            <button id="btnUsuarios" onclick="location.href='usuarios.html'">锔 GESTIN USUARIOS</button>
            <button onclick="location.href='registro.html'">Registrar</button>
            <button onclick="location.href='actualizar.html'">Actualizar</button>
            <button onclick="location.href='eliminar.html'">Eliminar</button>
            <button id="btnSalir" style="background: #c0392b; color: white; margin-top: 20px; border:none; cursor:pointer; padding:14px; border-radius:8px;">CERRAR SESIN</button>
        </nav>
        <section class="content" style="flex:1; display: flex; flex-direction: column;">
            <input type="text" id="mainSearch" placeholder="Buscar por Item # o No. Parte..." style="width:100%; padding:12px; margin-bottom:15px; border-radius:5px; border:none;">
            
            <div class="table-wrapper">
                <table id="tabla-prod">
                    <thead><tr id="table-head"></tr></thead>
                    <tbody id="inventory-body"></tbody>
                </table>
            </div>

            <div class="bottom-preview">
                <div class="preview-image-box">
                    <span id="status-drive" class="loading-text"></span>
                    <img id="main-preview-img" src="imagenes/sin_foto.jpg" alt="Vista previa">
                    <div style="margin-top:10px; padding:5px; background:#f8f9fa; border-radius:5px; font-size:10px;">
                        <input type="file" id="fileDrive" style="width:100%;">
                        <button id="btnSubirDrive" style="width:100%; margin-top:5px; background:#3498db; color:white; border:none; border-radius:3px; cursor:pointer;">SUBIR A DRIVE</button>
                    </div>
                </div>
                <div class="preview-info-box">
                    <p style="text-transform: uppercase; font-size: 0.8em; font-weight: bold; color: #7f8c8d; margin-bottom: 5px;">Detalles del registro seleccionado:</p>
                    <h2 id="prod-name-display">Selecciona un registro</h2>
                    <p id="prod-detail-display" style="font-size: 1.1em; line-height: 1.5;">Pasa el mouse sobre la tabla para ver la imagen y detalles r谩pidos.</p>
                </div>
            </div>
        </section>
    </div>

    <div id="modalReporte" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; overflow-y:auto;">
        <div style="background:white; width:95%; max-width:900px; margin:20px auto; padding:30px; border-radius:10px;">
            <div id="reporte-print-area" style="padding:10px; background:white; color: black !important; font-family: Arial, sans-serif;">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid #2c3e50; padding-bottom:10px; margin-bottom:20px;">
                    <h2 style="margin:0; color:#2c3e50;">REPORTE TCNICO PPAP</h2>
                    <span style="font-weight:bold; color:#7f8c8d;">MASTER TRACK SYSTEM</span>
                </div>
                <div style="display:flex; gap:25px; margin-bottom:20px;">
                    <div style="flex:0 0 250px;">
                        <img id="rep-img" crossorigin="anonymous" style="width:100%; height:250px; object-fit:contain; border:1px solid #dee2e6; border-radius:5px; background:#f8f9fa;">
                    </div>
                    <div style="flex:1;">
                        <h4 style="background:#2c3e50; color:white; padding:8px; margin:0 0 10px 0; border-radius:3px;">INFORMACIN GENERAL</h4>
                        <div id="rep-data-main" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:12px;"></div>
                    </div>
                </div>
                <h4 style="background:#2c3e50; color:white; padding:8px; margin:20px 0 10px 0; border-radius:3px;">ESTADO DE DOCUMENTACIN Y VALIDACIN</h4>
                <div id="rep-data-ppap" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; font-size:10px;"></div>
            </div>
            <div style="display:flex; gap:15px; margin-top:30px; border-top:1px solid #eee; padding-top:20px;">
                <button id="btnDescargarPDF" style="flex:2; padding:15px; background:#2980b9; color:white; font-weight:bold; border:none; border-radius:8px; cursor:pointer; font-size:16px;"> DESCARGAR REPORTE PDF</button>
                <button onclick="document.getElementById('modalReporte').style.display='none'" style="flex:1; padding:15px; background:#e74c3c; color:white; border:none; border-radius:8px; cursor:pointer;">CERRAR</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const user = checkAuth();
        // Mostrar bot贸n de usuarios solo si es admin
        if(user && user.usuario === 'admin') {
            document.getElementById('btnUsuarios').style.display = 'block';
        }

        const scriptURL = "https://script.google.com/macros/s/AKfycbxaEtN66UYbSOO57Wm9HPrjv7IyfzV8Q3cyZgvDKkKcC8PTohwGaLhznjI3AfP2VTLS/exec";

        const campos = ["Item #","Estatus","Programador","PPAP Part Number","Component Description","Razon de Cambio","PRP5/area","Lider de Calidad"," OE/AFTERMARKET ","Se entrego documentacion","Muestras Recibidas","Ubicacion Fisica ","Fecha de Programacion","Proceso","Update","Comments","Responsable","Instrucciones Especiales","PPAP Type OE / SM AFTER Market","PV Result","1-Design records","2-ECN document","3-Customer eng approval","4-Design FMEA","5-Process Flow Diagram","6-PFMEA","7-Control Plan","8-MSA Studies","9-Dimensional results","10-Material, performance test result","11-Initial Process Studies","12-Qualify Lab Documentation","13-Appereance Approval Report","14-Sample product","15-Checking Aids","16-Record de compliance","17-Bulk material checklist","18-PSW(Full or Interim)","Supplier PPAP package status","Validation run readiness","Samples on hand","Dimension status","FFF review status","AAR review status","PPAP overall status"];
        
        const head = document.getElementById('table-head');
        campos.forEach(c => head.innerHTML += `<th>${c.toUpperCase()}</th>`);
        head.innerHTML += `<th>ACCIONES</th>`;

        let productosLocal = [];

        onSnapshot(collection(db, "productos"), (snap) => {
            productosLocal = [];
            snap.forEach(doc => productosLocal.push(doc.data()));
            renderTable(productosLocal);
        });

        function renderTable(lista) {
            const tbody = document.getElementById('inventory-body');
            tbody.innerHTML = '';
            lista.forEach(p => {
                const tr = document.createElement('tr');
                
                // EVENTO MOUSE ENTER (VISOR)
                tr.onmouseenter = async () => {
                    const itemID = p["Item #"] || "sin_id";
                    const imgPreview = document.getElementById('main-preview-img');
                    const nameDisplay = document.getElementById('prod-name-display');
                    const detailDisplay = document.getElementById('prod-detail-display');
                    const statusDrive = document.getElementById('status-drive');
                    
                    nameDisplay.innerText = `Item: ${itemID}`;
                    detailDisplay.innerHTML = `
                        <b>N煤mero de Parte:</b> ${p["PPAP Part Number"] || '-'} <br>
                        <b>Descripci贸n:</b> ${p["Component Description"] || '-'} <br>
                        <b>Estatus:</b> ${p["Estatus"] || '-'} <br>
                        <b>Responsable:</b> ${p["Responsable"] || '-'}
                    `;

                    // BUSCAR EN DRIVE AL PASAR EL MOUSE
                    statusDrive.innerText = "Buscando en Drive...";
                    try {
                        const res = await fetch(`${scriptURL}?itemName=${itemID}`);
                        const data = await res.json();
                        if(data.result === "success") {
                            imgPreview.src = `https://lh3.googleusercontent.com/u/0/d/${data.id}`;
                            statusDrive.innerText = "Foto de Drive";
                        } else {
                            imgPreview.src = `imagenes/${itemID}.jpg`;
                            imgPreview.onerror = () => { imgPreview.src = 'imagenes/sin_foto.jpg'; };
                            statusDrive.innerText = "Local/Sin foto";
                        }
                    } catch (e) {
                        imgPreview.src = `imagenes/${itemID}.jpg`;
                        imgPreview.onerror = () => { imgPreview.src = 'imagenes/sin_foto.jpg'; };
                        statusDrive.innerText = "";
                    }

                    // Funci贸n para el bot贸n de subida
                    document.getElementById('btnSubirDrive').onclick = () => subirAFirebase(p);
                };

                campos.forEach(c => {
                    tr.innerHTML += `<td>${p[c] || '-'}</td>`;
                });

                const tdBtn = document.createElement('td');
                const btn = document.createElement('button');
                btn.innerText = "VER REPORTE";
                btn.style = "background:#27ae60; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;";
                btn.onclick = () => abrirReporte(p);
                tdBtn.appendChild(btn);
                tr.appendChild(tdBtn);

                tbody.appendChild(tr);
            });
        }

        async function subirAFirebase(p) {
            const file = document.getElementById('fileDrive').files[0];
            if(!file) return alert("Selecciona una foto");
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                const btn = document.getElementById('btnSubirDrive');
                btn.innerText = "SUBIENDO..."; btn.disabled = true;
                try {
                    const res = await fetch(scriptURL, { 
                        method: "POST", 
                        body: JSON.stringify({ itemName: p["Item #"], imageB64: base64 }) 
                    });
                    const data = await res.json();
                    if(data.result === "success") {
                        alert("隆Foto guardada en Drive!");
                        btn.innerText = "SUBIR A DRIVE"; btn.disabled = false;
                    }
                } catch(e) { alert("Error al subir"); btn.disabled = false; }
            };
        }

        function abrirReporte(p) {
            const modal = document.getElementById('modalReporte');
            const img = document.getElementById('rep-img');
            const rDataMain = document.getElementById('rep-data-main');
            const rDataPpap = document.getElementById('rep-data-ppap');
            
            rDataMain.innerHTML = '';
            rDataPpap.innerHTML = '';

            campos.forEach((key, index) => {
                const val = p[key] || '-';
                const itemHtml = `<div style="border-bottom:1px solid #f1f1f1; padding:4px 0;">
                                    <span style="color:#7f8c8d; font-weight:bold; display:block; font-size:9px; text-transform:uppercase;">${key}</span>
                                    <span style="color:#2c3e50;">${val}</span>
                                  </div>`;
                if(index < 14) rDataMain.innerHTML += itemHtml;
                else rDataPpap.innerHTML += itemHtml;
            });

            // Usamos la misma imagen que est茅 en el visor en ese momento
            img.src = document.getElementById('main-preview-img').src;
            modal.style.display = 'block';
        }

        document.getElementById('mainSearch').oninput = (e) => {
            const t = e.target.value.toLowerCase();
            const filtrados = productosLocal.filter(p => 
                (p["Item #"] || '').toString().toLowerCase().includes(t) || 
                (p["PPAP Part Number"] || '').toLowerCase().includes(t)
            );
            renderTable(filtrados);
        };

        document.getElementById('btnDescargarPDF').onclick = function() {
            const element = document.getElementById('reporte-print-area');
            html2pdf().set({
                margin: [10, 10],
                filename: 'Reporte_PPAP.pdf',
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(element).save();
        };

        document.getElementById('btnSalir').onclick = () => { sessionStorage.clear(); window.location.href = "login.html"; };
    </script>
</body>
</html>
