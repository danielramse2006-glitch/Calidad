<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Master Track - Index</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <style>
        .bottom-preview {
            margin-top: 20px; background: white; border-radius: 12px;
            border: 3px solid #3498db; padding: 20px; display: flex;
            align-items: center; gap: 30px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
        }
        .preview-image-box { flex: 0 0 300px; text-align: center; }
        #main-preview-img { max-width: 100%; max-height: 350px; object-fit: contain; border-radius: 8px; border: 1px solid #eee; }
        .preview-info-box { flex: 1; color: #2c3e50; }
        .preview-info-box h2 { margin: 0 0 10px 0; color: #3498db; border-bottom: 2px solid #3498db; display: inline-block; }
        .table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; }
        #btnUsuarios { background: #f1c40f; color: #333; display: none; }
        /* Bot√≥n Historial */
        #btnHistorial { background: #8e44ad; color: white; display: none; }
        .loading-text { font-size: 10px; color: #3498db; font-style: italic; display: block; margin-top: 5px; }
        #upload-container { display: none; margin-top:10px; padding:5px; background:#f8f9fa; border-radius:5px; font-size:10px; }
    </style>
</head>
<body class="bg-blue">
    <header><h1>PPAP Master Track System</h1></header>
    <div class="main-container">
        <nav class="side-menu">
            <button id="btnUsuarios" onclick="location.href='usuarios.html'">‚öôÔ∏è GESTI√ìN USUARIOS</button>
            <button id="btnHistorial" onclick="location.href='historial.html'">üìã HISTORIAL</button>
            <button onclick="location.href='registro.html'">Registrar</button>
            <button onclick="location.href='actualizar.html'">Actualizar</button>
            <button onclick="location.href='eliminar.html'">Eliminar</button>
            <button id="btnSalir" style="background: #c0392b; color: white; margin-top: 20px; border:none; cursor:pointer; padding:14px; border-radius:8px;">CERRAR SESI√ìN</button>
        </nav>
        <section class="content" style="flex:1; display: flex; flex-direction: column;">
            <input type="text" id="mainSearch" placeholder="Buscar por Item # o No. Parte..." style="width:100%; padding:12px; margin-bottom:15px; border-radius:5px; border:none;">
            <div class="table-wrapper">
                <table id="tabla-prod">
                    <thead><tr id="table-head"></tr></thead>
                    <tbody id="inventory-body"></tbody>
                </table>
            </div>
            <div class="bottom-preview">
                <div class="preview-image-box">
                    <span id="status-drive" class="loading-text"></span>
                    <img id="main-preview-img" src="imagenes/sin_foto.jpg" alt="Vista previa">
                    <div id="upload-container">
                        <input type="file" id="fileDrive" style="width:100%;">
                        <button id="btnSubirDrive" style="width:100%; margin-top:5px; background:#3498db; color:white; border:none; border-radius:3px; cursor:pointer;">SUBIR A DRIVE</button>
                    </div>
                </div>
                <div class="preview-info-box">
                    <p style="text-transform: uppercase; font-size: 0.8em; font-weight: bold; color: #7f8c8d; margin-bottom: 5px;">Detalles del registro seleccionado:</p>
                    <h2 id="prod-name-display">Selecciona un registro</h2>
                    <p id="prod-detail-display" style="font-size: 1.1em; line-height: 1.5;">Haz clic en una fila para ver detalles.</p>
                </div>
            </div>
        </section>
    </div>

    <script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const user = checkAuth();
        
        // --- CONTROL DE PERMISOS ---
        if(user) {
            if(user.usuario === 'admin') {
                document.getElementById('btnUsuarios').style.display = 'block';
                document.getElementById('btnHistorial').style.display = 'block'; // Mostrar historial solo admin
            }
            if(user.usuario === 'admin' || (user.permisos && user.permisos.subirDrive)) {
                document.getElementById('upload-container').style.display = 'block';
            }
        }

        const scriptURL = "https://script.google.com/macros/s/AKfycbxaEtN66UYbSOO57Wm9HPrjv7IyfzV8Q3cyZgvDKkKcC8PTohwGaLhznjI3AfP2VTLS/exec";
        const campos = ["Item #","Estatus","Programador","PPAP Part Number","Component Description","Razon de Cambio","PRP5/area","Lider de Calidad"," OE/AFTERMARKET ","Se entrego documentacion","Muestras Recibidas","Ubicacion Fisica ","Fecha de Programacion","Proceso","Update","Comments","Responsable","Instrucciones Especiales","PPAP Type OE / SM AFTER Market","PV Result","1-Design records","2-ECN document","3-Customer eng approval","4-Design FMEA","5-Process Flow Diagram","6-PFMEA","7-Control Plan","8-MSA Studies","9-Dimensional results","10-Material, performance test result","11-Initial Process Studies","12-Qualify Lab Documentation","13-Appereance Approval Report","14-Sample product","15-Checking Aids","16-Record de compliance","17-Bulk material checklist","18-PSW(Full or Interim)","Supplier PPAP package status","Validation run readiness","Samples on hand","Dimension status","FFF review status","AAR review status","PPAP overall status"];
        const head = document.getElementById('table-head');
        campos.forEach(c => head.innerHTML += `<th>${c.toUpperCase()}</th>`);
        head.innerHTML += `<th>ACCIONES</th>`;

        let productosLocal = [];

        onSnapshot(collection(db, "productos"), (snap) => {
            productosLocal = [];
            snap.forEach(doc => productosLocal.push(doc.data()));
            renderTable(productosLocal);
        });

        function renderTable(lista) {
            const tbody = document.getElementById('inventory-body');
            tbody.innerHTML = '';
            lista.forEach(p => {
                const tr = document.createElement('tr');
                tr.style.cursor = "pointer";
                tr.onclick = async () => {
                    const itemID = p["Item #"] || "sin_id";
                    const imgPreview = document.getElementById('main-preview-img');
                    const nameDisplay = document.getElementById('prod-name-display');
                    const detailDisplay = document.getElementById('prod-detail-display');
                    const statusDrive = document.getElementById('status-drive');
                    
                    nameDisplay.innerText = `Item: ${itemID}`;
                    detailDisplay.innerHTML = `<b>No. Parte:</b> ${p["PPAP Part Number"]||'-'} <br> <b>Desc:</b> ${p["Component Description"]||'-'} <br> <b>Estatus:</b> ${p["Estatus"]||'-'} <br> <b>Resp:</b> ${p["Responsable"]||'-'}`;
                    statusDrive.innerText = "Buscando en Drive...";
                    try {
                        const res = await fetch(`${scriptURL}?itemName=${itemID}`);
                        const data = await res.json();
                        if(data.result === "success") {
                            imgPreview.src = `https://lh3.googleusercontent.com/u/0/d/${data.id}`;
                            statusDrive.innerText = "Foto de Drive";
                        } else {
                            imgPreview.src = `imagenes/${itemID}.jpg`;
                            imgPreview.onerror = () => { imgPreview.src = 'imagenes/sin_foto.jpg'; };
                            statusDrive.innerText = "Local/Sin foto";
                        }
                    } catch (e) {
                        imgPreview.src = 'imagenes/sin_foto.jpg'; statusDrive.innerText = "";
                    }
                    const btnSubir = document.getElementById('btnSubirDrive');
                    if(btnSubir) btnSubir.onclick = () => subirAFirebase(p);
                };
                campos.forEach(c => tr.innerHTML += `<td>${p[c]||'-'}</td>`);
                const tdBtn = document.createElement('td');
                const btn = document.createElement('button');
                btn.innerText = "VER REPORTE"; btn.className = "btn-report-row";
                btn.onclick = (e) => { e.stopPropagation(); abrirReporte(p); };
                tdBtn.appendChild(btn); tr.appendChild(tdBtn); tbody.appendChild(tr);
            });
        }

        async function subirAFirebase(p) {
            const fileInput = document.getElementById('fileDrive');
            const file = fileInput.files[0];
            if(!file) return alert("Selecciona una foto primero");
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                const btn = document.getElementById('btnSubirDrive');
                btn.innerText = "SUBIENDO..."; btn.disabled = true;
                try {
                    const res = await fetch(scriptURL, { method: "POST", body: JSON.stringify({ itemName: p["Item #"], imageB64: base64 }) });
                    const data = await res.json();
                    if(data.result === "success") {
                        // LOG DE IMAGEN SUBIDA
                        await addDoc(collection(db, "movimientos"), {
                            usuario: user.usuario, accion: "Subida de Imagen",
                            detalle: `Item: ${p["Item #"]}`, fecha: serverTimestamp()
                        });
                        alert("¬°Foto guardada en Drive!");
                        btn.innerText = "SUBIR A DRIVE"; btn.disabled = false; fileInput.value = "";
                    }
                } catch(e) { alert("Error al subir"); btn.disabled = false; }
            };
        }

        function abrirReporte(p) { /* (C√≥digo reporte igual) */ } 
        // ... (resto de funciones de b√∫squeda y pdf igual)
        document.getElementById('mainSearch').oninput = (e) => {
            const t = e.target.value.toLowerCase();
            renderTable(productosLocal.filter(p => (p["Item #"]||'').toString().toLowerCase().includes(t) || (p["PPAP Part Number"]||'').toLowerCase().includes(t)));
        };
        document.getElementById('btnSalir').onclick = () => { sessionStorage.clear(); window.location.href = "login.html"; };
    </script>
</body>
</html>