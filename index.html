<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Master Track - Index</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <style>
        /* Mantenemos tus estilos del visor gigante */
        .bottom-preview {
            margin-top: 20px; background: white; border-radius: 12px;
            border: 3px solid #3498db; padding: 20px; display: flex;
            align-items: center; gap: 30px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
        }
        .preview-image-box { flex: 0 0 300px; text-align: center; }
        #main-preview-img { max-width: 100%; max-height: 350px; object-fit: contain; border-radius: 8px; border: 1px solid #eee; background: #f9f9f9; }
        .preview-info-box { flex: 1; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .info-card { background: #f8f9fa; padding: 8px; border-radius: 6px; border-left: 4px solid #3498db; }
        .info-card label { display: block; font-size: 10px; color: #7f8c8d; font-weight: bold; text-transform: uppercase; }
        .info-card span { font-size: 14px; color: #2c3e50; font-weight: bold; }
        .loading-text { font-size: 11px; color: #3498db; font-style: italic; }
        
        /* Estilo para el botón de admin */
        #btnUsuarios { background: #f1c40f; color: #333; display: none; }
    </style>
</head>
<body class="bg-blue">
    <header><h1>PPAP Master Track System</h1></header>
    <div class="main-container">
        <nav class="side-menu">
            <button id="btnUsuarios" onclick="location.href='usuarios.html'">⚙️ GESTIÓN USUARIOS</button>
            <button onclick="location.href='registro.html'">Registrar</button>
            <button onclick="location.href='actualizar.html'">Actualizar</button>
            <button onclick="location.href='eliminar.html'">Eliminar</button>
            <button id="btnSalir" style="background: #c0392b; color: white; margin-top: 20px;">CERRAR SESIÓN</button>
        </nav>
        <section class="content">
            <input type="text" id="mainSearch" placeholder="Buscar por Item # o No. Parte..." style="width:100%; padding:12px; margin-bottom:15px; border-radius:5px; border:none;">
            <div class="table-wrapper">
                <table id="tabla-prod">
                    <thead><tr id="table-header"></tr></thead>
                    <tbody id="lista-productos"></tbody>
                </table>
            </div>

            <div id="bottom-visor" class="bottom-preview" style="display:none;">
                <div class="preview-image-box">
                    <div id="status-foto" class="loading-text"></div>
                    <img id="main-preview-img" src="imagenes/sin_foto.jpg">
                    <div style="margin-top:10px; padding:10px; background:#f1f1f1; border-radius:8px;">
                        <input type="file" id="fileDrive" accept="image/*" style="font-size:10px; width:100%;">
                        <button id="btnSubirDrive" style="width:100%; margin-top:5px; background:#4285F4; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer; font-weight:bold;">SUBIR A DRIVE</button>
                    </div>
                </div>
                <div class="preview-info-box" id="preview-data"></div>
                <div style="flex: 0 0 150px;">
                    <button id="btnDescargarPDF" style="width:100%; padding:15px; background:#27ae60; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">REPORTE PDF</button>
                </div>
            </div>
        </section>
    </div>

    <div id="reporte-print-area" style="display:none; padding:30px; background:white; color:black;">
        <div id="pdf-header" style="border-bottom:2px solid #333; padding-bottom:10px; margin-bottom:20px;">
            <h2>REPORTE TÉCNICO DE CALIDAD - PPAP</h2>
        </div>
        <div id="pdf-content" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;"></div>
    </div>

    <script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Validar sesión y obtener datos del usuario
        const userStatus = checkAuth();
        
        // SI ES ADMIN, MOSTRAR BOTÓN DE USUARIOS
        if (userStatus && userStatus.usuario === 'admin') {
            document.getElementById('btnUsuarios').style.display = 'block';
        }

        const scriptURL = "https://script.google.com/macros/s/AKfycbxaEtN66UYbSOO57Wm9HPrjv7IyfzV8Q3cyZgvDKkKcC8PTohwGaLhznjI3AfP2VTLS/exec";
        const campos = ["Item #","Estatus","Programador","PPAP Part Number","Component Description","Supplier Name","Supplier Location","Current SQE","Project Name","Drawing Revision","Material Type","Process Type","Country of Origin","Safety or Critical","1-Design Documentation","2-Engineering Change Document","3-Customer Engineering Approval","4-Design FMEA","5-Process Flow Diagram","6-Process FMEA","7-Control Plan","8-Measurement System Analysis","9-Dimensional Results","10-Material Performance Test","11-Initial Process Studies","12-Qualify Lab Documentation","13-Appereance Approval Report","14-Sample product","15-Checking Aids","16-Record of compliance","17-Bulk material checklist","18-PSW(Full or Interim)","Supplier PPAP package status","Validation run readiness","Samples on hand","Dimension status","FFF review status","AAR review status","PPAP overall status"];
        
        const header = document.getElementById('table-header');
        campos.forEach(c => header.innerHTML += `<th>${c}</th>`);

        let productosLocal = [];
        onSnapshot(collection(db, "productos"), (snap) => {
            productosLocal = snap.docs.map(doc => doc.data());
            renderTable(productosLocal);
        });

        function renderTable(data) {
            const tbody = document.getElementById('lista-productos');
            tbody.innerHTML = '';
            data.forEach(p => {
                const tr = document.createElement('tr');
                campos.forEach(c => { tr.innerHTML += `<td>${p[c] || '-'}</td>`; });
                tr.onclick = () => mostrarVisor(p);
                tbody.appendChild(tr);
            });
        }

        async function mostrarVisor(p) {
            const visor = document.getElementById('bottom-visor');
            const info = document.getElementById('preview-data');
            const img = document.getElementById('main-preview-img');
            const status = document.getElementById('status-foto');
            
            visor.style.display = 'flex';
            status.innerText = "Buscando foto en Drive...";
            img.src = "imagenes/sin_foto.jpg"; 

            info.innerHTML = '';
            campos.slice(0, 12).forEach(c => {
                info.innerHTML += `<div class="info-card"><label>${c}</label><span>${p[c] || 'N/A'}</span></div>`;
            });

            // BÚSQUEDA EN DRIVE
            try {
                const response = await fetch(`${scriptURL}?itemName=${p["Item #"]}`);
                const resData = await response.json();
                if(resData.result === "success" && resData.id) {
                    img.src = `https://lh3.googleusercontent.com/u/0/d/${resData.id}`;
                    status.innerText = "Foto de Google Drive cargada";
                } else {
                    status.innerText = "Buscando en carpeta local...";
                    img.src = `imagenes/${p["Item #"]}.jpg`;
                    img.onerror = () => { img.src = 'imagenes/sin_foto.jpg'; status.innerText = "Sin imagen"; };
                }
            } catch (e) {
                img.src = `imagenes/${p["Item #"]}.jpg`;
                img.onerror = () => { img.src = 'imagenes/sin_foto.jpg'; };
                status.innerText = "";
            }

            // BOTÓN SUBIR A DRIVE
            document.getElementById('btnSubirDrive').onclick = () => {
                const file = document.getElementById('fileDrive').files[0];
                if(!file) return alert("Selecciona una foto");
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const base64 = reader.result.split(',')[1];
                    const btn = document.getElementById('btnSubirDrive');
                    btn.innerText = "SUBIENDO..."; btn.disabled = true;
                    try {
                        const res = await fetch(scriptURL, {
                            method: "POST",
                            body: JSON.stringify({ itemName: p["Item #"], imageB64: base64 })
                        });
                        const data = await res.json();
                        if(data.result === "success") {
                            alert("¡Guardado en Drive!");
                            btn.innerText = "SUBIR A DRIVE"; btn.disabled = false;
                            mostrarVisor(p);
                        }
                    } catch(e) { alert("Error al subir"); btn.disabled = false; }
                };
            };

            // LÓGICA PDF
            document.getElementById('btnDescargarPDF').onclick = () => {
                const pdfContent = document.getElementById('pdf-content');
                pdfContent.innerHTML = '';
                campos.forEach(c => {
                    pdfContent.innerHTML += `<p><b>${c}:</b> ${p[c] || 'N/A'}</p>`;
                });
                const element = document.getElementById('reporte-print-area');
                element.style.display = 'block';
                html2pdf().set({
                    margin: 10,
                    filename: `Reporte_${p["Item #"]}.pdf`,
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).from(element).save().then(() => { element.style.display = 'none'; });
            };
        }

        // BUSCADOR
        document.getElementById('mainSearch').oninput = (e) => {
            const t = e.target.value.toLowerCase();
            const filtrados = productosLocal.filter(p => 
                (p["Item #"] || '').toString().toLowerCase().includes(t) || 
                (p["PPAP Part Number"] || '').toLowerCase().includes(t)
            );
            renderTable(filtrados);
        };

        document.getElementById('btnSalir').onclick = () => { sessionStorage.clear(); window.location.href = "login.html"; };
    </script>
</body>
</html>
