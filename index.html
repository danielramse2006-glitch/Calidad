<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Master Track - Home</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <style>
        .table-wrapper { 
            max-height: 600px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            background: white; 
            border-radius: 8px; 
        }
        
        #btnUsuarios, #btnHistorial, #btnRegistrar, #btnActualizar, #btnEliminar, #btnConsultas, #btnComentarios, #btnFiltros { 
            display: none; 
        }
        
        .permission-badge {
            font-size: 9px;
            background: #27ae60;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
        
        .permission-denied {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .permission-denied:hover {
            transform: none !important;
            background: white !important;
        }
        
        .compact-header {
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        .vc2-header {
            background: linear-gradient(to right, #003366, #0056a9);
            color: white;
            text-align: center;
            padding: 12px 0;
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 2px;
            margin: 0;
            border-bottom: 3px solid #0099cc;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* NUEVO: Estilos para texto truncado con "ver m√°s" */
        .truncate-text {
            max-height: 60px;
            overflow: hidden;
            position: relative;
            line-height: 1.4em;
            font-size: 11px;
            padding-right: 20px;
            word-wrap: break-word;
        }
        
        .truncate-text.expanded {
            max-height: none;
        }
        
        .truncate-text::after {
            content: '';
            position: absolute;
            right: 0;
            bottom: 0;
        }
        
        .show-more-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 10px;
            padding: 0;
            margin-left: 5px;
            text-decoration: underline;
        }
        
        .show-more-btn:hover {
            color: #2980b9;
        }
        
        /* Para las celdas de comentarios e instrucciones */
        .comments-cell, .instructions-cell {
            max-width: 250px;
            min-width: 150px;
        }
        
        /* Estilo para el modal de texto completo */
        .full-text-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .full-text-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .full-text-title {
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #3498db;
        }
        
        .full-text-body {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        /* Tooltip para texto corto */
        .cell-tooltip {
            position: relative;
            cursor: help;
        }
        
        .cell-tooltip:hover::after {
            content: attr(data-fulltext);
            position: absolute;
            left: 0;
            top: 100%;
            background: #2c3e50;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: pre-wrap;
            max-width: 400px;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* Mejoras para la tabla */
        #tabla-prod {
            table-layout: fixed;
            width: 100%;
        }
        
        #tabla-prod th, #tabla-prod td {
            padding: 8px 4px;
            vertical-align: top;
        }
        
        .multiline-text {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-blue">
    <!-- CORPORATE HEADER -->
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            
            <div class="company-info">
                <h1>PPAP Master Track System</h1>
                <div class="subtitle" style="color: white;">SMP Engine Management, S. de R.L. de C.V</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">üë§ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>
    
    <div class="vc2-container">
        <div class="vc2-header">
            VC2
        </div>
    </div>
           
    <header><h1>PPAP Management System</h1></header>
    
    <div class="main-container">
        <nav class="side-menu">
            <!-- User Management (admin only) -->
            <button id="btnUsuarios" onclick="location.href='usuarios.html'" style="background: #f1c40f; color: #333;">
                ‚öôÔ∏è USER MANAGEMENT <span class="permission-badge">ADMIN</span>
            </button>
            
            <!-- Full History (admin only) -->
            <button id="btnHistorial" onclick="location.href='historial.html'" style="background: #8e44ad; color: white;">
                üìã FULL HISTORY <span class="permission-badge">ADMIN</span>
            </button>
            
            <!-- Historical Queries (special permission) -->
            <button id="btnConsultas" onclick="location.href='consultas.html'">
                üîç QUERIES
            </button>
            
            <!-- Filters & Statistics (special permission) -->
            <button id="btnFiltros" onclick="location.href='filtros.html'">
                üìä FILTERS & STATS
            </button>
            
            <!-- Edit Comments (special permission) -->
            <button id="btnComentarios" onclick="location.href='comentarios.html'">
                ‚úèÔ∏è EDIT COMMENTS
            </button>
            
            <!-- Basic operations buttons -->
            <button id="btnRegistrar" onclick="location.href='registro.html'">
                üìù NEW 
            </button>

            <button id="btnActualizar" onclick="location.href='actualizar.html'">
                üîÑ UPDATE
            </button>
            
            <button id="btnEliminar" onclick="location.href='eliminar.html'">
                üóëÔ∏è DELETE
            </button>
            
            <!-- Current user information -->
            <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 11px; color: #666;">
                <div style="font-weight: bold; margin-bottom: 5px;">üë§ User: <span id="current-user"></span></div>
                <div id="user-permissions" style="font-size: 10px;"></div>
            </div>
            
            <!-- Logout button -->
            <button id="btnSalir" style="background: #c0392b; color: white; margin-top: 20px; border:none; cursor:pointer; padding:14px; border-radius:8px;">
                LOG OUT
            </button>
        </nav>
        
        <section class="content" style="flex:1; display: flex; flex-direction: column;">
            <input type="text" id="mainSearch" placeholder="Search by Item # or Part Number..." style="width:100%; padding:12px; margin-bottom:15px; border-radius:5px; border:none;">
            
            <div class="table-wrapper">
                <table id="tabla-prod">
                    <thead><tr id="table-head"></tr></thead>
                    <tbody id="inventory-body"></tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- MODAL PARA TEXTO COMPLETO -->
    <div id="fullTextModal" class="full-text-modal">
        <div class="full-text-content">
            <button class="close-modal" onclick="closeFullTextModal()">√ó</button>
            <h3 class="full-text-title" id="modalTitle"></h3>
            <div class="full-text-body" id="modalBody"></div>
            <div style="margin-top: 15px; font-size: 11px; color: #7f8c8d;">
                <strong>Item #:</strong> <span id="modalItemNumber"></span> | 
                <strong>Responsible:</strong> <span id="modalResponsible"></span>
            </div>
        </div>
    </div>

    <!-- MODAL DE REPORTE (existente) -->
    <div id="modalReporte" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; overflow-y:auto;">
        <div style="background:white; width:95%; max-width:850px; margin:20px auto; padding:10px; border-radius:8px;">
            <div id="reporte-print-area" style="padding:30px; color:black; font-family: Arial, sans-serif;">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:4px solid #2c3e50; padding-bottom:10px; margin-bottom:15px;">
                    <div>
                        <h1 style="margin:0; color:#2c3e50; font-size:22px;">PPAP TECHNICAL REPORT</h1>
                        <p style="margin:0; color:#7f8c8d; font-size:11px; font-weight:bold;">MASTER TRACK SYSTEM</p>
                    </div>
                    <div id="rep-fecha" style="font-size:12px; font-weight:bold;"></div>
                </div>
                <div id="rep-data-main" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;"></div>
                <h3 style="background:#2c3e50; color:white; padding:6px; margin-top:20px; font-size:14px;">DOCUMENTATION CHECKLIST</h3>
                <div id="rep-data-ppap" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; font-size:11px; background:#f8f9fa; padding:10px;"></div>
            </div>
            <div style="margin:15px; display:flex; gap:10px;">
                <button id="btnDescargarPDF" style="flex:2; padding:15px; background:#27ae60; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">üì• DOWNLOAD PDF</button>
                <button onclick="document.getElementById('modalReporte').style.display='none'" style="flex:1; padding:15px; background:#e74c3c; color:white; border:none; border-radius:6px; cursor:pointer;">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- CORPORATE FOOTER -->
    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">¬© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const user = checkAuth();
        
        // Mostrar informaci√≥n del usuario
        if(user) {
            document.getElementById('current-user-display').textContent = `üë§ ${user.usuario}`;
            document.getElementById('current-user').textContent = user.usuario;
            
            const permissionsDiv = document.getElementById('user-permissions');
            if(user.usuario === 'admin') {
                permissionsDiv.innerHTML = 'üîì Permissions: <strong>ALL</strong>';
            } else if(user.permisos) {
                const permisos = [];
                if(user.permisos.registrar) permisos.push('Register');
                if(user.permisos.actualizar) permisos.push('Update');
                if(user.permisos.eliminar) permisos.push('Delete');
                if(user.permisos.subirDrive) permisos.push('Upload Images');
                if(user.permisos.consultar) permisos.push('Queries');
                if(user.permisos.editarComentarios) permisos.push('Edit Comments');
                
                permissionsDiv.innerHTML = 'üîê Permissions: <strong>' + (permisos.length > 0 ? permisos.join(', ') : 'Basic') + '</strong>';
            }
        }
        
        // Mostrar fecha actual
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        
        // Configurar botones seg√∫n permisos
        if(user) {
            if(user.usuario === 'admin') {
                document.querySelectorAll('#btnUsuarios, #btnHistorial, #btnRegistrar, #btnActualizar, #btnEliminar, #btnConsultas, #btnComentarios, #btnFiltros').forEach(b => b.style.display = 'block');
            } else {
                if(user.permisos) {
                    if(user.permisos.registrar) document.getElementById('btnRegistrar').style.display = 'block';
                    if(user.permisos.actualizar) document.getElementById('btnActualizar').style.display = 'block';
                    if(user.permisos.eliminar) document.getElementById('btnEliminar').style.display = 'block';
                    if(user.permisos.consultar) {
                        document.getElementById('btnConsultas').style.display = 'block';
                        document.getElementById('btnFiltros').style.display = 'block';
                    }
                    if(user.permisos.editarComentarios) document.getElementById('btnComentarios').style.display = 'block';
                }
            }
        }

        // Campos de la base de datos
        const camposDB = [
            "Item #",
            "PPAP Part Number",
            "Component description",
            "Reason for Change",
            "Product type",
            "PRP5/Area",
            "OE/AFTERMARKET",
            "documentation",
            "Samples received",
            "Location",
            "Dimensional",
            "Special instruccions",
            "Validation date",
            "Programmer",
            "Quality Lead",
            "Reason",
            "Comments(detalle)",
            "Responsible",
            "Estatus",
            "Revision",
            "PPAP type OE / SM\nAfter Market",
            "1 Design records",
            "2\nECN document",
            "3\nCustomer eng approval",
            "4\nDesign FMEA",
            "5\nProcess Flow Diagram",
            "6\nPFMEA",
            "7\nControl Plan",
            "8\nMSA Studies",
            "9\nDimensional results",
            "10\nMaterial, performance test result",
            "11\nInitial Process Studies",
            "12\nQualify Lab Documentation",
            "13\nAppereance Approval Report",
            "14\nSample product",
            "15\nChecking Aids",
            "16\nRecord of compliance",
            "17\nBulk material checklist",
            "18\nPSW\n(Full or Interim)",
            "Supplier PPAP package status",
            "Validation run readiness",
            "Samples on hand",
            "Dimension status",
            "FFF review status",
            "AAR review status",
            "PPAP overall status"
        ];

        const camposUI = camposDB.map(field => field.replace(/\n/g, " "));

        // Crear encabezados de tabla
        const head = document.getElementById('table-head');
        camposUI.forEach(c => {
            const th = document.createElement('th');
            th.className = 'compact-header';
            th.textContent = c;
            
            // A√±adir clase espec√≠fica para comentarios e instrucciones
            if (c.includes("Comments") || c.includes("Special instruccions")) {
                th.classList.add('comments-cell');
            }
            
            head.appendChild(th);
        });
        head.innerHTML += `<th>ACTIONS</th>`;

        let productosLocal = [];
        
        // Funci√≥n para truncar texto largo
        function truncateText(text, maxLength = 100) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        // Funci√≥n para mostrar texto completo en modal
        function showFullTextModal(title, content, itemNumber, responsible) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').textContent = content;
            document.getElementById('modalItemNumber').textContent = itemNumber || 'N/A';
            document.getElementById('modalResponsible').textContent = responsible || 'N/A';
            document.getElementById('fullTextModal').style.display = 'flex';
        }
        
        // Funci√≥n para cerrar modal
        window.closeFullTextModal = function() {
            document.getElementById('fullTextModal').style.display = 'none';
        }
        
        // Renderizar tabla
        function renderTable(lista) {
            const tbody = document.getElementById('inventory-body');
            tbody.innerHTML = '';
            
            lista.forEach(p => {
                const tr = document.createElement('tr');
                
                camposDB.forEach(campoDB => {
                    const td = document.createElement('td');
                    const valor = p[campoDB] || '-';
                    
                    // Aplicar truncado a comentarios e instrucciones
                    if (campoDB === "Comments(detalle)" || campoDB === "Special instruccions") {
                        const cellClass = campoDB === "Comments(detalle)" ? "comments-cell" : "instructions-cell";
                        td.classList.add(cellClass);
                        
                        if (valor !== '-' && valor.length > 100) {
                            const truncated = truncateText(valor, 100);
                            
                            // Crear contenedor con texto truncado y bot√≥n "ver m√°s"
                            const container = document.createElement('div');
                            container.style.position = 'relative';
                            
                            const textSpan = document.createElement('span');
                            textSpan.textContent = truncated;
                            textSpan.style.fontSize = '11px';
                            
                            const moreBtn = document.createElement('button');
                            moreBtn.textContent = 'ver m√°s';
                            moreBtn.className = 'show-more-btn';
                            moreBtn.onclick = (e) => {
                                e.stopPropagation();
                                showFullTextModal(
                                    campoDB === "Comments(detalle)" ? "Comentarios Detallados" : "Instrucciones Especiales",
                                    valor,
                                    p["Item #"],
                                    p["Responsible"]
                                );
                            };
                            
                            container.appendChild(textSpan);
                            container.appendChild(moreBtn);
                            td.appendChild(container);
                            
                            // A√±adir tooltip para vista r√°pida
                            td.classList.add('cell-tooltip');
                            td.setAttribute('data-fulltext', valor);
                        } else {
                            // Texto corto, mostrar completo
                            td.textContent = valor;
                            if (valor !== '-' && valor.length > 50) {
                                td.classList.add('cell-tooltip');
                                td.setAttribute('data-fulltext', valor);
                            }
                        }
                    } else if (campoDB === "Component description" || campoDB === "Reason") {
                        // Para otros campos largos
                        td.textContent = valor;
                        td.classList.add('multiline-text');
                        if (valor !== '-' && valor.length > 80) {
                            td.classList.add('cell-tooltip');
                            td.setAttribute('data-fulltext', valor);
                        }
                    } else {
                        // Campos normales
                        td.textContent = valor;
                    }
                    
                    td.style.fontSize = '11px';
                    tr.appendChild(td);
                });
                
                // Columna de acciones
                const tdBtn = document.createElement('td');
                const btn = document.createElement('button');
                btn.innerText = "REPORT";
                btn.onclick = () => abrirReporte(p);
                btn.className = "btn-report-row";
                tdBtn.appendChild(btn);
                tr.appendChild(tdBtn);
                tbody.appendChild(tr);
            });
        }
        
        // Cargar datos desde Firestore
        onSnapshot(collection(db, "productos"), (snap) => {
            productosLocal = [];
            snap.forEach(doc => productosLocal.push(doc.data()));
            renderTable(productosLocal);
        });
        
        // Funci√≥n para abrir reporte (existente)
        window.abrirReporte = function(p) {
            document.getElementById('rep-fecha').innerText = "DATE: " + new Date().toLocaleDateString();
            const rMain = document.getElementById('rep-data-main');
            const rPpap = document.getElementById('rep-data-ppap');
            rMain.innerHTML = ''; rPpap.innerHTML = '';

            camposDB.forEach((key, index) => {
                const nombreMostrar = camposUI[index] || key;
                const html = `<div style="border-bottom:1px solid #eee; padding:2px 0;">
                    <b style="font-size:9px; color:#666; display:block;">${nombreMostrar}</b>
                    <span style="font-size:12px;">${p[key] || '-'}</span>
                </div>`;
                if(index < 15) rMain.innerHTML += html; else rPpap.innerHTML += html;
            });
            document.getElementById('modalReporte').style.display = 'block';
        };

        // Event listeners
        document.getElementById('btnDescargarPDF').onclick = () => {
            const element = document.getElementById('reporte-print-area');
            html2pdf().set({ margin: 10, filename: 'PPAP.pdf', jsPDF: { format: 'letter' } }).from(element).save();
        };

        document.getElementById('mainSearch').oninput = (e) => {
            const t = e.target.value.toLowerCase();
            renderTable(productosLocal.filter(p => 
                (p["Item #"]||'').toString().toLowerCase().includes(t) || 
                (p["PPAP Part Number"]||'').toLowerCase().includes(t)
            ));
        };

        document.getElementById('btnSalir').onclick = () => { 
            sessionStorage.clear(); 
            window.location.href = "login.html"; 
        };

        // Cerrar modal al hacer clic fuera
        document.getElementById('fullTextModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFullTextModal();
            }
        });

        // Cerrar modal con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFullTextModal();
            }
        });
    </script>
</body>
</html>