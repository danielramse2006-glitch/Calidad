<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Actualizar PPAP - Master Track</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .status-select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 14px;
            width: 100%;
            background: white;
            color: #333;
        }
        .status-approved { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-pending { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .status-rejected { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-inprogress { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .field-group {
            padding: 8px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .required-field::after {
            content: " *";
            color: #e74c3c;
        }
        #edit-form {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }
        #edit-form::-webkit-scrollbar {
            width: 8px;
        }
        #edit-form::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }
        #edit-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .current-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
    </style>
</head>
<body class="bg-blue">
    <header><h1>Actualizar Registro PPAP</h1></header>
    
    <div style="padding: 20px; max-width: 1000px; margin: auto;">
        <div style="background: white; border-radius: 10px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: grid; grid-template-columns: 1fr 350px; gap: 25px;">
            
            <!-- Columna izquierda - Formulario -->
            <div>
                <h2 style="margin-bottom: 25px; color: #2c3e50; display: flex; align-items: center; justify-content: space-between;">
                    <span>üìù Actualizar Registro</span>
                    <button onclick="location.href='index.html'" style="padding: 8px 15px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                        ‚Üê VOLVER
                    </button>
                </h2>
                
                <div style="margin-bottom: 25px; display: flex; gap: 10px; align-items: center;">
                    <div style="flex: 1; position: relative;">
                        <input type="text" id="searchItem" placeholder="Ingrese Item # para buscar..." style="width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #7f8c8d; font-size: 12px;">üîç</span>
                    </div>
                    <button id="btnBuscar" style="padding: 14px 25px; background: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap;">
                        BUSCAR ITEM
                    </button>
                </div>

                <div id="current-info" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #3498db;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #2c3e50;">Item: <span id="current-item-display" style="font-weight: bold;"></span></h4>
                            <p style="margin: 0; font-size: 13px; color: #7f8c8d;">Estado actual: 
                                <span id="current-status-display" class="current-status status-pending">Cargando...</span>
                            </p>
                        </div>
                        <div id="last-update" style="font-size: 11px; color: #95a5a6;"></div>
                    </div>
                </div>

                <div id="edit-form" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                    <!-- Los campos se generan din√°micamente -->
                </div>

                <div id="action-buttons" style="display: none;">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <button id="btnUpdate" style="flex: 3; padding: 16px; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px;">
                            üíæ GUARDAR CAMBIOS
                        </button>
                        <button id="btnCancel" style="flex: 1; padding: 16px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            CANCELAR
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #7f8c8d; text-align: center; margin: 0;">
                        ‚ö†Ô∏è Los cambios se registrar√°n en el historial del sistema
                    </p>
                </div>
            </div>

            <!-- Columna derecha - Im√°genes -->
            <div style="border-left: 1px solid #eee; padding-left: 25px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üñºÔ∏è Gesti√≥n de Im√°genes</h3>
                    <p style="font-size: 13px; color: #7f8c8d; margin-bottom: 20px;">
                        Sube una imagen para esta versi√≥n del PPAP. Se guardar√° con la fecha actual.
                    </p>
                </div>

                <div style="width: 100%; height: 250px; border: 2px dashed #3498db; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; background: #f8f9fa; overflow: hidden;">
                    <img id="current-img" src="imagenes/sin_foto.jpg" style="max-width: 100%; max-height: 100%; object-fit: contain; transition: opacity 0.3s;">
                </div>
                
                <div style="text-align: center;">
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    <button id="btnSubirDrive" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; margin-bottom: 10px;">
                        üì∏ SUBIR NUEVA FOTO
                    </button>
                    <p id="upload-status" style="font-size: 12px; color: #666; margin-top: 10px; min-height: 20px;"></p>
                    
                    <div style="margin-top: 25px; padding: 15px; background: #f0f7ff; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; color: #3498db; font-size: 14px;">üìã Informaci√≥n de Im√°genes</h4>
                        <p style="font-size: 11px; color: #555; margin: 0;">
                            ‚Ä¢ Formato: <code>Item_Fecha.jpg</code><br>
                            ‚Ä¢ Ejemplo: <code>15_2024-01-27.jpg</code><br>
                            ‚Ä¢ M√°ximo: 10MB por imagen<br>
                            ‚Ä¢ Formatos: JPG, PNG, GIF
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, query, where, getDocs, doc, setDoc, addDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const user = checkAuth();
        const scriptURL = "https://script.google.com/macros/s/AKfycbz-zqhnPq-ZCVv1miDE8lF6WkKfTrw4KMj2ikRm8ZYkncyOpSG0VAqEkbfbnThTIdmb/exec";

        let currentId = null;
        let itemActual = null;
        
        // Campos ordenados por categor√≠as para mejor organizaci√≥n
        const campos = [
            // Informaci√≥n b√°sica
            "Item #", "Estatus", "Programador", "PPAP Part Number", "Component Description",
            "Razon para el cambio", "Nivel de Submission", "Target Date", "Recibido",
            
            // Documentaci√≥n PPAP (1-18)
            "1-Design Record", "2-Engineering change document", "3-Customer Engineering Approval",
            "4-DFMEA", "5-Process Flow Diagram", "6-PFMEA", "7-Control Plan", "8-MSA",
            "9-Dimensional results", "10-Material/Performance Test", "11-Initial Process Studies",
            "12-Qualified Lab Documentation", "13-Appearance Approval Report", "14-Sample product",
            "15-Checking Aids", "16-Record de compliance", "17-Bulk material checklist", 
            "18-PSW(Full or Interim)",
            
            // Estados y revisiones
            "Supplier PPAP package status", "Validation run readiness", "Samples on hand",
            "Dimension status", "FFF review status", "AAR review status", "PPAP overall status"
        ];

        // Campos importantes (para resaltar)
        const importantFields = ["Item #", "Estatus", "PPAP overall status", "Target Date", "Recibido"];

        // BUSCAR ITEM
        document.getElementById('btnBuscar').onclick = async () => {
            const val = document.getElementById('searchItem').value.trim();
            if(!val) {
                alert("Por favor ingresa un n√∫mero de Item");
                return;
            }

            // Mostrar loading
            const btnBuscar = document.getElementById('btnBuscar');
            btnBuscar.innerHTML = "üîç BUSCANDO...";
            btnBuscar.disabled = true;

            try {
                const q = query(collection(db, "productos"), where("Item #", "==", val));
                const snap = await getDocs(q);

                if(snap.empty) {
                    alert("‚ùå No se encontr√≥ el Item. Verifica el n√∫mero e intenta nuevamente.");
                    resetForm();
                    return;
                }

                const d = snap.docs[0];
                currentId = d.id;
                const data = d.data();
                itemActual = data["Item #"];

                // Mostrar informaci√≥n actual
                document.getElementById('current-info').style.display = 'block';
                document.getElementById('current-item-display').textContent = itemActual;
                
                // Mostrar estado actual con color
                const currentStatus = data["PPAP overall status"] || "Sin estado";
                const statusDisplay = document.getElementById('current-status-display');
                statusDisplay.textContent = currentStatus;
                
                // Aplicar clase de color seg√∫n estado
                statusDisplay.className = "current-status ";
                if (currentStatus.toLowerCase().includes("aprobado") || currentStatus.toLowerCase().includes("approved")) {
                    statusDisplay.classList.add("status-approved");
                } else if (currentStatus.toLowerCase().includes("pendiente") || currentStatus.toLowerCase().includes("pending")) {
                    statusDisplay.classList.add("status-pending");
                } else if (currentStatus.toLowerCase().includes("rechazado") || currentStatus.toLowerCase().includes("rejected")) {
                    statusDisplay.classList.add("status-rejected");
                } else {
                    statusDisplay.classList.add("status-inprogress");
                }

                // Buscar √∫ltima actualizaci√≥n
                try {
                    const historyQuery = query(
                        collection(db, "movimientos"),
                        where("detalle", "==", `Item: ${itemActual}`),
                        orderBy("fecha", "desc"),
                        limit(1)
                    );
                    const historySnap = await getDocs(historyQuery);
                    if (!historySnap.empty) {
                        const lastUpdate = historySnap.docs[0].data();
                        const lastDate = lastUpdate.fecha ? 
                            new Date(lastUpdate.fecha.seconds * 1000).toLocaleDateString() : 
                            "Fecha desconocida";
                        document.getElementById('last-update').textContent = `√öltima modificaci√≥n: ${lastDate}`;
                    }
                } catch (historyError) {
                    console.log("No se pudo obtener historial:", historyError);
                }

                // Generar formulario de edici√≥n
                const form = document.getElementById('edit-form');
                form.innerHTML = '';
                
                campos.forEach(campo => {
                    const div = document.createElement('div');
                    div.className = importantFields.includes(campo) ? 'field-group' : '';
                    
                    // Determinar si es campo requerido
                    const isRequired = importantFields.includes(campo);
                    
                    // Para campos de estado, usar select
                    if (campo === "PPAP overall status" || campo === "Estatus") {
                        const options = ["Pendiente", "En Proceso", "Aprobado", "Rechazado", "Completado"];
                        const currentValue = data[campo] || "";
                        
                        div.innerHTML = `
                            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;">
                                ${campo}${isRequired ? '<span style="color:#e74c3c;"> *</span>' : ''}
                            </label>
                            <select id="upd-${campo}" class="status-select" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                                <option value="">Seleccionar estado...</option>
                                ${options.map(opt => 
                                    `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        `;
                    } else {
                        div.innerHTML = `
                            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;">
                                ${campo}${isRequired ? '<span style="color:#e74c3c;"> *</span>' : ''}
                            </label>
                            <input type="text" 
                                   id="upd-${campo}" 
                                   value="${data[campo] || ''}" 
                                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:13px;"
                                   ${campo === "Item #" ? 'readonly style="background:#f5f5f5;"' : ''}>
                        `;
                    }
                    
                    form.appendChild(div);
                });

                form.style.display = 'grid';
                document.getElementById('action-buttons').style.display = 'block';
                document.getElementById('btnSubirDrive').style.display = 'block';

                // Actualizar imagen si existe
                const hoy = new Date().toISOString().split('T')[0];
                const nombreArchivo = `${itemActual}_${hoy}`;
                try {
                    const imgResponse = await fetch(`${scriptURL}?itemName=${nombreArchivo}`);
                    const imgData = await imgResponse.json();
                    if(imgData.result === "success" && imgData.id) {
                        document.getElementById('current-img').src = `https://lh3.googleusercontent.com/d/${imgData.id}`;
                        document.getElementById('upload-status').innerHTML = `<span style="color:#27ae60;">‚úÖ Imagen actual encontrada</span>`;
                    }
                } catch (imgError) {
                    // No hay imagen, mostrar la predeterminada
                    document.getElementById('current-img').src = "imagenes/sin_foto.jpg";
                }

                // Scroll suave al formulario
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch(error) {
                console.error("Error al buscar:", error);
                alert("Error al conectar con la base de datos. Intenta nuevamente.");
            } finally {
                btnBuscar.innerHTML = "BUSCAR ITEM";
                btnBuscar.disabled = false;
            }
        };

        // Funci√≥n para resetear formulario
        function resetForm() {
            document.getElementById('edit-form').innerHTML = '';
            document.getElementById('edit-form').style.display = 'none';
            document.getElementById('action-buttons').style.display = 'none';
            document.getElementById('current-info').style.display = 'none';
            document.getElementById('btnSubirDrive').style.display = 'none';
            document.getElementById('current-img').src = "imagenes/sin_foto.jpg";
            document.getElementById('upload-status').textContent = '';
            currentId = null;
            itemActual = null;
        }

        // Cancelar edici√≥n
        document.getElementById('btnCancel').onclick = resetForm;

        // L√ìGICA DE DRIVE (SUBIR FOTO)
        document.getElementById('btnSubirDrive').onclick = () => {
            if (!itemActual) {
                alert("Primero busca un Item para actualizar");
                return;
            }
            document.getElementById('fileInput').click();
        };

        document.getElementById('fileInput').onchange = function() {
            const file = this.files[0];
            if (!file) return;

            // Validar tama√±o (m√°ximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert("La imagen es demasiado grande. M√°ximo 10MB.");
                return;
            }

            // Validar tipo
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/jpg'];
            if (!validTypes.includes(file.type)) {
                alert("Formato no v√°lido. Use JPG, PNG o GIF.");
                return;
            }

            const reader = new FileReader();
            const btn = document.getElementById('btnSubirDrive');
            const status = document.getElementById('upload-status');

            reader.onload = async function() {
                const base64 = reader.result.split(',')[1];
                const hoy = new Date().toISOString().slice(0, 10);
                const nombreArchivo = `${itemActual}_${hoy}`;

                btn.innerHTML = "‚è≥ SUBIENDO...";
                btn.disabled = true;
                status.innerHTML = `<span style="color:#f39c12;">‚è≥ Procesando imagen...</span>`;

                try {
                    const res = await fetch(scriptURL, { 
                        method: "POST", 
                        body: JSON.stringify({ 
                            itemName: nombreArchivo, 
                            imageB64: base64 
                        }) 
                    });
                    const resData = await res.json();

                    if(resData.result === "success") {
                        // Mostrar imagen subida
                        document.getElementById('current-img').src = `https://lh3.googleusercontent.com/d/${resData.id}`;
                        document.getElementById('current-img').style.opacity = "1";
                        
                        status.innerHTML = `<span style="color:#27ae60;">‚úÖ Imagen subida correctamente a Drive</span>`;
                        
                        // Registrar en historial
                        await addDoc(collection(db, "movimientos"), {
                            usuario: user.usuario,
                            accion: "Imagen Actualizada",
                            detalle: `Item: ${itemActual} (Versi√≥n: ${hoy})`,
                            fecha: serverTimestamp()
                        });

                        alert("‚úÖ Imagen guardada correctamente en Drive");
                    } else {
                        throw new Error("Error en el servidor");
                    }
                } catch(e) { 
                    console.error(e);
                    status.innerHTML = `<span style="color:#e74c3c;">‚ùå Error al subir imagen</span>`;
                    alert("Error al subir la imagen. Intenta nuevamente.");
                } finally { 
                    btn.innerHTML = "üì∏ SUBIR NUEVA FOTO"; 
                    btn.disabled = false; 
                    document.getElementById('fileInput').value = '';
                }
            };
            reader.readAsDataURL(file);
        };

        // ACTUALIZAR FIRESTORE
        document.getElementById('btnUpdate').onclick = async () => {
            if (!currentId) {
                alert("Primero busca un registro para actualizar");
                return;
            }

            // Validar campos importantes
            const importantValues = {};
            let hasError = false;
            importantFields.forEach(field => {
                const element = document.getElementById(`upd-${field}`);
                if (element) {
                    const value = element.tagName === 'SELECT' ? element.value : element.value.trim();
                    importantValues[field] = value;
                    if (field !== "Item #" && !value) {
                        alert(`El campo "${field}" es obligatorio`);
                        hasError = true;
                        element.style.borderColor = "#e74c3c";
                        element.focus();
                    } else {
                        element.style.borderColor = "#ddd";
                    }
                }
            });

            if (hasError) return;

            // Confirmar actualizaci√≥n
            if (!confirm("¬øEst√°s seguro de actualizar este registro? Los cambios se guardar√°n en el historial.")) {
                return;
            }

            const newData = {};
            campos.forEach(c => {
                const element = document.getElementById(`upd-${c}`);
                if (element) {
                    newData[c] = element.tagName === 'SELECT' ? element.value : element.value.trim();
                }
            });

            const btnUpdate = document.getElementById('btnUpdate');
            btnUpdate.innerHTML = "‚è≥ GUARDANDO...";
            btnUpdate.disabled = true;

            try {
                // Actualizar en Firestore
                await setDoc(doc(db, "productos", currentId), newData, { merge: true });
                
                // Registrar en historial
                await addDoc(collection(db, "movimientos"), {
                    usuario: user.usuario,
                    accion: "Actualizaci√≥n de PPAP",
                    detalle: `Item: ${itemActual}`,
                    statusMomento: newData["PPAP overall status"],
                    fecha: serverTimestamp()
                });

                alert("‚úÖ Registro actualizado con √©xito");
                location.href = 'index.html';
            } catch(e) { 
                console.error("Error al actualizar:", e);
                alert("‚ùå Error al actualizar en la base de datos"); 
            } finally {
                btnUpdate.innerHTML = "üíæ GUARDAR CAMBIOS";
                btnUpdate.disabled = false;
            }
        };

        // Permitir buscar con Enter
        document.getElementById('searchItem').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('btnBuscar').click();
            }
        });

        // Mostrar ayuda inicial
        window.addEventListener('load', function() {
            document.getElementById('searchItem').focus();
        });
    </script>
</body>
</html>
