<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update PPAP - Master Track</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .status-select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 14px;
            width: 100%;
            background: white;
            color: #333;
        }
        .status-approved { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-pending { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .status-rejected { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-inprogress { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .field-group {
            padding: 8px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .required-field::after {
            content: " *";
            color: #e74c3c;
        }
        #edit-form {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }
        #edit-form::-webkit-scrollbar {
            width: 8px;
        }
        #edit-form::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }
        #edit-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .current-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
        .ppap-validation-ok {
            border-color: #27ae60 !important;
            background-color: #f0fff4 !important;
        }
        .ppap-validation-error {
            border-color: #e74c3c !important;
            background-color: #ffe6e6 !important;
        }
        .image-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .image-section-title {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .image-container {
            width: 100%;
            height: 200px;
            border: 2px dashed #3498db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            background: white;
            overflow: hidden;
        }
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .upload-status {
            font-size: 12px;
            min-height: 20px;
            margin-top: 10px;
            text-align: center;
        }
        .upload-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .btn-psw {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        .btn-pv {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }
        .file-info {
            font-size: 11px;
            color: #555;
            background: #f0f7ff;
            padding: 8px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .vc2-header {
            /* background: linear-gradient(to right, #003366, #0056a9);*/
            color: white;
            text-align: center;
            padding: 12px 0;
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 2px;
            margin: 0;
            border-bottom: 3px solid #0099cc;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .vc2-container {
            display: flex;
            justify-content: center;
            width: 100%;
            background: linear-gradient(to right, #003366, #0056a9);
        }

    </style>
</head>
<body class="bg-blue">
    <!-- CORPORATE HEADER -->
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            <div>
                <h1>PPAP Master Track System</h1>
                <div class="subtitle" style="color: white;">SMP Engine Management, S. de R.L. de C.V</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">üë§ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>

<!-- VC2 M√ÅS CHICO Y CENTRADO - A√ëADIDO AQU√ç -->
    <div class="vc2-container">
        <div class="vc2-header">
            VC2
        </div>
    </div>

    <header><h1>Update PPAP Record</h1></header>
    
    <div style="padding: 20px; max-width: 1200px; margin: auto;">
        <div style="background: white; border-radius: 10px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: grid; grid-template-columns: 1fr 400px; gap: 25px;">
            
            <!-- Left column - Form -->
            <div>
                <h2 style="margin-bottom: 25px; color: #2c3e50; display: flex; align-items: center; justify-content: space-between;">
                    <span>üìù Update Record</span>
                    <button onclick="location.href='index.html'" style="padding: 8px 15px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                        ‚Üê BACK
                    </button>
                </h2>
                
                <div style="margin-bottom: 25px; display: flex; gap: 10px; align-items: center;">
                    <div style="flex: 1; position: relative;">
                        <input type="text" id="searchItem" placeholder="Enter Item # to search..." style="width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #7f8c8d; font-size: 12px;">üîç</span>
                    </div>
                    <button id="btnBuscar" style="padding: 14px 25px; background: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap;">
                        SEARCH ITEM
                    </button>
                </div>

                <div id="current-info" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #3498db;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #2c3e50;">Item: <span id="current-item-display" style="font-weight: bold;"></span></h4>
                            <p style="margin: 0; font-size: 13px; color: #7f8c8d;">Current status: 
                                <span id="current-status-display" class="current-status status-pending">Loading...</span>
                            </p>
                        </div>
                        <div id="last-update" style="font-size: 11px; color: #95a5a6;"></div>
                    </div>
                </div>

                <div id="edit-form" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                    <!-- Fields generated dynamically -->
                </div>

                <div id="action-buttons" style="display: none;">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <button id="btnUpdate" style="flex: 3; padding: 16px; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px;">
                            üíæ SAVE CHANGES
                        </button>
                        <button id="btnCancel" style="flex: 1; padding: 16px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            CANCEL
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #7f8c8d; text-align: center; margin: 0;">
                        ‚ö†Ô∏è Changes will be recorded in the system history
                    </p>
                </div>
            </div>

            <!-- Right column - Images -->
            <div style="border-left: 1px solid #eee; padding-left: 25px;">
                <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üñºÔ∏è Images</h3>
                
                <!-- PSW Image Section -->
                <div class="image-section">
                    <div class="image-section-title">
                        <div style="background: #3498db; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            PSW
                        </div>
                        <h4 style="margin: 0;">Part Submission Warrant</h4>
                    </div>
                    
                    <div class="image-container">
                        <img id="current-img-psw" src="imagenes/sin_foto.jpg" alt="PSW Preview">
                    </div>
                    
                    <input type="file" id="fileInputPSW" accept="image/*" style="display: none;">
                    <button id="btnSubirPSW" class="upload-btn btn-psw">
                        üì∏ UPLOAD PSW PHOTO
                    </button>
                    
                    <div id="upload-status-psw" class="upload-status"></div>
                    
                    <div class="file-info">
                        <strong>Format:</strong> Item_Date.jpg<br>
                        <strong>Example:</strong> 15_2024-01-27.jpg<br>
                        <strong>Max:</strong> 10MB | <strong>Formats:</strong> JPG, PNG, GIF
                    </div>
                </div>
                
                <!-- PV Image Section -->
                <div class="image-section">
                    <div class="image-section-title">
                        <div style="background: #9b59b6; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            PV
                        </div>
                        <h4 style="margin: 0;">Process Validation</h4>
                    </div>
                    
                    <div class="image-container">
                        <img id="current-img-pv" src="imagenes/sin_foto.jpg" alt="PV Preview">
                    </div>
                    
                    <input type="file" id="fileInputPV" accept="image/*" style="display: none;">
                    <button id="btnSubirPV" class="upload-btn btn-pv">
                        üì∏ UPLOAD PV PHOTO
                    </button>
                    
                    <div id="upload-status-pv" class="upload-status"></div>
                    
                    <div class="file-info">
                        <strong>Format:</strong> Item-2-Date.jpg<br>
                        <strong>Example:</strong> 15-2-2024-01-27.jpg<br>
                        <strong>Max:</strong> 10MB | <strong>Formats:</strong> JPG, PNG, GIF
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: #3498db; font-size: 14px;">üìã Image Notes</h4>
                    <ul style="font-size: 11px; color: #555; margin: 0; padding-left: 15px;">
                        <li>PSW = Part Submission Warrant (Standard format)</li>
                        <li>PV = Process Validation (Validation format)</li>
                        <li>Both images will be saved with today's date</li>
                        <li>Images are stored separately in Google Drive</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- CORPORATE FOOTER -->
    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">¬© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { db, checkAuth, redirectIfNoPermission } from './config.js';
        import { collection, query, where, getDocs, doc, setDoc, addDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Show current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        
        // Show current user
        const user = checkAuth();
        if(user) {
            document.getElementById('current-user-display').textContent = `üë§ ${user.usuario}`;
        }

        // Verify update permission
        if (!redirectIfNoPermission('actualizar')) {
            // Already redirects automatically
        }
        
        const scriptURL = "https://script.google.com/macros/s/AKfycbz-zqhnPq-ZCVv1miDE8lF6WkKfTrw4KMj2ikRm8ZYkncyOpSG0VAqEkbfbnThTIdmb/exec";

        let currentId = null;
        let itemActual = null;
        
        // DB FIELDS (EXACTLY as specified)
        const camposDB = [
            "Item #",
            "PPAP Part Number",
            "Component description",
            "Reason for Change",
            "Product type",
            "PRP5/Area",
            "OE/AFTERMARKET",
            "documentation",
            "Samples received",
            "Location",
            "Dimensional",
            "Special instruccions",
            "Validation date",
            "Programmer",
            "Quality Lead",
            "Reason",
            "Comments(detalle)",
            "Responsible",
            "Estatus",
            "Revision",
            "PPAP type OE / SM\nAfter Market",
            "1 Design records",
            "2\nECN document",
            "3\nCustomer eng approval",
            "4\nDesign FMEA",
            "5\nProcess Flow Diagram",
            "6\nPFMEA",
            "7\nControl Plan",
            "8\nMSA Studies",
            "9\nDimensional results",
            "10\nMaterial, performance test result",
            "11\nInitial Process Studies",
            "12\nQualify Lab Documentation",
            "13\nAppereance Approval Report",
            "14\nSample product",
            "15\nChecking Aids",
            "16\nRecord of compliance",
            "17\nBulk material checklist",
            "18\nPSW\n(Full or Interim)",
            "Supplier PPAP package status",
            "Validation run readiness",
            "Samples on hand",
            "Dimension status",
            "FFF review status",
            "AAR review status",
            "PPAP overall status"
        ];

        // UI NAMES (replace line breaks with spaces for display)
        const camposUI = camposDB.map(field => field.replace(/\n/g, " "));

        // Important fields (to highlight)
        const importantFields = ["Item #", "Estatus", "PPAP overall status", "PPAP Part Number", "Revision"];

        // Function to create safe ID
        function createSafeId(fieldName) {
            return fieldName.replace(/\n/g, "_").replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "");
        }

        // Function to validate PPAP Part Number
        window.validarPPAPPartNumber = function(input) {
            const valor = input.value.trim();
            const statusValues = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
            
            if (statusValues.includes(valor)) {
                input.classList.add("ppap-validation-error");
                input.classList.remove("ppap-validation-ok");
                input.title = "‚ö†Ô∏è PPAP Part Number should be a part number (like P-001), not a status";
                return false;
            } else if (valor) {
                input.classList.add("ppap-validation-ok");
                input.classList.remove("ppap-validation-error");
                input.title = "‚úì Valid part number";
                return true;
            } else {
                input.classList.remove("ppap-validation-ok", "ppap-validation-error");
                input.title = "";
                return false;
            }
        };

        // Function to load images for an item
        async function loadImages(itemNumber) {
            if (!itemNumber) return;
            
            const hoy = new Date().toISOString().split('T')[0];
            const nombreArchivoPSW = `${itemNumber}_${hoy}`;
            const nombreArchivoPV = `${itemNumber}-2-${hoy}`;
            
            // Load PSW image
            try {
                const imgResponsePSW = await fetch(`${scriptURL}?itemName=${nombreArchivoPSW}`);
                const imgDataPSW = await imgResponsePSW.json();
                if(imgDataPSW.result === "success" && imgDataPSW.id) {
                    document.getElementById('current-img-psw').src = `https://lh3.googleusercontent.com/d/${imgDataPSW.id}`;
                    document.getElementById('upload-status-psw').innerHTML = `<span style="color:#27ae60;">‚úÖ PSW image found for today</span>`;
                } else {
                    document.getElementById('current-img-psw').src = "imagenes/sin_foto.jpg";
                    document.getElementById('upload-status-psw').innerHTML = `<span style="color:#7f8c8d;">No PSW image for today</span>`;
                }
            } catch (imgError) {
                document.getElementById('current-img-psw').src = "imagenes/sin_foto.jpg";
                document.getElementById('upload-status-psw').innerHTML = `<span style="color:#7f8c8d;">Error loading PSW image</span>`;
            }
            
            // Load PV image
            try {
                const imgResponsePV = await fetch(`${scriptURL}?itemName=${nombreArchivoPV}`);
                const imgDataPV = await imgResponsePV.json();
                if(imgDataPV.result === "success" && imgDataPV.id) {
                    document.getElementById('current-img-pv').src = `https://lh3.googleusercontent.com/d/${imgDataPV.id}`;
                    document.getElementById('upload-status-pv').innerHTML = `<span style="color:#27ae60;">‚úÖ PV image found for today</span>`;
                } else {
                    document.getElementById('current-img-pv').src = "imagenes/sin_foto.jpg";
                    document.getElementById('upload-status-pv').innerHTML = `<span style="color:#7f8c8d;">No PV image for today</span>`;
                }
            } catch (imgError) {
                document.getElementById('current-img-pv').src = "imagenes/sin_foto.jpg";
                document.getElementById('upload-status-pv').innerHTML = `<span style="color:#7f8c8d;">Error loading PV image</span>`;
            }
        }

        // SEARCH ITEM
        document.getElementById('btnBuscar').onclick = async () => {
            const val = document.getElementById('searchItem').value.trim();
            if(!val) {
                alert("Please enter an Item number");
                return;
            }

            // Show loading
            const btnBuscar = document.getElementById('btnBuscar');
            btnBuscar.innerHTML = "üîç SEARCHING...";
            btnBuscar.disabled = true;

            try {
                const q = query(collection(db, "productos"), where("Item #", "==", val));
                const snap = await getDocs(q);

                if(snap.empty) {
                    alert("‚ùå Item not found. Check the number and try again.");
                    resetForm();
                    return;
                }

                const d = snap.docs[0];
                currentId = d.id;
                const data = d.data();
                itemActual = data["Item #"];

                // Show current information
                document.getElementById('current-info').style.display = 'block';
                document.getElementById('current-item-display').textContent = itemActual;
                
                // Show current status with color
                const currentStatus = data["PPAP overall status"] || "No status";
                const statusDisplay = document.getElementById('current-status-display');
                statusDisplay.textContent = currentStatus;
                
                // Apply color class based on status
                statusDisplay.className = "current-status ";
                if (currentStatus.toLowerCase().includes("approved") || currentStatus.toLowerCase().includes("aprobado")) {
                    statusDisplay.classList.add("status-approved");
                } else if (currentStatus.toLowerCase().includes("pending") || currentStatus.toLowerCase().includes("pendiente")) {
                    statusDisplay.classList.add("status-pending");
                } else if (currentStatus.toLowerCase().includes("rejected") || currentStatus.toLowerCase().includes("rechazado")) {
                    statusDisplay.classList.add("status-rejected");
                } else {
                    statusDisplay.classList.add("status-inprogress");
                }

                // Find last update
                try {
                    const historyQuery = query(
                        collection(db, "movimientos"),
                        where("detalle", "==", `Item: ${itemActual}`),
                        orderBy("fecha", "desc"),
                        limit(1)
                    );
                    const historySnap = await getDocs(historyQuery);
                    if (!historySnap.empty) {
                        const lastUpdate = historySnap.docs[0].data();
                        const lastDate = lastUpdate.fecha ? 
                            new Date(lastUpdate.fecha.seconds * 1000).toLocaleDateString() : 
                            "Unknown date";
                        document.getElementById('last-update').textContent = `Last modification: ${lastDate}`;
                    }
                } catch (historyError) {
                    console.log("Could not get history:", historyError);
                }

                // Generate edit form
                const form = document.getElementById('edit-form');
                form.innerHTML = '';
                
                camposDB.forEach((campoDB, index) => {
                    const campoUI = camposUI[index];
                    const div = document.createElement('div');
                    div.className = importantFields.includes(campoDB) ? 'field-group' : '';
                    
                    // Determine if required field
                    const isRequired = importantFields.includes(campoDB);
                    const safeId = createSafeId(campoDB);
                    
                    // For status fields, use select
                    if (campoDB === "PPAP overall status" || campoDB === "Estatus") {
                        const options = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
                        const currentValue = data[campoDB] || "";
                        
                        div.innerHTML = `
                            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;">
                                ${campoUI}${isRequired ? '<span style="color:#e74c3c;"> *</span>' : ''}
                            </label>
                            <select id="upd_${safeId}" class="status-select" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                                <option value="">Select status...</option>
                                ${options.map(opt => 
                                    `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        `;
                    } else if (campoDB === "PPAP Part Number") {
                        // PPAP Part Number MUST BE TEXT INPUT, NOT SELECT
                        div.innerHTML = `
                            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;">
                                ${campoUI}${isRequired ? '<span style="color:#e74c3c;"> *</span>' : ''}
                            </label>
                            <input type="text" 
                                   id="upd_${safeId}" 
                                   value="${data[campoDB] || ''}" 
                                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:13px;"
                                   placeholder="Example: P-001, 12345-ABC, ABC-2024"
                                   onkeyup="validarPPAPPartNumber(this)">
                        `;
                    } else {
                        div.innerHTML = `
                            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;">
                                ${campoUI}${isRequired ? '<span style="color:#e74c3c;"> *</span>' : ''}
                            </label>
                            <input type="text" 
                                   id="upd_${safeId}" 
                                   value="${data[campoDB] || ''}" 
                                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:13px;"
                                   ${campoDB === "Item #" ? 'readonly style="background:#f5f5f5;"' : ''}>
                        `;
                    }
                    
                    form.appendChild(div);
                });

                form.style.display = 'grid';
                document.getElementById('action-buttons').style.display = 'block';
                document.getElementById('btnSubirPSW').style.display = 'block';
                document.getElementById('btnSubirPV').style.display = 'block';

                // Validate PPAP Part Number initially
                const ppapInput = document.getElementById('upd_PPAP_Part_Number');
                if (ppapInput) {
                    validarPPAPPartNumber(ppapInput);
                }

                // Load images
                await loadImages(itemActual);

                // Smooth scroll to form
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch(error) {
                console.error("Error searching:", error);
                alert("Error connecting to database. Try again.");
            } finally {
                btnBuscar.innerHTML = "SEARCH ITEM";
                btnBuscar.disabled = false;
            }
        };

        // Function to reset form
        function resetForm() {
            document.getElementById('edit-form').innerHTML = '';
            document.getElementById('edit-form').style.display = 'none';
            document.getElementById('action-buttons').style.display = 'none';
            document.getElementById('current-info').style.display = 'none';
            document.getElementById('btnSubirPSW').style.display = 'none';
            document.getElementById('btnSubirPV').style.display = 'none';
            document.getElementById('current-img-psw').src = "imagenes/sin_foto.jpg";
            document.getElementById('current-img-pv').src = "imagenes/sin_foto.jpg";
            document.getElementById('upload-status-psw').textContent = '';
            document.getElementById('upload-status-pv').textContent = '';
            currentId = null;
            itemActual = null;
        }

        // Cancel edit
        document.getElementById('btnCancel').onclick = resetForm;

        // DRIVE LOGIC - PSW UPLOAD
        document.getElementById('btnSubirPSW').onclick = () => {
            if (!itemActual) {
                alert("First search for an Item to update");
                return;
            }
            document.getElementById('fileInputPSW').click();
        };

        document.getElementById('fileInputPSW').onchange = function() {
            uploadImage(this.files[0], 'PSW');
        };

        // DRIVE LOGIC - PV UPLOAD
        document.getElementById('btnSubirPV').onclick = () => {
            if (!itemActual) {
                alert("First search for an Item to update");
                return;
            }
            document.getElementById('fileInputPV').click();
        };

        document.getElementById('fileInputPV').onchange = function() {
            uploadImage(this.files[0], 'PV');
        };

        // Generic image upload function
        async function uploadImage(file, imageType) {
            if (!file) return;

            // Validate size (maximum 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert("Image is too large. Maximum 10MB.");
                return;
            }

            // Validate type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/jpg'];
            if (!validTypes.includes(file.type)) {
                alert("Invalid format. Use JPG, PNG or GIF.");
                return;
            }

            const reader = new FileReader();
            const hoy = new Date().toISOString().slice(0, 10);
            let nombreArchivo = '';
            let btnId = '';
            let statusId = '';
            let imgId = '';
            let actionType = '';

            if (imageType === 'PSW') {
                nombreArchivo = `${itemActual}_${hoy}`;
                btnId = 'btnSubirPSW';
                statusId = 'upload-status-psw';
                imgId = 'current-img-psw';
                actionType = 'PSW Image Updated';
            } else {
                nombreArchivo = `${itemActual}-2-${hoy}`;
                btnId = 'btnSubirPV';
                statusId = 'upload-status-pv';
                imgId = 'current-img-pv';
                actionType = 'PV Image Updated';
            }

            reader.onload = async function() {
                const base64 = reader.result.split(',')[1];
                const btn = document.getElementById(btnId);
                const status = document.getElementById(statusId);

                btn.innerHTML = "‚è≥ UPLOADING...";
                btn.disabled = true;
                status.innerHTML = `<span style="color:#f39c12;">‚è≥ Processing ${imageType} image...</span>`;

                try {
                    const res = await fetch(scriptURL, { 
                        method: "POST", 
                        body: JSON.stringify({ 
                            itemName: nombreArchivo, 
                            imageB64: base64 
                        }) 
                    });
                    const resData = await res.json();

                    if(resData.result === "success") {
                        // Show uploaded image
                        document.getElementById(imgId).src = `https://lh3.googleusercontent.com/d/${resData.id}`;
                        status.innerHTML = `<span style="color:#27ae60;">‚úÖ ${imageType} image uploaded successfully</span>`;
                        
                        // Record in history
                        await addDoc(collection(db, "movimientos"), {
                            usuario: user.usuario,
                            accion: actionType,
                            detalle: `Item: ${itemActual} (${imageType} - ${hoy})`,
                            fecha: serverTimestamp()
                        });

                        alert(`‚úÖ ${imageType} image saved correctly`);
                    } else {
                        throw new Error("Server error");
                    }
                } catch(e) { 
                    console.error(e);
                    status.innerHTML = `<span style="color:#e74c3c;">‚ùå Error uploading ${imageType} image</span>`;
                    alert(`Error uploading ${imageType} image. Try again.`);
                } finally { 
                    btn.innerHTML = imageType === 'PSW' ? "üì∏ UPLOAD PSW PHOTO" : "üì∏ UPLOAD PV PHOTO"; 
                    btn.disabled = false; 
                    if (imageType === 'PSW') {
                        document.getElementById('fileInputPSW').value = '';
                    } else {
                        document.getElementById('fileInputPV').value = '';
                    }
                }
            };
            reader.readAsDataURL(file);
        }

        // UPDATE FIRESTORE
        document.getElementById('btnUpdate').onclick = async () => {
            if (!currentId) {
                alert("First search for a record to update");
                return;
            }

            // VALIDATE PPAP Part Number
            const ppapPartNumberInput = document.getElementById('upd_PPAP_Part_Number');
            if (ppapPartNumberInput) {
                const ppapValue = ppapPartNumberInput.value.trim();
                const statusValues = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
                
                if (statusValues.includes(ppapValue)) {
                    alert("‚ùå ERROR: 'PPAP Part Number' must be a part number (like P-001, ABC-123), not a status like '" + ppapValue + "'");
                    ppapPartNumberInput.focus();
                    ppapPartNumberInput.classList.add("ppap-validation-error");
                    return;
                }
            }

            // Validate important fields
            const importantValues = {};
            let hasError = false;
            importantFields.forEach(field => {
                const safeId = createSafeId(field);
                const element = document.getElementById(`upd_${safeId}`);
                if (element) {
                    const value = element.tagName === 'SELECT' ? element.value : element.value.trim();
                    importantValues[field] = value;
                    if (field !== "Item #" && !value) {
                        alert(`Field "${field}" is required`);
                        hasError = true;
                        element.style.borderColor = "#e74c3c";
                        element.focus();
                    } else {
                        element.style.borderColor = "#ddd";
                    }
                }
            });

            if (hasError) return;

            // Confirm update
            if (!confirm("Are you sure you want to update this record? Changes will be saved in history.")) {
                return;
            }

            const newData = {};
            camposDB.forEach(c => {
                const safeId = createSafeId(c);
                const element = document.getElementById(`upd_${safeId}`);
                if (element) {
                    newData[c] = element.tagName === 'SELECT' ? element.value : element.value.trim();
                }
            });

            const btnUpdate = document.getElementById('btnUpdate');
            btnUpdate.innerHTML = "‚è≥ SAVING...";
            btnUpdate.disabled = true;

            try {
                // Update in Firestore
                await setDoc(doc(db, "productos", currentId), newData, { merge: true });
                
                // Record in history
                await addDoc(collection(db, "movimientos"), {
                    usuario: user.usuario,
                    accion: "PPAP Update",
                    detalle: `Item: ${itemActual} | PPAP: ${newData["PPAP Part Number"] || 'No PPAP'} | Revision: ${newData["Revision"] || 'N/A'}`,
                    statusMomento: newData["PPAP overall status"],
                    fecha: serverTimestamp()
                });

                alert("‚úÖ Record updated successfully");
                location.href = 'index.html';
            } catch(e) { 
                console.error("Error updating:", e);
                alert("‚ùå Error updating in database"); 
            } finally {
                btnUpdate.innerHTML = "üíæ SAVE CHANGES";
                btnUpdate.disabled = false;
            }
        };

        // Allow search with Enter
        document.getElementById('searchItem').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('btnBuscar').click();
            }
        });

        // Show initial help
        window.addEventListener('load', function() {
            document.getElementById('searchItem').focus();
        });
    </script>
</body>
</html>
