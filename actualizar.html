<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update PPAP - Master Track</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .status-select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 14px;
            width: 100%;
            background: white;
            color: #333;
        }
        .status-approved { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-pending { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .status-rejected { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-inprogress { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .field-group {
            padding: 8px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .required-field::after {
            content: " *";
            color: #e74c3c;
        }
        #edit-form {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }
        #edit-form::-webkit-scrollbar {
            width: 8px;
        }
        #edit-form::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }
        #edit-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .current-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
        .ppap-validation-ok {
            border-color: #27ae60 !important;
            background-color: #f0fff4 !important;
        }
        .ppap-validation-error {
            border-color: #e74c3c !important;
            background-color: #ffe6e6 !important;
        }
    </style>
</head>
<body class="bg-blue">
    <!-- CORPORATE HEADER -->
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            <div>
                <h1>PPAP Master Track System</h1>
                <div class="subtitle">SMP Engine Management, S. de R.L. de C.V</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">üë§ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>

    <header><h1>Update PPAP Record</h1></header>
    
    <div style="padding: 20px; max-width: 1000px; margin: auto;">
        <div style="background: white; border-radius: 10px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: grid; grid-template-columns: 1fr 350px; gap: 25px;">
            
            <!-- Left column - Form -->
            <div>
                <h2 style="margin-bottom: 25px; color: #2c3e50; display: flex; align-items: center; justify-content: space-between;">
                    <span>üìù Update Record</span>
                    <button onclick="location.href='index.html'" style="padding: 8px 15px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                        ‚Üê BACK
                    </button>
                </h2>
                
                <div style="margin-bottom: 25px; display: flex; gap: 10px; align-items: center;">
                    <div style="flex: 1; position: relative;">
                        <input type="text" id="searchItem" placeholder="Enter Item # to search..." style="width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #7f8c8d; font-size: 12px;">üîç</span>
                    </div>
                    <button id="btnBuscar" style="padding: 14px 25px; background: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap;">
                        SEARCH ITEM
                    </button>
                </div>

                <div id="current-info" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #3498db;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #2c3e50;">Item: <span id="current-item-display" style="font-weight: bold;"></span></h4>
                            <p style="margin: 0; font-size: 13px; color: #7f8c8d;">Current status: 
                                <span id="current-status-display" class="current-status status-pending">Loading...</span>
                            </p>
                        </div>
                        <div id="last-update" style="font-size: 11px; color: #95a5a6;"></div>
                    </div>
                </div>

                <div id="edit-form" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                    <!-- Fields generated dynamically -->
                </div>

                <div id="action-buttons" style="display: none;">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <button id="btnUpdate" style="flex: 3; padding: 16px; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px;">
                            üíæ SAVE CHANGES
                        </button>
                        <button id="btnCancel" style="flex: 1; padding: 16px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            CANCEL
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #7f8c8d; text-align: center; margin: 0;">
                        ‚ö†Ô∏è Changes will be recorded in the system history
                    </p>
                </div>
            </div>

            <!-- Right column - Images -->
            <div style="border-left: 1px solid #eee; padding-left: 25px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üñºÔ∏è Image Management</h3>
                    <p style="font-size: 13px; color: #7f8c8d; margin-bottom: 20px;">
                        Upload an image for this PPAP version. It will be saved with today's date.
                    </p>
                </div>

                <div style="width: 100%; height: 250px; border: 2px dashed #3498db; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; background: #f8f9fa; overflow: hidden;">
                    <img id="current-img" src="imagenes/sin_foto.jpg" style="max-width: 100%; max-height: 100%; object-fit: contain; transition: opacity 0.3s;">
                </div>
                
                <div style="text-align: center;">
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    <button id="btnSubirDrive" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; margin-bottom: 10px;">
                        üì∏ UPLOAD NEW PHOTO
                    </button>
                    <p id="upload-status" style="font-size: 12px; color: #666; margin-top: 10px; min-height: 20px;"></p>
                    
                    <div style="margin-top: 25px; padding: 15px; background: #f0f7ff; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; color: #3498db; font-size: 14px;">üìã Image Information</h4>
                        <p style="font-size: 11px; color: #555; margin: 0;">
                            ‚Ä¢ Format: <code>Item_Date.jpg</code><br>
                            ‚Ä¢ Example: <code>15_2024-01-27.jpg</code><br>
                            ‚Ä¢ Maximum: 10MB per image<br>
                            ‚Ä¢ Formats: JPG, PNG, GIF
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CORPORATE FOOTER -->
    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">¬© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { db, checkAuth, redirectIfNoPermission } from './config.js';
        import { collection, query, where, getDocs, doc, setDoc, addDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Show current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        
        // Show current user
        const user = checkAuth();
        if(user) {
            document.getElementById('current-user-display').textContent = `üë§ ${user.usuario}`;
        }

        // Verify update permission
        if (!redirectIfNoPermission('actualizar')) {
            // Already redirects automatically
        }
        
        const scriptURL = "https://script.google.com/macros/s/AKfycbz-zqhnPq-ZCVv1miDE8lF6WkKfTrw4KMj2ikRm8ZYkncyOpSG0VAqEkbfbnThTIdmb/exec";

        let currentId = null;
        let itemActual = null;
        
        // DB FIELDS (for saving/updating)
        const camposDB = [
            "Item #", "Estatus", "Programador", "PPAP Part Number", "Component Description",
            "Razon de Cambio", "PRP5/area", "Lider de Calidad", " OE/AFTERMARKET ", 
            "Se entrego documentacion", "Muestras Recibidas", "Ubicacion Fisica ",
            "Fecha de Programacion", "Proceso", "Update", "Comments", "Responsable",
            "Instrucciones Especiales", "PPAP Type OE / SM AFTER Market", "PV Result",
            "1-Design records", "2-ECN document", "3-Customer eng approval", "4-Design FMEA",
            "5-Process Flow Diagram", "6-PFMEA", "7-Control Plan", "8-MSA Studies",
            "9-Dimensional results", "10-Material, performance test result",
            "11-Initial Process Studies", "12-Qualify Lab Documentation",
            "13-Appereance Approval Report", "14-Sample product", "15-Checking Aids",
            "16-Record de compliance", "17-Bulk material checklist", "18-PSW(Full or Interim)",
            "Supplier PPAP package status", "Validation run readiness", "Samples on hand",
            "Dimension status", "FFF review status", "AAR review status", "PPAP overall status"
        ];

        // NEW NAMES FOR UI (labels)
        const camposUI = [
            "Item #", 
            "Estatus", 
            "Programmer", 
            "PPAP Part Number", 
            "Component description", 
            "Reason for Change", 
            "PRP5/Area", 
            "Quality Lead", 
            "OE/AFTERMARKET", 
            "documentation", 
            "Samples received", 
            "Location", 
            "Validation date", 
            "Process", 
            "Update", 
            "Comments(detalle)", 
            "Responsible", 
            "Special instruccions", 
            "PPAP type OE / SM After Market", 
            "PV Result",
            "1 Design records", 
            "2 ECN document", 
            "3 Customer eng approval", 
            "4 Design FMEA",
            "5 Process Flow Diagram", 
            "6 PFMEA", 
            "7 Control Plan", 
            "8 MSA Studies",
            "9 Dimensional results", 
            "10 Material, performance test result",
            "11 Initial Process Studies", 
            "12 Qualify Lab Documentation",
            "13 Appereance Approval Report", 
            "14 Sample product", 
            "15 Checking Aids",
            "16 Record of compliance", 
            "17 Bulk material checklist", 
            "18 PSW (Full or Interim)",
            "Supplier PPAP package status", 
            "Validation run readiness", 
            "Samples on hand",
            "Dimension status", 
            "FFF review status", 
            "AAR review status", 
            "PPAP overall status"
        ];

        // Important fields (to highlight)
        const importantFields = ["Item #", "Estatus", "PPAP overall status", "PPAP Part Number"];

        // Funci√≥n para validar PPAP Part Number
        window.validarPPAPPartNumber = function(input) {
            const valor = input.value.trim();
            const statusValues = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
            
            if (statusValues.includes(valor)) {
                input.classList.add("ppap-validation-error");
                input.classList.remove("ppap-validation-ok");
                input.title = "‚ö†Ô∏è PPAP Part Number should be a part number (like P-001), not a status";
                return false;
            } else if (valor) {
                input.classList.add("ppap-validation-ok");
                input.classList.remove("ppap-validation-error");
                input.title = "‚úì Valid part number";
                return true;
            } else {
                input.classList.remove("ppap-validation-ok", "ppap-validation-error");
                input.title = "";
                return false;
            }
        };

        // SEARCH ITEM
        document.getElementById('btnBuscar').onclick = async () => {
            const val = document.getElementById('searchItem').value.trim();
            if(!val) {
                alert("Please enter an Item number");
                return;
            }

            // Show loading
            const btnBuscar = document.getElementById('btnBuscar');
            btnBuscar.innerHTML = "üîç SEARCHING...";
            btnBuscar.disabled = true;

            try {
                const q = query(collection(db, "productos"), where("Item #", "==", val));
                const snap = await getDocs(q);

                if(snap.empty) {
                    alert("‚ùå Item not found. Check the number and try again.");
                    resetForm();
                    return;
                }

                const d = snap.docs[0];
                currentId = d.id;
                const data = d.data();
                itemActual = data["Item #"];

                // Show current information
                document.getElementById('current-info').style.display = 'block';
                document.getElementById('current-item-display').textContent = itemActual;
                
                // Show current status with color
                const currentStatus = data["PPAP overall status"] || "No status";
                const statusDisplay = document.getElementById('current-status-display');
                statusDisplay.textContent = currentStatus;
                
                // Apply color class based on status
                statusDisplay.className = "current-status ";
                if (currentStatus.toLowerCase().includes("approved") || currentStatus.toLowerCase().includes("aprobado")) {
                    statusDisplay.classList.add("status-approved");
                } else if (currentStatus.toLowerCase().includes("pending") || currentStatus.toLowerCase().includes("pendiente")) {
                    statusDisplay.classList.add("status-pending");
                } else if (currentStatus.toLowerCase().includes("rejected") || currentStatus.toLowerCase().includes("rechazado")) {
                    statusDisplay.classList.add("status-rejected");
                } else {
                    statusDisplay.classList.add("status-inprogress");
                }

                // Find last update
                try {
                    const historyQuery = query(
                        collection(db, "movimientos"),
                        where("detalle", "==", `Item: ${itemActual}`),
                        orderBy("fecha", "desc"),
                        limit(1)
                    );
                    const historySnap = await getDocs(historyQuery);
                    if (!historySnap.empty) {
                        const lastUpdate = historySnap.docs[0].data();
                        const lastDate = lastUpdate.fecha ? 
                            new Date(lastUpdate.fecha.seconds * 1000).toLocaleDateString() : 
                            "Unknown date";
                        document.getElementById('last-update').textContent = `Last modification: ${lastDate}`;
                    }
                } catch (historyError) {
                    console.log("Could not get history:", historyError);
                }

                // Generate edit form
                const form = document.getElementById('edit-form');
                form.innerHTML = '';
                
                camposDB.forEach((campoDB, index) => {
                    const campoUI = camposUI[index] || campoDB;
                    const div = document.createElement('div');
                    div.className = importantFields.includes(campoDB) ? 'field-group' : '';
                    
                    // Determine if required field
                    const isRequired = importantFields.includes(campoDB);
                    
                    // For status fields, use select
                    if (campoDB === "PPAP overall status" || campoDB === "Estatus") {
                        const options = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
                        const currentValue = data[campoDB] || "";
                        
                        div.innerHTML = `
                            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;">
                                ${campoUI}${isRequired ? '<span style="color:#e74c3c;"> *</span>' : ''}
                            </label>
                            <select id="upd-${campoDB}" class="status-select" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                                <option value="">Select status...</option>
                                ${options.map(opt => 
                                    `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        `;
                    } else if (campoDB === "PPAP Part Number") {
                        // PPAP Part Number DEBE SER INPUT DE TEXTO, NO SELECT
                        div.innerHTML = `
                            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;">
                                ${campoUI}${isRequired ? '<span style="color:#e74c3c;"> *</span>' : ''}
                            </label>
                            <input type="text" 
                                   id="upd-${campoDB}" 
                                   value="${data[campoDB] || ''}" 
                                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:13px;"
                                   placeholder="Example: P-001, 12345-ABC, ABC-2024"
                                   onkeyup="validarPPAPPartNumber(this)">
                        `;
                    } else {
                        div.innerHTML = `
                            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;">
                                ${campoUI}${isRequired ? '<span style="color:#e74c3c;"> *</span>' : ''}
                            </label>
                            <input type="text" 
                                   id="upd-${campoDB}" 
                                   value="${data[campoDB] || ''}" 
                                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:13px;"
                                   ${campoDB === "Item #" ? 'readonly style="background:#f5f5f5;"' : ''}>
                        `;
                    }
                    
                    form.appendChild(div);
                });

                form.style.display = 'grid';
                document.getElementById('action-buttons').style.display = 'block';
                document.getElementById('btnSubirDrive').style.display = 'block';

                // Validar PPAP Part Number inicialmente
                const ppapInput = document.getElementById('upd-PPAP Part Number');
                if (ppapInput) {
                    validarPPAPPartNumber(ppapInput);
                }

                // Update image if exists
                const hoy = new Date().toISOString().split('T')[0];
                const nombreArchivo = `${itemActual}_${hoy}`;
                try {
                    const imgResponse = await fetch(`${scriptURL}?itemName=${nombreArchivo}`);
                    const imgData = await imgResponse.json();
                    if(imgData.result === "success" && imgData.id) {
                        document.getElementById('current-img').src = `https://lh3.googleusercontent.com/d/${imgData.id}`;
                        document.getElementById('upload-status').innerHTML = `<span style="color:#27ae60;">‚úÖ Current image found</span>`;
                    } else {
                        document.getElementById('current-img').src = "imagenes/sin_foto.jpg";
                        document.getElementById('upload-status').innerHTML = `<span style="color:#7f8c8d;">No image for today</span>`;
                    }
                } catch (imgError) {
                    // No image, show default
                    document.getElementById('current-img').src = "imagenes/sin_foto.jpg";
                    document.getElementById('upload-status').innerHTML = `<span style="color:#7f8c8d;">Error loading image</span>`;
                }

                // Smooth scroll to form
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch(error) {
                console.error("Error searching:", error);
                alert("Error connecting to database. Try again.");
            } finally {
                btnBuscar.innerHTML = "SEARCH ITEM";
                btnBuscar.disabled = false;
            }
        };

        // Function to reset form
        function resetForm() {
            document.getElementById('edit-form').innerHTML = '';
            document.getElementById('edit-form').style.display = 'none';
            document.getElementById('action-buttons').style.display = 'none';
            document.getElementById('current-info').style.display = 'none';
            document.getElementById('btnSubirDrive').style.display = 'none';
            document.getElementById('current-img').src = "imagenes/sin_foto.jpg";
            document.getElementById('upload-status').textContent = '';
            currentId = null;
            itemActual = null;
        }

        // Cancel edit
        document.getElementById('btnCancel').onclick = resetForm;

        // DRIVE LOGIC (UPLOAD PHOTO)
        document.getElementById('btnSubirDrive').onclick = () => {
            if (!itemActual) {
                alert("First search for an Item to update");
                return;
            }
            document.getElementById('fileInput').click();
        };

        document.getElementById('fileInput').onchange = function() {
            const file = this.files[0];
            if (!file) return;

            // Validate size (maximum 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert("Image is too large. Maximum 10MB.");
                return;
            }

            // Validate type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/jpg'];
            if (!validTypes.includes(file.type)) {
                alert("Invalid format. Use JPG, PNG or GIF.");
                return;
            }

            const reader = new FileReader();
            const btn = document.getElementById('btnSubirDrive');
            const status = document.getElementById('upload-status');

            reader.onload = async function() {
                const base64 = reader.result.split(',')[1];
                const hoy = new Date().toISOString().slice(0, 10);
                const nombreArchivo = `${itemActual}_${hoy}`;

                btn.innerHTML = "‚è≥ UPLOADING...";
                btn.disabled = true;
                status.innerHTML = `<span style="color:#f39c12;">‚è≥ Processing image...</span>`;

                try {
                    const res = await fetch(scriptURL, { 
                        method: "POST", 
                        body: JSON.stringify({ 
                            itemName: nombreArchivo, 
                            imageB64: base64 
                        }) 
                    });
                    const resData = await res.json();

                    if(resData.result === "success") {
                        // Show uploaded image
                        document.getElementById('current-img').src = `https://lh3.googleusercontent.com/d/${resData.id}`;
                        document.getElementById('current-img').style.opacity = "1";
                        
                        status.innerHTML = `<span style="color:#27ae60;">‚úÖ Image uploaded successfully to Drive</span>`;
                        
                        // Record in history
                        await addDoc(collection(db, "movimientos"), {
                            usuario: user.usuario,
                            accion: "Image Updated",
                            detalle: `Item: ${itemActual} (Version: ${hoy})`,
                            fecha: serverTimestamp()
                        });

                        alert("‚úÖ Image saved correctly to Drive");
                    } else {
                        throw new Error("Server error");
                    }
                } catch(e) { 
                    console.error(e);
                    status.innerHTML = `<span style="color:#e74c3c;">‚ùå Error uploading image</span>`;
                    alert("Error uploading image. Try again.");
                } finally { 
                    btn.innerHTML = "üì∏ UPLOAD NEW PHOTO"; 
                    btn.disabled = false; 
                    document.getElementById('fileInput').value = '';
                }
            };
            reader.readAsDataURL(file);
        };

        // UPDATE FIRESTORE
        document.getElementById('btnUpdate').onclick = async () => {
            if (!currentId) {
                alert("First search for a record to update");
                return;
            }

            // VALIDAR PPAP Part Number
            const ppapPartNumberInput = document.getElementById('upd-PPAP Part Number');
            if (ppapPartNumberInput) {
                const ppapValue = ppapPartNumberInput.value.trim();
                const statusValues = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
                
                if (statusValues.includes(ppapValue)) {
                    alert("‚ùå ERROR: 'PPAP Part Number' must be a part number (like P-001, ABC-123), not a status like '" + ppapValue + "'");
                    ppapPartNumberInput.focus();
                    ppapPartNumberInput.classList.add("ppap-validation-error");
                    return;
                }
            }

            // Validate important fields
            const importantValues = {};
            let hasError = false;
            importantFields.forEach(field => {
                const element = document.getElementById(`upd-${field}`);
                if (element) {
                    const value = element.tagName === 'SELECT' ? element.value : element.value.trim();
                    importantValues[field] = value;
                    if (field !== "Item #" && !value) {
                        alert(`Field "${field}" is required`);
                        hasError = true;
                        element.style.borderColor = "#e74c3c";
                        element.focus();
                    } else {
                        element.style.borderColor = "#ddd";
                    }
                }
            });

            if (hasError) return;

            // Confirm update
            if (!confirm("Are you sure you want to update this record? Changes will be saved in history.")) {
                return;
            }

            const newData = {};
            camposDB.forEach(c => {
                const element = document.getElementById(`upd-${c}`);
                if (element) {
                    newData[c] = element.tagName === 'SELECT' ? element.value : element.value.trim();
                }
            });

            const btnUpdate = document.getElementById('btnUpdate');
            btnUpdate.innerHTML = "‚è≥ SAVING...";
            btnUpdate.disabled = true;

            try {
                // Update in Firestore
                await setDoc(doc(db, "productos", currentId), newData, { merge: true });
                
                // Record in history
                await addDoc(collection(db, "movimientos"), {
                    usuario: user.usuario,
                    accion: "PPAP Update",
                    detalle: `Item: ${itemActual} | PPAP: ${newData["PPAP Part Number"] || 'No PPAP'}`,
                    statusMomento: newData["PPAP overall status"],
                    fecha: serverTimestamp()
                });

                alert("‚úÖ Record updated successfully");
                location.href = 'index.html';
            } catch(e) { 
                console.error("Error updating:", e);
                alert("‚ùå Error updating in database"); 
            } finally {
                btnUpdate.innerHTML = "üíæ SAVE CHANGES";
                btnUpdate.disabled = false;
            }
        };

        // Allow search with Enter
        document.getElementById('searchItem').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('btnBuscar').click();
            }
        });

        // Show initial help
        window.addEventListener('load', function() {
            document.getElementById('searchItem').focus();
        });
    </script>
</body>
</html>