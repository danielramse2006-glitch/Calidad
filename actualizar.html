<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"><title>Actualizar PPAP - Master Track</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-blue">
    <div style="padding:20px; max-width:1000px; margin:auto; background:white; color:black; border-radius:10px; display:grid; grid-template-columns: 1fr 350px; gap:20px; margin-top:20px;">
        
        <div>
            <h2>Actualizar Registro</h2>
            <div style="margin-bottom:20px; display:flex; gap:10px;">
                <input type="text" id="searchItem" placeholder="Ingrese Item #..." style="flex:1; padding:12px; border:1px solid #ccc; border-radius:5px;">
                <button id="btnBuscar" style="padding:10px; width:100px; cursor:pointer; background:#2c3e50; color:white; border:none; border-radius:5px;">BUSCAR</button>
            </div>

            <div id="edit-form" style="display:none; grid-template-columns:1fr 1fr; gap:10px; max-height:500px; overflow-y:auto; padding-right:10px; border-top:1px solid #eee; pt:15px;">
                </div>

            <button id="btnUpdate" style="display:none; width:100%; margin-top:20px; padding:15px; background:#f39c12; color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">ACTUALIZAR DATOS EN FIREBASE</button>
        </div>

        <div style="border-left:1px solid #eee; padding-left:20px; text-align:center;">
            <h3>Imagen de la Versi贸n</h3>
            <div style="width:100%; height:250px; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; margin-bottom:10px; background:#f9f9f9; overflow:hidden;">
                <img id="current-img" src="imagenes/sin_foto.jpg" style="max-width:100%; max-height:100%; object-fit: contain;">
            </div>
            
            <input type="file" id="fileInput" accept="image/*" style="display:none;">
            <button id="btnSubirDrive" style="width:100%; padding:10px; background:#27ae60; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; display:none;">
                 SUBIR/CAMBIAR FOTO
            </button>
            <p id="upload-status" style="font-size:12px; color:#666; margin-top:5px;"></p>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, query, where, getDocs, doc, setDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const user = checkAuth();
        const scriptURL = "https://script.google.com/macros/s/AKfycbz-zqhnPq-ZCVv1miDE8lF6WkKfTrw4KMj2ikRm8ZYkncyOpSG0VAqEkbfbnThTIdmb/exec";

        let currentId = null;
        let itemActual = null;
        const campos = ["Item #","Estatus","Programador","PPAP Part Number","Component Description","Razon para el cambio","Nivel de Submission","Target Date","Recibido","1-Design Record","2-Engineering change document","3-Customer Engineering Approval","4-DFMEA","5-Process Flow Diagram","6-PFMEA","7-Control Plan","8-MSA","9-Dimensional results","10-Material/Performance Test","11-Initial Process Studies","12-Qualified Lab Documentation","13-Appearance Approval Report","14-Sample product","15-Checking Aids","16-Record de compliance","17-Bulk material checklist","18-PSW(Full or Interim)","Supplier PPAP package status","Validation run readiness","Samples on hand","Dimension status","FFF review status","AAR review status","PPAP overall status"];

        // BUSCAR
        document.getElementById('btnBuscar').onclick = async () => {
            const val = document.getElementById('searchItem').value.trim();
            if(!val) return;

            const q = query(collection(db, "productos"), where("Item #", "==", val));
            const snap = await getDocs(q);

            if(snap.empty) {
                alert("No se encontr贸 el Item.");
                return;
            }

            const d = snap.docs[0];
            currentId = d.id;
            const data = d.data();
            itemActual = data["Item #"];

            const form = document.getElementById('edit-form');
            form.innerHTML = '';
            campos.forEach(c => {
                const div = document.createElement('div');
                div.innerHTML = `<label style="font-size:11px; font-weight:bold; display:block;">${c}</label>
                                 <input type="text" id="upd-${c}" value="${data[c] || ''}" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;">`;
                form.appendChild(div);
            });

            form.style.display = 'grid';
            document.getElementById('btnUpdate').style.display = 'block';
            document.getElementById('btnSubirDrive').style.display = 'block';
        };

        // LGICA DE DRIVE (SUBIR FOTO)
        document.getElementById('btnSubirDrive').onclick = () => document.getElementById('fileInput').click();

        document.getElementById('fileInput').onchange = function() {
            const file = this.files[0];
            const reader = new FileReader();
            const btn = document.getElementById('btnSubirDrive');
            const status = document.getElementById('upload-status');

            reader.onload = async function() {
                const base64 = reader.result.split(',')[1];
                const hoy = new Date().toISOString().split('T')[0];
                const nombreArchivo = `${itemActual}_${hoy}`;

                btn.innerText = "SUBIENDO...";
                btn.disabled = true;
                status.innerText = "Procesando imagen en Google Drive...";

                try {
                    const res = await fetch(scriptURL, { 
                        method: "POST", 
                        body: JSON.stringify({ itemName: nombreArchivo, imageB64: base64 }) 
                    });
                    const resData = await res.json();

                    if(resData.result === "success") {
                        alert("隆Imagen guardada en Drive correctamente!");
                        // Correcci贸n de la URL para visualizar la miniatura
                        document.getElementById('current-img').src = `https://lh3.googleusercontent.com/d/${resData.id}`;
                        status.innerText = "Archivo: " + nombreArchivo + ".jpg";

                        // Registro en el historial que se subi贸 una imagen
                        await addDoc(collection(db, "movimientos"), {
                            usuario: user.usuario,
                            accion: "Imagen Subida",
                            detalle: `Item: ${itemActual} (Versi贸n: ${hoy})`,
                            fecha: serverTimestamp()
                        });
                    }
                } catch(e) { 
                    alert("Error de conexi贸n con el Script de Google");
                    console.error(e);
                } finally { 
                    btn.innerText = " SUBIR/CAMBIAR FOTO"; 
                    btn.disabled = false; 
                }
            };
            reader.readAsDataURL(file);
        };

        // ACTUALIZAR FIRESTORE
        document.getElementById('btnUpdate').onclick = async () => {
            const newData = {};
            campos.forEach(c => newData[c] = document.getElementById(`upd-${c}`).value);
            
            try {
                await setDoc(doc(db, "productos", currentId), newData, { merge: true });
                
                await addDoc(collection(db, "movimientos"), {
                    usuario: user.usuario,
                    accion: "Actualizaci贸n",
                    detalle: `Item: ${itemActual}`,
                    statusMomento: newData["PPAP overall status"],
                    fecha: serverTimestamp()
                });

                alert("Registro actualizado con 茅xito");
                location.href = 'index.html';
            } catch(e) { 
                alert("Error al actualizar en Firebase"); 
            }
        };
    </script>
</body>
</html>