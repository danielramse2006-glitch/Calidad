 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update PPAP - Master Track</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .status-select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 14px;
            width: 100%;
            background: white;
            color: #333;
        }
        .status-approved { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-pending { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .status-rejected { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-inprogress { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .field-group {
            padding: 8px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .required-field::after {
            content: " *";
            color: #e74c3c;
        }
        #edit-form {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }
        #edit-form::-webkit-scrollbar {
            width: 8px;
        }
        #edit-form::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }
        #edit-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        /* Estilo para textareas en actualizar */
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .current-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
        .ppap-validation-ok {
            border-color: #27ae60 !important;
            background-color: #f0fff4 !important;
        }
        .ppap-validation-error {
            border-color: #e74c3c !important;
            background-color: #ffe6e6 !important;
        }
        .image-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .image-section-title {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .image-container {
            width: 100%;
            height: 200px;
            border: 2px dashed #3498db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            background: white;
            overflow: hidden;
        }
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .upload-status {
            font-size: 12px;
            min-height: 20px;
            margin-top: 10px;
            text-align: center;
        }
        .upload-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .btn-psw {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        .btn-pv {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }
        .file-info {
            font-size: 11px;
            color: #555;
            background: #f0f7ff;
            padding: 8px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .vc2-header {
            color: white;
            text-align: center;
            padding: 12px 0;
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 2px;
            margin: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .vc2-container {
            display: flex;
            justify-content: center;
            width: 100%;
            background: linear-gradient(to right, #003366, #0056a9);
        }
    </style>
</head>
<body class="bg-blue">
    <div class="corporate-header">
        <div class="company-logo" onclick="location.href='index.html'" style="cursor:pointer;">
            <div class="logo-container">
                <img src="logos/logo_smp.png" alt="SMP Engine Management Logo">
            </div>
            <div>
                <h1>PPAP Master Track System</h1>
                <div class="subtitle" style="color: white;">SMP Engine Management, S. de R.L. de C.V</div>
            </div>
        </div>
        
        <div class="user-header-info">
            <div id="current-user-display" class="user-name">üë§ Loading...</div>
            <div id="current-date" class="current-date"></div>
        </div>
    </div>

    <div class="vc2-container">
        <div class="vc2-header">
            VC2
        </div>
    </div>

    <header><h1>Update PPAP Record</h1></header>
    
    <div style="padding: 20px; max-width: 1200px; margin: auto;">
        <div style="background: white; border-radius: 10px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: grid; grid-template-columns: 1fr 400px; gap: 25px;">
            
            <div>
                <h2 style="margin-bottom: 25px; color: #2c3e50; display: flex; align-items: center; justify-content: space-between;">
                    <span>üìù Update Record</span>
                    <button onclick="location.href='index.html'" style="padding: 8px 15px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                        ‚Üê BACK
                    </button>
                </h2>
                
                <div style="margin-bottom: 25px; display: flex; gap: 10px; align-items: center;">
                    <div style="flex: 1; position: relative;">
                        <input type="text" id="searchItem" placeholder="Enter Item # to search..." style="width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #7f8c8d; font-size: 12px;">üîç</span>
                    </div>
                    <button id="btnBuscar" style="padding: 14px 25px; background: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap;">
                        SEARCH ITEM
                    </button>
                </div>

                <div id="current-info" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #3498db;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #2c3e50;">Item: <span id="current-item-display" style="font-weight: bold;"></span></h4>
                            <p style="margin: 0; font-size: 13px; color: #7f8c8d;">Current status: 
                                <span id="current-status-display" class="current-status status-pending">Loading...</span>
                            </p>
                        </div>
                        <div id="last-update" style="font-size: 11px; color: #95a5a6;"></div>
                    </div>
                </div>

                <div id="edit-form" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                    </div>

                <div id="action-buttons" style="display: none;">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <button id="btnUpdate" style="flex: 3; padding: 16px; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px;">
                            üíæ SAVE CHANGES
                        </button>
                        <button id="btnCancel" style="flex: 1; padding: 16px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            CANCEL
                        </button>
                    </div>
                </div>
            </div>

            <div style="border-left: 1px solid #eee; padding-left: 25px;">
                <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üñºÔ∏è Images</h3>
                
                <div class="image-section">
                    <div class="image-section-title">
                        <div style="background: #3498db; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            PSW
                        </div>
                        <h4 style="margin: 0;">Part Submission Warrant</h4>
                    </div>
                    
                    <div class="image-container">
                        <img id="current-img-psw" src="imagenes/sin_foto.jpg" alt="PSW Preview">
                    </div>
                    
                    <input type="file" id="fileInputPSW" accept="image/*" style="display: none;">
                    <button id="btnSubirPSW" class="upload-btn btn-psw">
                        üì∏ UPLOAD PSW PHOTO
                    </button>
                    
                    <div id="upload-status-psw" class="upload-status"></div>
                </div>
                
                <div class="image-section">
                    <div class="image-section-title">
                        <div style="background: #9b59b6; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            PV
                        </div>
                        <h4 style="margin: 0;">Process Validation</h4>
                    </div>
                    
                    <div class="image-container">
                        <img id="current-img-pv" src="imagenes/sin_foto.jpg" alt="PV Preview">
                    </div>
                    
                    <input type="file" id="fileInputPV" accept="image/*" style="display: none;">
                    <button id="btnSubirPV" class="upload-btn btn-pv">
                        üì∏ UPLOAD PV PHOTO
                    </button>
                    
                    <div id="upload-status-pv" class="upload-status"></div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: #3498db; font-size: 14px;">üìã Image Notes</h4>
                    <ul style="font-size: 11px; color: #555; margin: 0; padding-left: 15px;">
                        <li>PSW = Part Submission Warrant (Standard format)</li>
                        <li>PV = Process Validation (Validation format)</li>
                        <li>Both images will be saved with today's date</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="corporate-footer">
        <strong>SMP Engine Management, S. de R.L. de C.V</strong> | PPAP Master Track System v2.0<br>
        <span style="font-size: 11px;">¬© 2024 - All rights reserved</span>
    </div>

    <script type="module">
        import { db, checkAuth, redirectIfNoPermission } from './config.js';
        import { collection, query, where, getDocs, doc, setDoc, addDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Show current date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        
        // Show current user
        const user = checkAuth();
        if(user) {
            document.getElementById('current-user-display').textContent = `üë§ ${user.usuario}`;
        }

        // Verify update permission
        if (!redirectIfNoPermission('actualizar')) { }
        
        const scriptURL = "https://script.google.com/macros/s/AKfycbz-zqhnPq-ZCVv1miDE8lF6WkKfTrw4KMj2ikRm8ZYkncyOpSG0VAqEkbfbnThTIdmb/exec";

        let currentId = null;
        let itemActual = null;
        
        // DB FIELDS
        const camposDB = [
            "Item #",
            "PPAP Part Number",
            "Component description",
            "Reason for Change",
            "Product type",
            "PRP5/Area",
            "OE/AFTERMARKET",
            "documentation",
            "Samples received",
            "Location",
            "Dimensional",
            "Special instruccions",
            "Validation date",
            "Programmer",
            "Quality Lead",
            "Reason",
            "Comments(detalle)",
            "Responsible",
            "Estatus",
            "Revision",
            "PPAP type OE / SM\nAfter Market",
            "1 Design records",
            "2\nECN document",
            "3\nCustomer eng approval",
            "4\nDesign FMEA",
            "5\nProcess Flow Diagram",
            "6\nPFMEA",
            "7\nControl Plan",
            "8\nMSA Studies",
            "9\nDimensional results",
            "10\nMaterial, performance test result",
            "11\nInitial Process Studies",
            "12\nQualify Lab Documentation",
            "13\nAppereance Approval Report",
            "14\nSample product",
            "15\nChecking Aids",
            "16\nRecord of compliance",
            "17\nBulk material checklist",
            "18\nPSW\n(Full or Interim)",
            "Supplier PPAP package status",
            "Validation run readiness",
            "Samples on hand",
            "Dimension status",
            "FFF review status",
            "AAR review status",
            "PPAP overall status"
        ];

        const camposUI = camposDB.map(field => field.replace(/\n/g, " "));
        const importantFields = ["Item #", "Estatus", "PPAP overall status", "PPAP Part Number", "Revision"];

        function createSafeId(fieldName) {
            return fieldName.replace(/\n/g, "_").replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "");
        }

        window.validarPPAPPartNumber = function(input) {
            const valor = input.value.trim();
            const statusValues = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
            
            if (statusValues.includes(valor)) {
                input.classList.add("ppap-validation-error");
                input.classList.remove("ppap-validation-ok");
                input.title = "‚ö†Ô∏è PPAP Part Number should be a part number, not a status";
                return false;
            } else if (valor) {
                input.classList.add("ppap-validation-ok");
                input.classList.remove("ppap-validation-error");
                input.title = "‚úì Valid part number";
                return true;
            } else {
                input.classList.remove("ppap-validation-ok", "ppap-validation-error");
                input.title = "";
                return false;
            }
        };

        async function loadImages(itemNumber) {
            if (!itemNumber) return;
            
            const hoy = new Date().toISOString().split('T')[0];
            const nombreArchivoPSW = `${itemNumber}_${hoy}`;
            const nombreArchivoPV = `${itemNumber}-2-${hoy}`;
            
            // Load PSW
            try {
                const imgResponsePSW = await fetch(`${scriptURL}?itemName=${nombreArchivoPSW}`);
                const imgDataPSW = await imgResponsePSW.json();
                if(imgDataPSW.result === "success" && imgDataPSW.id) {
                    document.getElementById('current-img-psw').src = `https://lh3.googleusercontent.com/d/${imgDataPSW.id}`;
                    document.getElementById('upload-status-psw').innerHTML = `<span style="color:#27ae60;">‚úÖ PSW image found for today</span>`;
                } else {
                    document.getElementById('current-img-psw').src = "imagenes/sin_foto.jpg";
                    document.getElementById('upload-status-psw').innerHTML = `<span style="color:#7f8c8d;">No PSW image for today</span>`;
                }
            } catch (imgError) {
                document.getElementById('current-img-psw').src = "imagenes/sin_foto.jpg";
            }
            
            // Load PV
            try {
                const imgResponsePV = await fetch(`${scriptURL}?itemName=${nombreArchivoPV}`);
                const imgDataPV = await imgResponsePV.json();
                if(imgDataPV.result === "success" && imgDataPV.id) {
                    document.getElementById('current-img-pv').src = `https://lh3.googleusercontent.com/d/${imgDataPV.id}`;
                    document.getElementById('upload-status-pv').innerHTML = `<span style="color:#27ae60;">‚úÖ PV image found for today</span>`;
                } else {
                    document.getElementById('current-img-pv').src = "imagenes/sin_foto.jpg";
                    document.getElementById('upload-status-pv').innerHTML = `<span style="color:#7f8c8d;">No PV image for today</span>`;
                }
            } catch (imgError) {
                document.getElementById('current-img-pv').src = "imagenes/sin_foto.jpg";
            }
        }

        document.getElementById('btnBuscar').onclick = async () => {
            const val = document.getElementById('searchItem').value.trim();
            if(!val) {
                alert("Please enter an Item number");
                return;
            }

            const btnBuscar = document.getElementById('btnBuscar');
            btnBuscar.innerHTML = "üîç SEARCHING...";
            btnBuscar.disabled = true;

            try {
                const q = query(collection(db, "productos"), where("Item #", "==", val));
                const snap = await getDocs(q);

                if(snap.empty) {
                    alert("‚ùå Item not found.");
                    resetForm();
                    return;
                }

                const d = snap.docs[0];
                currentId = d.id;
                const data = d.data();
                itemActual = data["Item #"];

                document.getElementById('current-info').style.display = 'block';
                document.getElementById('current-item-display').textContent = itemActual;
                
                const currentStatus = data["PPAP overall status"] || "No status";
                const statusDisplay = document.getElementById('current-status-display');
                statusDisplay.textContent = currentStatus;
                
                statusDisplay.className = "current-status ";
                if (currentStatus.toLowerCase().includes("approved") || currentStatus.toLowerCase().includes("aprobado")) {
                    statusDisplay.classList.add("status-approved");
                } else if (currentStatus.toLowerCase().includes("pending") || currentStatus.toLowerCase().includes("pendiente")) {
                    statusDisplay.classList.add("status-pending");
                } else if (currentStatus.toLowerCase().includes("rejected") || currentStatus.toLowerCase().includes("rechazado")) {
                    statusDisplay.classList.add("status-rejected");
                } else {
                    statusDisplay.classList.add("status-inprogress");
                }

                const form = document.getElementById('edit-form');
                form.innerHTML = '';
                
                camposDB.forEach((campoDB, index) => {
                    const campoUI = camposUI[index];
                    const div = document.createElement('div');
                    div.className = importantFields.includes(campoDB) ? 'field-group' : '';
                    
                    const isRequired = importantFields.includes(campoDB);
                    const safeId = createSafeId(campoDB);
                    
                    if (campoDB === "PPAP overall status" || campoDB === "Estatus") {
                        const options = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
                        const currentValue = data[campoDB] || "";
                        
                        div.innerHTML = `
                            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;">
                                ${campoUI}${isRequired ? '<span style="color:#e74c3c;"> *</span>' : ''}
                            </label>
                            <select id="upd_${safeId}" class="status-select">
                                <option value="">Select status...</option>
                                ${options.map(opt => 
                                    `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        `;
                    } else if (campoDB === "Comments(detalle)" || campoDB === "Component description" || campoDB === "Reason") {
                        // USO DE TEXTAREA PARA CAMPOS LARGOS EN ACTUALIZAR
                        div.innerHTML = `
                            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;">
                                ${campoUI}${isRequired ? '<span style="color:#e74c3c;"> *</span>' : ''}
                            </label>
                            <textarea id="upd_${safeId}" rows="4">${data[campoDB] || ''}</textarea>
                        `;
                    } else if (campoDB === "PPAP Part Number") {
                        div.innerHTML = `
                            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;">
                                ${campoUI}${isRequired ? '<span style="color:#e74c3c;"> *</span>' : ''}
                            </label>
                            <input type="text" id="upd_${safeId}" value="${data[campoDB] || ''}" 
                                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;"
                                   onkeyup="validarPPAPPartNumber(this)">
                        `;
                    } else {
                        div.innerHTML = `
                            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;">
                                ${campoUI}${isRequired ? '<span style="color:#e74c3c;"> *</span>' : ''}
                            </label>
                            <input type="text" id="upd_${safeId}" value="${data[campoDB] || ''}" 
                                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;"
                                   ${campoDB === "Item #" ? 'readonly style="background:#f5f5f5;"' : ''}>
                        `;
                    }
                    
                    form.appendChild(div);
                });

                form.style.display = 'grid';
                document.getElementById('action-buttons').style.display = 'block';
                document.getElementById('btnSubirPSW').style.display = 'block';
                document.getElementById('btnSubirPV').style.display = 'block';

                const ppapInput = document.getElementById('upd_PPAP_Part_Number');
                if (ppapInput) validarPPAPPartNumber(ppapInput);

                await loadImages(itemActual);
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch(error) {
                console.error("Error searching:", error);
                alert("Error connecting to database.");
            } finally {
                btnBuscar.innerHTML = "SEARCH ITEM";
                btnBuscar.disabled = false;
            }
        };

        function resetForm() {
            document.getElementById('edit-form').innerHTML = '';
            document.getElementById('edit-form').style.display = 'none';
            document.getElementById('action-buttons').style.display = 'none';
            document.getElementById('current-info').style.display = 'none';
            document.getElementById('btnSubirPSW').style.display = 'none';
            document.getElementById('btnSubirPV').style.display = 'none';
            document.getElementById('current-img-psw').src = "imagenes/sin_foto.jpg";
            document.getElementById('current-img-pv').src = "imagenes/sin_foto.jpg";
            document.getElementById('upload-status-psw').textContent = '';
            document.getElementById('upload-status-pv').textContent = '';
            currentId = null;
            itemActual = null;
        }

        document.getElementById('btnCancel').onclick = resetForm;

        // DRIVE LOGIC
        document.getElementById('btnSubirPSW').onclick = () => {
            if (!itemActual) return alert("Search for an item first");
            document.getElementById('fileInputPSW').click();
        };
        document.getElementById('fileInputPSW').onchange = function() { uploadImage(this.files[0], 'PSW'); };

        document.getElementById('btnSubirPV').onclick = () => {
            if (!itemActual) return alert("Search for an item first");
            document.getElementById('fileInputPV').click();
        };
        document.getElementById('fileInputPV').onchange = function() { uploadImage(this.files[0], 'PV'); };

        async function uploadImage(file, imageType) {
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) return alert("Image too large (>10MB).");

            const reader = new FileReader();
            const hoy = new Date().toISOString().slice(0, 10);
            let nombreArchivo = imageType === 'PSW' ? `${itemActual}_${hoy}` : `${itemActual}-2-${hoy}`;
            let btnId = imageType === 'PSW' ? 'btnSubirPSW' : 'btnSubirPV';
            let statusId = imageType === 'PSW' ? 'upload-status-psw' : 'upload-status-pv';
            let imgId = imageType === 'PSW' ? 'current-img-psw' : 'current-img-pv';
            let actionType = imageType === 'PSW' ? 'PSW Image Updated' : 'PV Image Updated';

            reader.onload = async function() {
                const base64 = reader.result.split(',')[1];
                const btn = document.getElementById(btnId);
                const status = document.getElementById(statusId);

                btn.innerHTML = "‚è≥ UPLOADING...";
                btn.disabled = true;

                try {
                    const res = await fetch(scriptURL, { 
                        method: "POST", 
                        body: JSON.stringify({ itemName: nombreArchivo, imageB64: base64 }) 
                    });
                    const resData = await res.json();

                    if(resData.result === "success") {
                        document.getElementById(imgId).src = `https://lh3.googleusercontent.com/d/${resData.id}`;
                        status.innerHTML = `<span style="color:#27ae60;">‚úÖ ${imageType} uploaded</span>`;
                        
                        // NOTA: Se mantiene el historial de subida de im√°genes, solo se quit√≥ el de "Update" principal
                        await addDoc(collection(db, "movimientos"), {
                            usuario: user.usuario,
                            accion: actionType,
                            detalle: `Item: ${itemActual} (${imageType})`,
                            fecha: serverTimestamp()
                        });

                        alert(`‚úÖ ${imageType} image saved correctly`);
                    } else throw new Error("Server error");
                } catch(e) { 
                    alert(`Error uploading ${imageType}.`);
                } finally { 
                    btn.innerHTML = `üì∏ UPLOAD ${imageType} PHOTO`; 
                    btn.disabled = false; 
                }
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('btnUpdate').onclick = async () => {
            if (!currentId) return alert("Search for a record first");

            const ppapPartNumberInput = document.getElementById('upd_PPAP_Part_Number');
            if (ppapPartNumberInput) {
                const ppapValue = ppapPartNumberInput.value.trim();
                const statusValues = ["Pending", "In Process", "Approved", "Rejected", "Completed", "On Hold"];
                if (statusValues.includes(ppapValue)) {
                    alert("‚ùå 'PPAP Part Number' must be a number, not a status.");
                    return;
                }
            }

            if (!confirm("Are you sure you want to update this record?")) return;

            const newData = {};
            camposDB.forEach(c => {
                const safeId = createSafeId(c);
                const element = document.getElementById(`upd_${safeId}`);
                if (element) {
                    newData[c] = element.tagName === 'SELECT' ? element.value : element.value.trim();
                }
            });

            const btnUpdate = document.getElementById('btnUpdate');
            btnUpdate.innerHTML = "‚è≥ SAVING...";
            btnUpdate.disabled = true;

            try {
                await setDoc(doc(db, "productos", currentId), newData, { merge: true });
                
                // NOTA: Se elimin√≥ el registro en la colecci√≥n "movimientos" como solicitaste
                
                alert("‚úÖ Record updated successfully");
                location.href = 'index.html';
            } catch(e) { 
                console.error("Error updating:", e);
                alert("‚ùå Error updating database"); 
            } finally {
                btnUpdate.innerHTML = "üíæ SAVE CHANGES";
                btnUpdate.disabled = false;
            }
        };

        document.getElementById('searchItem').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') document.getElementById('btnBuscar').click();
        });

        window.addEventListener('load', function() {
            document.getElementById('searchItem').focus();
        });
    </script>
</body>
</html>